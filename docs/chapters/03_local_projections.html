<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Local Projections – Mastering Empirical Macroeconometrics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/04_var_svar.html" rel="next">
<link href="../chapters/02_identification.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-f555ed0e695c0487cf72966c0b30f9ff.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-ec3f846469679b9e6f6b146d88a0bba5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/03_local_projections.html">Phase 2: Dynamic Methods</a></li><li class="breadcrumb-item"><a href="../chapters/03_local_projections.html"><span class="chapter-title">Local Projections</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Mastering Empirical Macroeconometrics</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Mastering Empirical Macroeconometrics</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 1: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01_panel_econometrics.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Panel Data Econometrics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02_identification.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Identification in Macroeconomics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 2: Dynamic Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03_local_projections.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">Local Projections</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04_var_svar.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Vector Autoregressions</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 3: Treatment Effects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05_staggered_did.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Staggered Difference-in-Differences</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06_synthetic_control.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Synthetic Control Methods</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 4: Bayesian Econometrics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07_bayesian_foundations.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Bayesian Foundations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08_bayesian_var.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Bayesian Vector Autoregressions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09_bayesian_panel.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Bayesian Panel Methods</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 5: Structural Macro</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/10_dsge_foundations.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">DSGE Foundations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/11_dsge_estimation.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">DSGE Estimation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 6: Causal Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/12_regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Regularization for Macro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/13_causal_ml.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Causal Machine Learning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-local-projections-idea" id="toc-the-local-projections-idea" class="nav-link active" data-scroll-target="#the-local-projections-idea">The Local Projections Idea</a>
  <ul class="collapse">
  <li><a href="#from-var-to-lp" id="toc-from-var-to-lp" class="nav-link" data-scroll-target="#from-var-to-lp">From VAR to LP</a>
  <ul class="collapse">
  <li><a href="#the-var-approach" id="toc-the-var-approach" class="nav-link" data-scroll-target="#the-var-approach">The VAR Approach</a></li>
  <li><a href="#the-lp-approach" id="toc-the-lp-approach" class="nav-link" data-scroll-target="#the-lp-approach">The LP Approach</a></li>
  </ul></li>
  <li><a href="#when-lp-and-var-give-the-same-answer" id="toc-when-lp-and-var-give-the-same-answer" class="nav-link" data-scroll-target="#when-lp-and-var-give-the-same-answer">When LP and VAR Give the Same Answer</a></li>
  <li><a href="#when-they-diverge" id="toc-when-they-diverge" class="nav-link" data-scroll-target="#when-they-diverge">When They Diverge</a></li>
  </ul></li>
  <li><a href="#basic-lp-estimation" id="toc-basic-lp-estimation" class="nav-link" data-scroll-target="#basic-lp-estimation">Basic LP Estimation</a>
  <ul class="collapse">
  <li><a href="#the-specification" id="toc-the-specification" class="nav-link" data-scroll-target="#the-specification">The Specification</a></li>
  <li><a href="#implementation-with-fixest" id="toc-implementation-with-fixest" class="nav-link" data-scroll-target="#implementation-with-fixest">Implementation with fixest</a></li>
  <li><a href="#inference-why-hacclustering-matters" id="toc-inference-why-hacclustering-matters" class="nav-link" data-scroll-target="#inference-why-hacclustering-matters">Inference: Why HAC/Clustering Matters</a></li>
  </ul></li>
  <li><a href="#state-dependent-local-projections" id="toc-state-dependent-local-projections" class="nav-link" data-scroll-target="#state-dependent-local-projections">State-Dependent Local Projections</a>
  <ul class="collapse">
  <li><a href="#binary-state-switching" id="toc-binary-state-switching" class="nav-link" data-scroll-target="#binary-state-switching">Binary State Switching</a></li>
  <li><a href="#smooth-transition-auerbach-gorodnichenko" id="toc-smooth-transition-auerbach-gorodnichenko" class="nav-link" data-scroll-target="#smooth-transition-auerbach-gorodnichenko">Smooth Transition (Auerbach-Gorodnichenko)</a></li>
  <li><a href="#testing-for-state-dependence" id="toc-testing-for-state-dependence" class="nav-link" data-scroll-target="#testing-for-state-dependence">Testing for State Dependence</a></li>
  </ul></li>
  <li><a href="#lp-did-combining-lp-with-difference-in-differences" id="toc-lp-did-combining-lp-with-difference-in-differences" class="nav-link" data-scroll-target="#lp-did-combining-lp-with-difference-in-differences">LP-DiD: Combining LP with Difference-in-Differences</a>
  <ul class="collapse">
  <li><a href="#the-setting" id="toc-the-setting" class="nav-link" data-scroll-target="#the-setting">The Setting</a></li>
  <li><a href="#the-specification-1" id="toc-the-specification-1" class="nav-link" data-scroll-target="#the-specification-1">The Specification</a></li>
  <li><a href="#lp-did-vs.-standard-event-study" id="toc-lp-did-vs.-standard-event-study" class="nav-link" data-scroll-target="#lp-did-vs.-standard-event-study">LP-DiD vs.&nbsp;Standard Event Study</a></li>
  </ul></li>
  <li><a href="#diagnostics-and-practical-issues" id="toc-diagnostics-and-practical-issues" class="nav-link" data-scroll-target="#diagnostics-and-practical-issues">Diagnostics and Practical Issues</a>
  <ul class="collapse">
  <li><a href="#sample-erosion-at-long-horizons" id="toc-sample-erosion-at-long-horizons" class="nav-link" data-scroll-target="#sample-erosion-at-long-horizons">Sample Erosion at Long Horizons</a></li>
  <li><a href="#lag-selection" id="toc-lag-selection" class="nav-link" data-scroll-target="#lag-selection">Lag Selection</a></li>
  <li><a href="#cumulative-vs.-non-cumulative" id="toc-cumulative-vs.-non-cumulative" class="nav-link" data-scroll-target="#cumulative-vs.-non-cumulative">Cumulative vs.&nbsp;Non-Cumulative</a></li>
  <li><a href="#comparing-lp-and-var-irfs" id="toc-comparing-lp-and-var-irfs" class="nav-link" data-scroll-target="#comparing-lp-and-var-irfs">Comparing LP and VAR IRFs</a></li>
  </ul></li>
  <li><a href="#frequently-asked-questions" id="toc-frequently-asked-questions" class="nav-link" data-scroll-target="#frequently-asked-questions">Frequently Asked Questions</a>
  <ul class="collapse">
  <li><a href="#when-should-i-use-lp-vs.-var" id="toc-when-should-i-use-lp-vs.-var" class="nav-link" data-scroll-target="#when-should-i-use-lp-vs.-var">When should I use LP vs.&nbsp;VAR?</a></li>
  <li><a href="#how-do-i-choose-the-horizon-h" id="toc-how-do-i-choose-the-horizon-h" class="nav-link" data-scroll-target="#how-do-i-choose-the-horizon-h">How do I choose the horizon H?</a></li>
  <li><a href="#what-controls-should-i-include" id="toc-what-controls-should-i-include" class="nav-link" data-scroll-target="#what-controls-should-i-include">What controls should I include?</a></li>
  <li><a href="#how-do-i-report-results" id="toc-how-do-i-report-results" class="nav-link" data-scroll-target="#how-do-i-report-results">How do I report results?</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum/edit/main/chapters/03_local_projections.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/03_local_projections.html">Phase 2: Dynamic Methods</a></li><li class="breadcrumb-item"><a href="../chapters/03_local_projections.html"><span class="chapter-title">Local Projections</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-title">Local Projections</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Flexible Impulse Response Estimation</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="the-local-projections-idea" class="level1 unnumbered">
<h1 class="unnumbered">The Local Projections Idea</h1>
<p>Local Projections (LP), introduced by <span class="citation" data-cites="jorda2005">Jordà (<a href="../references.html#ref-jorda2005" role="doc-biblioref">2005</a>)</span>, provide a flexible alternative to Vector Autoregressions for estimating impulse response functions. The key insight: instead of specifying and iterating a full dynamic system, directly regress the outcome <span class="math inline">\(h\)</span> periods ahead on today’s shock.</p>
<section id="from-var-to-lp" class="level2">
<h2 class="anchored" data-anchor-id="from-var-to-lp">From VAR to LP</h2>
<section id="the-var-approach" class="level3">
<h3 class="anchored" data-anchor-id="the-var-approach">The VAR Approach</h3>
<p>A VAR(p) models the joint dynamics of a vector <span class="math inline">\(\mathbf{y}_t\)</span>:</p>
<p><span class="math display">\[
\mathbf{y}_t = \mathbf{c} + \mathbf{A}_1 \mathbf{y}_{t-1} + \cdots + \mathbf{A}_p \mathbf{y}_{t-p} + \mathbf{u}_t
\]</span></p>
<p>To get impulse responses, we: 1. Identify structural shocks (Cholesky, sign restrictions, etc.) 2. Iterate the system forward to compute <span class="math inline">\(\frac{\partial \mathbf{y}_{t+h}}{\partial \varepsilon_t}\)</span></p>
<p>This requires <strong>correct specification of the entire system</strong>.</p>
</section>
<section id="the-lp-approach" class="level3">
<h3 class="anchored" data-anchor-id="the-lp-approach">The LP Approach</h3>
<p>LP estimates the response at each horizon <span class="math inline">\(h\)</span> directly:</p>
<p><span class="math display">\[
y_{t+h} = \alpha^h + \beta^h \cdot \text{shock}_t + \mathbf{X}_t' \boldsymbol{\gamma}^h + \varepsilon_{t+h}
\]</span></p>
<p>where: - <span class="math inline">\(\beta^h\)</span> is the impulse response at horizon <span class="math inline">\(h\)</span> - <span class="math inline">\(\mathbf{X}_t\)</span> contains controls (lags of <span class="math inline">\(y\)</span>, other variables) - Each horizon is a <strong>separate regression</strong></p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Key Insight
</div>
</div>
<div class="callout-body-container callout-body">
<p>LP doesn’t require specifying the full dynamic system. We only need to identify the shock of interest—the rest of the economy can be a “black box.”</p>
</div>
</div>
</section>
</section>
<section id="when-lp-and-var-give-the-same-answer" class="level2">
<h2 class="anchored" data-anchor-id="when-lp-and-var-give-the-same-answer">When LP and VAR Give the Same Answer</h2>
<p><strong>Theorem (Plagborg-Møller &amp; Wolf, 2021):</strong> Under correct specification, LP and VAR estimate the same population impulse responses.</p>
<p>Both methods are consistent for: <span class="math display">\[
\text{IRF}(h) = \frac{\partial \mathbb{E}[y_{t+h} | \mathcal{I}_t]}{\partial \text{shock}_t}
\]</span></p>
<p>The difference is in <strong>finite samples</strong> and <strong>misspecification</strong>:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 44%">
<col style="width: 27%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th>Aspect</th>
<th>VAR</th>
<th>LP</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Specification</td>
<td>Imposes structure</td>
<td>Agnostic at each horizon</td>
</tr>
<tr class="even">
<td>Efficiency</td>
<td>More efficient if correct</td>
<td>Less efficient (more parameters)</td>
</tr>
<tr class="odd">
<td>Misspecification</td>
<td>Biased if wrong</td>
<td>Robust</td>
</tr>
<tr class="even">
<td>Confidence intervals</td>
<td>Tighter</td>
<td>Wider (but honest)</td>
</tr>
</tbody>
</table>
</section>
<section id="when-they-diverge" class="level2">
<h2 class="anchored" data-anchor-id="when-they-diverge">When They Diverge</h2>
<p>LP and VAR can give different answers when:</p>
<ol type="1">
<li><strong>VAR is misspecified</strong>: Wrong lag length, omitted variables, nonlinearities</li>
<li><strong>Small samples</strong>: LP’s horizon-by-horizon estimation is noisier</li>
<li><strong>Long horizons</strong>: VAR extrapolates; LP estimates directly (sample shrinks)</li>
</ol>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Simulate a simple AR(1) process</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>T <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb1-5"><a href="#cb1-5"></a>shock <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">rep</span>(<span class="dv">0</span>, T<span class="dv">-1</span>))  <span class="co"># Unit impulse at t=1</span></span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>T) {</span>
<span id="cb1-8"><a href="#cb1-8"></a>  y[t] <span class="ot">&lt;-</span> rho <span class="sc">*</span> y[t<span class="dv">-1</span>] <span class="sc">+</span> shock[t]</span>
<span id="cb1-9"><a href="#cb1-9"></a>}</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co"># True IRF: rho^h</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>H <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>true_irf <span class="ot">&lt;-</span> rho<span class="sc">^</span>(<span class="dv">0</span><span class="sc">:</span>H)</span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="co"># LP estimation</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>lp_irf <span class="ot">&lt;-</span> <span class="fu">numeric</span>(H <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-17"><a href="#cb1-17"></a>lp_se <span class="ot">&lt;-</span> <span class="fu">numeric</span>(H <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H) {</span>
<span id="cb1-20"><a href="#cb1-20"></a>  <span class="co"># Create lead of y</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>  y_lead <span class="ot">&lt;-</span> <span class="fu">c</span>(y[(h<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T], <span class="fu">rep</span>(<span class="cn">NA</span>, h))</span>
<span id="cb1-22"><a href="#cb1-22"></a>  y_lag <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, y[<span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)])</span>
<span id="cb1-23"><a href="#cb1-23"></a></span>
<span id="cb1-24"><a href="#cb1-24"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y_lead =</span> y_lead, <span class="at">shock =</span> shock, <span class="at">y_lag =</span> y_lag) <span class="sc">%&gt;%</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(y_lead) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_lag))</span>
<span id="cb1-26"><a href="#cb1-26"></a></span>
<span id="cb1-27"><a href="#cb1-27"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_lead <span class="sc">~</span> shock <span class="sc">+</span> y_lag, <span class="at">data =</span> df)</span>
<span id="cb1-28"><a href="#cb1-28"></a>  lp_irf[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)[<span class="st">"shock"</span>]</span>
<span id="cb1-29"><a href="#cb1-29"></a>  lp_se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(fit)))[<span class="st">"shock"</span>]</span>
<span id="cb1-30"><a href="#cb1-30"></a>}</span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co"># VAR estimation (just AR(1) here)</span></span>
<span id="cb1-33"><a href="#cb1-33"></a>var_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y[<span class="dv">2</span><span class="sc">:</span>T] <span class="sc">~</span> y[<span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)])</span>
<span id="cb1-34"><a href="#cb1-34"></a>rho_hat <span class="ot">&lt;-</span> <span class="fu">coef</span>(var_fit)[<span class="dv">2</span>]</span>
<span id="cb1-35"><a href="#cb1-35"></a>var_irf <span class="ot">&lt;-</span> rho_hat<span class="sc">^</span>(<span class="dv">0</span><span class="sc">:</span>H)</span>
<span id="cb1-36"><a href="#cb1-36"></a></span>
<span id="cb1-37"><a href="#cb1-37"></a><span class="co"># Plot comparison</span></span>
<span id="cb1-38"><a href="#cb1-38"></a>irf_compare <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb1-39"><a href="#cb1-39"></a>  <span class="at">horizon =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>H, <span class="dv">3</span>),</span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="at">irf =</span> <span class="fu">c</span>(true_irf, lp_irf, var_irf),</span>
<span id="cb1-41"><a href="#cb1-41"></a>  <span class="at">method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"True"</span>, <span class="st">"LP"</span>, <span class="st">"VAR"</span>), <span class="at">each =</span> H <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb1-42"><a href="#cb1-42"></a>)</span>
<span id="cb1-43"><a href="#cb1-43"></a></span>
<span id="cb1-44"><a href="#cb1-44"></a><span class="fu">ggplot</span>(irf_compare, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> irf, <span class="at">color =</span> method, <span class="at">linetype =</span> method)) <span class="sc">+</span></span>
<span id="cb1-45"><a href="#cb1-45"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb1-47"><a href="#cb1-47"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"True"</span> <span class="ot">=</span> <span class="st">"black"</span>, <span class="st">"LP"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>, <span class="st">"VAR"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>)) <span class="sc">+</span></span>
<span id="cb1-48"><a href="#cb1-48"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"True"</span> <span class="ot">=</span> <span class="st">"solid"</span>, <span class="st">"LP"</span> <span class="ot">=</span> <span class="st">"dashed"</span>, <span class="st">"VAR"</span> <span class="ot">=</span> <span class="st">"dotted"</span>)) <span class="sc">+</span></span>
<span id="cb1-49"><a href="#cb1-49"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LP vs VAR: Impulse Response Comparison"</span>,</span>
<span id="cb1-50"><a href="#cb1-50"></a>       <span class="at">subtitle =</span> <span class="st">"Both recover the true IRF from an AR(1) DGP"</span>,</span>
<span id="cb1-51"><a href="#cb1-51"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Response to Unit Shock"</span>,</span>
<span id="cb1-52"><a href="#cb1-52"></a>       <span class="at">color =</span> <span class="st">"Method"</span>, <span class="at">linetype =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb1-53"><a href="#cb1-53"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/lp-vs-var-simulation-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>LP vs VAR: Both recover true IRF from correctly specified DGP</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="basic-lp-estimation" class="level1 unnumbered">
<h1 class="unnumbered">Basic LP Estimation</h1>
<section id="the-specification" class="level2">
<h2 class="anchored" data-anchor-id="the-specification">The Specification</h2>
<p>For a panel of countries observed over time:</p>
<p><span class="math display">\[
y_{i,t+h} - y_{i,t-1} = \alpha_i^h + \delta_t^h + \beta^h \cdot \text{shock}_{it} + \mathbf{X}_{it}'\boldsymbol{\gamma}^h + \varepsilon_{i,t+h}
\]</span></p>
<p><strong>Left-hand side:</strong> Cumulative change from <span class="math inline">\(t-1\)</span> to <span class="math inline">\(t+h\)</span>. This gives the <strong>cumulative multiplier</strong>—how much <span class="math inline">\(y\)</span> has changed in total by horizon <span class="math inline">\(h\)</span>.</p>
<p><strong>Right-hand side:</strong> - <span class="math inline">\(\alpha_i^h\)</span>: Country fixed effects (absorb level differences) - <span class="math inline">\(\delta_t^h\)</span>: Time fixed effects (absorb common shocks) - <span class="math inline">\(\text{shock}_{it}\)</span>: The impulse of interest - <span class="math inline">\(\mathbf{X}_{it}\)</span>: Controls (lags of <span class="math inline">\(y\)</span>, other variables)</p>
</section>
<section id="implementation-with-fixest" class="level2">
<h2 class="anchored" data-anchor-id="implementation-with-fixest">Implementation with fixest</h2>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Generate synthetic panel data</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>N <span class="ot">&lt;-</span> <span class="dv">30</span>  <span class="co"># countries</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>T_obs <span class="ot">&lt;-</span> <span class="dv">60</span>  <span class="co"># quarters</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co"># Country fixed effects</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>country_fe <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># Generate panel</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>panel_data <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="at">country =</span> <span class="dv">1</span><span class="sc">:</span>N,</span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_obs</span>
<span id="cb2-12"><a href="#cb2-12"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="fu">arrange</span>(country, time) <span class="sc">%&gt;%</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="co"># Country effect</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>    <span class="at">alpha =</span> country_fe[country],</span>
<span id="cb2-17"><a href="#cb2-17"></a>    <span class="co"># Time trend + cycle</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="at">time_effect =</span> <span class="fl">0.02</span> <span class="sc">*</span> time <span class="sc">+</span> <span class="fu">sin</span>(time <span class="sc">/</span> <span class="dv">4</span>) <span class="sc">*</span> <span class="fl">0.5</span>,</span>
<span id="cb2-19"><a href="#cb2-19"></a>    <span class="co"># Shock (e.g., inflation surprise)</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>    <span class="at">shock =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-21"><a href="#cb2-21"></a>    <span class="co"># Autoregressive outcome with shock response</span></span>
<span id="cb2-22"><a href="#cb2-22"></a>    <span class="at">y =</span> <span class="cn">NA_real_</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>  )</span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co"># Generate AR process with shock impact</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb2-27"><a href="#cb2-27"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(panel_data<span class="sc">$</span>country <span class="sc">==</span> i)</span>
<span id="cb2-28"><a href="#cb2-28"></a>  y_country <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T_obs)</span>
<span id="cb2-29"><a href="#cb2-29"></a></span>
<span id="cb2-30"><a href="#cb2-30"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>T_obs) {</span>
<span id="cb2-31"><a href="#cb2-31"></a>    <span class="co"># True DGP: y responds to shock with persistence</span></span>
<span id="cb2-32"><a href="#cb2-32"></a>    y_country[t] <span class="ot">&lt;-</span> <span class="fl">0.7</span> <span class="sc">*</span> y_country[t<span class="dv">-1</span>] <span class="sc">+</span></span>
<span id="cb2-33"><a href="#cb2-33"></a>                    <span class="fl">0.5</span> <span class="sc">*</span> panel_data<span class="sc">$</span>shock[idx[t]] <span class="sc">+</span>  <span class="co"># Immediate impact</span></span>
<span id="cb2-34"><a href="#cb2-34"></a>                    <span class="fl">0.3</span> <span class="sc">*</span> panel_data<span class="sc">$</span>shock[idx[t<span class="dv">-1</span>]] <span class="sc">+</span> <span class="co"># Delayed impact</span></span>
<span id="cb2-35"><a href="#cb2-35"></a>                    country_fe[i] <span class="sc">*</span> <span class="fl">0.1</span> <span class="sc">+</span></span>
<span id="cb2-36"><a href="#cb2-36"></a>                    <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb2-37"><a href="#cb2-37"></a>  }</span>
<span id="cb2-38"><a href="#cb2-38"></a>  panel_data<span class="sc">$</span>y[idx] <span class="ot">&lt;-</span> y_country</span>
<span id="cb2-39"><a href="#cb2-39"></a>}</span>
<span id="cb2-40"><a href="#cb2-40"></a></span>
<span id="cb2-41"><a href="#cb2-41"></a><span class="co"># Convert to panel</span></span>
<span id="cb2-42"><a href="#cb2-42"></a>pdata <span class="ot">&lt;-</span> <span class="fu">panel</span>(panel_data, <span class="sc">~</span>country <span class="sc">+</span> time)</span>
<span id="cb2-43"><a href="#cb2-43"></a></span>
<span id="cb2-44"><a href="#cb2-44"></a><span class="fu">cat</span>(<span class="st">"Panel dimensions:"</span>, N, <span class="st">"countries,"</span>, T_obs, <span class="st">"periods</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Panel dimensions: 30 countries, 60 periods</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Estimate LP at each horizon</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>H <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="at">horizon =</span> <span class="dv">0</span><span class="sc">:</span>H,</span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="at">se =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb4-7"><a href="#cb4-7"></a>  <span class="at">ci_low =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="at">ci_high =</span> <span class="cn">NA_real_</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>)</span>
<span id="cb4-10"><a href="#cb4-10"></a></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H) {</span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="co"># LP regression: y_{t+h} - y_{t-1} on shock_t</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>  model <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb4-14"><a href="#cb4-14"></a>    <span class="fu">f</span>(y, h) <span class="sc">-</span> <span class="fu">l</span>(y, <span class="dv">1</span>) <span class="sc">~</span> shock <span class="sc">+</span> <span class="fu">l</span>(y, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">|</span> country <span class="sc">+</span> time,</span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="at">data =</span> pdata,</span>
<span id="cb4-16"><a href="#cb4-16"></a>    <span class="at">vcov =</span> <span class="sc">~</span>country  <span class="co"># Cluster by country</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>  )</span>
<span id="cb4-18"><a href="#cb4-18"></a></span>
<span id="cb4-19"><a href="#cb4-19"></a>  results<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model)[<span class="st">"shock"</span>]</span>
<span id="cb4-20"><a href="#cb4-20"></a>  results<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">se</span>(model)[<span class="st">"shock"</span>]</span>
<span id="cb4-21"><a href="#cb4-21"></a>  results<span class="sc">$</span>ci_low[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> results<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> results<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb4-22"><a href="#cb4-22"></a>  results<span class="sc">$</span>ci_high[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> results<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> results<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb4-23"><a href="#cb4-23"></a>}</span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co"># Plot IRF</span></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_low, <span class="at">ymax =</span> ci_high), <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"#3498db"</span>) <span class="sc">+</span></span>
<span id="cb4-29"><a href="#cb4-29"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb4-30"><a href="#cb4-30"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Local Projection: Response to Unit Shock"</span>,</span>
<span id="cb4-32"><a href="#cb4-32"></a>       <span class="at">subtitle =</span> <span class="st">"Cumulative response with 95% confidence bands (clustered by country)"</span>,</span>
<span id="cb4-33"><a href="#cb4-33"></a>       <span class="at">x =</span> <span class="st">"Horizon (periods)"</span>,</span>
<span id="cb4-34"><a href="#cb4-34"></a>       <span class="at">y =</span> <span class="st">"Cumulative Response"</span>) <span class="sc">+</span></span>
<span id="cb4-35"><a href="#cb4-35"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span>H)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/lp-estimation-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Local Projection impulse responses with 95% confidence bands</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="inference-why-hacclustering-matters" class="level2">
<h2 class="anchored" data-anchor-id="inference-why-hacclustering-matters">Inference: Why HAC/Clustering Matters</h2>
<p>At horizon <span class="math inline">\(h\)</span>, the LP residual <span class="math inline">\(\varepsilon_{i,t+h}\)</span> is correlated with <span class="math inline">\(\varepsilon_{i,t+h-1}, \ldots, \varepsilon_{i,t+1}\)</span> by construction (overlapping observations).</p>
<p><strong>This induces MA(h-1) serial correlation in errors.</strong></p>
<p>Standard OLS standard errors are <strong>invalid</strong>. Must use:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 20%">
<col style="width: 53%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>When</th>
<th>Implementation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Newey-West HAC</td>
<td>Time series</td>
<td><code>sandwich::NeweyWest(lags = h)</code></td>
</tr>
<tr class="even">
<td>Cluster by unit</td>
<td>Panel, short T</td>
<td><code>vcov = ~country</code></td>
</tr>
<tr class="odd">
<td>Driscoll-Kraay</td>
<td>Panel, cross-sectional dependence</td>
<td><code>vcov = "DK"</code> in some packages</td>
</tr>
</tbody>
</table>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Compare SE across horizons</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>se_by_horizon <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="at">horizon =</span> <span class="dv">0</span><span class="sc">:</span>H,</span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="at">cluster_se =</span> results<span class="sc">$</span>se,</span>
<span id="cb5-5"><a href="#cb5-5"></a>  <span class="co"># For comparison, also compute OLS SE (wrong!)</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="at">ols_se =</span> <span class="cn">NA_real_</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>)</span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H) {</span>
<span id="cb5-10"><a href="#cb5-10"></a>  model_ols <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb5-11"><a href="#cb5-11"></a>    <span class="fu">f</span>(y, h) <span class="sc">-</span> <span class="fu">l</span>(y, <span class="dv">1</span>) <span class="sc">~</span> shock <span class="sc">+</span> <span class="fu">l</span>(y, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">|</span> country <span class="sc">+</span> time,</span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="at">data =</span> pdata,</span>
<span id="cb5-13"><a href="#cb5-13"></a>    <span class="at">vcov =</span> <span class="st">"iid"</span>  <span class="co"># Wrong but instructive</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>  )</span>
<span id="cb5-15"><a href="#cb5-15"></a>  se_by_horizon<span class="sc">$</span>ols_se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_ols)[<span class="st">"shock"</span>]</span>
<span id="cb5-16"><a href="#cb5-16"></a>}</span>
<span id="cb5-17"><a href="#cb5-17"></a></span>
<span id="cb5-18"><a href="#cb5-18"></a>se_long <span class="ot">&lt;-</span> se_by_horizon <span class="sc">%&gt;%</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(cluster_se, ols_se),</span>
<span id="cb5-20"><a href="#cb5-20"></a>               <span class="at">names_to =</span> <span class="st">"method"</span>, <span class="at">values_to =</span> <span class="st">"se"</span>)</span>
<span id="cb5-21"><a href="#cb5-21"></a></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="fu">ggplot</span>(se_long, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> se, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb5-24"><a href="#cb5-24"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"cluster_se"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, <span class="st">"ols_se"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb5-26"><a href="#cb5-26"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Clustered (correct)"</span>, <span class="st">"IID (wrong)"</span>)) <span class="sc">+</span></span>
<span id="cb5-27"><a href="#cb5-27"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Standard Errors by Horizon"</span>,</span>
<span id="cb5-28"><a href="#cb5-28"></a>       <span class="at">subtitle =</span> <span class="st">"Clustered SEs account for serial correlation; IID SEs are too small"</span>,</span>
<span id="cb5-29"><a href="#cb5-29"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Standard Error"</span>,</span>
<span id="cb5-30"><a href="#cb5-30"></a>       <span class="at">color =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb5-31"><a href="#cb5-31"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/se-comparison-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Standard errors grow with horizon due to overlapping residuals</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="state-dependent-local-projections" class="level1 unnumbered">
<h1 class="unnumbered">State-Dependent Local Projections</h1>
<p>A major advantage of LP over VAR: it’s easy to allow impulse responses to vary with the state of the economy.</p>
<section id="binary-state-switching" class="level2">
<h2 class="anchored" data-anchor-id="binary-state-switching">Binary State Switching</h2>
<p>The simplest approach: interact the shock with a state indicator.</p>
<p><span class="math display">\[
y_{i,t+h} - y_{i,t-1} = \alpha_i^h + \beta_0^h \cdot (1 - S_{it}) \cdot \text{shock}_{it} + \beta_1^h \cdot S_{it} \cdot \text{shock}_{it} + \cdots
\]</span></p>
<p>where <span class="math inline">\(S_{it} = 1\)</span> if country <span class="math inline">\(i\)</span> is in “state 1” at time <span class="math inline">\(t\)</span>.</p>
<p><strong>Examples of state variables:</strong> - Recession vs.&nbsp;expansion - High vs.&nbsp;low debt - Financial crisis vs.&nbsp;normal times - High vs.&nbsp;low bank holdings of sovereign debt</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Add state variable: high vs low initial shock exposure</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>panel_data <span class="ot">&lt;-</span> panel_data <span class="sc">%&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="fu">group_by</span>(country) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="co"># State based on lagged cumulative shock exposure</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="at">cum_shock =</span> <span class="fu">cumsum</span>(shock),</span>
<span id="cb6-7"><a href="#cb6-7"></a>    <span class="at">high_state =</span> <span class="fu">as.integer</span>(<span class="fu">lag</span>(cum_shock, <span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fu">median</span>(<span class="fu">lag</span>(cum_shock, <span class="dv">1</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb6-8"><a href="#cb6-8"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="fu">mutate</span>(<span class="at">high_state =</span> <span class="fu">replace_na</span>(high_state, <span class="dv">0</span>))</span>
<span id="cb6-11"><a href="#cb6-11"></a></span>
<span id="cb6-12"><a href="#cb6-12"></a>pdata <span class="ot">&lt;-</span> <span class="fu">panel</span>(panel_data, <span class="sc">~</span>country <span class="sc">+</span> time)</span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co"># Estimate state-dependent LP</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>results_state <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-16"><a href="#cb6-16"></a>  <span class="at">horizon =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>H, <span class="dv">2</span>),</span>
<span id="cb6-17"><a href="#cb6-17"></a>  <span class="at">state =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"High"</span>), <span class="at">each =</span> H <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb6-18"><a href="#cb6-18"></a>  <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb6-19"><a href="#cb6-19"></a>  <span class="at">se =</span> <span class="cn">NA_real_</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>)</span>
<span id="cb6-21"><a href="#cb6-21"></a></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H) {</span>
<span id="cb6-23"><a href="#cb6-23"></a>  model_state <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb6-24"><a href="#cb6-24"></a>    <span class="fu">f</span>(y, h) <span class="sc">-</span> <span class="fu">l</span>(y, <span class="dv">1</span>) <span class="sc">~</span> <span class="fu">i</span>(high_state, shock) <span class="sc">+</span> <span class="fu">l</span>(y, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">|</span> country <span class="sc">+</span> time,</span>
<span id="cb6-25"><a href="#cb6-25"></a>    <span class="at">data =</span> pdata,</span>
<span id="cb6-26"><a href="#cb6-26"></a>    <span class="at">vcov =</span> <span class="sc">~</span>country</span>
<span id="cb6-27"><a href="#cb6-27"></a>  )</span>
<span id="cb6-28"><a href="#cb6-28"></a></span>
<span id="cb6-29"><a href="#cb6-29"></a>  <span class="co"># Extract coefficients for each state</span></span>
<span id="cb6-30"><a href="#cb6-30"></a>  coef_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">coef</span>(model_state))</span>
<span id="cb6-31"><a href="#cb6-31"></a></span>
<span id="cb6-32"><a href="#cb6-32"></a>  <span class="co"># Low state (high_state = 0)</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>  low_idx <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"high_state::0:shock"</span>, coef_names)</span>
<span id="cb6-34"><a href="#cb6-34"></a>  <span class="cf">if</span> (<span class="fu">length</span>(low_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-35"><a href="#cb6-35"></a>    results_state<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_state)[low_idx]</span>
<span id="cb6-36"><a href="#cb6-36"></a>    results_state<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_state)[low_idx]</span>
<span id="cb6-37"><a href="#cb6-37"></a>  }</span>
<span id="cb6-38"><a href="#cb6-38"></a></span>
<span id="cb6-39"><a href="#cb6-39"></a>  <span class="co"># High state (high_state = 1)</span></span>
<span id="cb6-40"><a href="#cb6-40"></a>  high_idx <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"high_state::1:shock"</span>, coef_names)</span>
<span id="cb6-41"><a href="#cb6-41"></a>  <span class="cf">if</span> (<span class="fu">length</span>(high_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb6-42"><a href="#cb6-42"></a>    results_state<span class="sc">$</span>estimate[H <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> h] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_state)[high_idx]</span>
<span id="cb6-43"><a href="#cb6-43"></a>    results_state<span class="sc">$</span>se[H <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> h] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_state)[high_idx]</span>
<span id="cb6-44"><a href="#cb6-44"></a>  }</span>
<span id="cb6-45"><a href="#cb6-45"></a>}</span>
<span id="cb6-46"><a href="#cb6-46"></a></span>
<span id="cb6-47"><a href="#cb6-47"></a>results_state <span class="ot">&lt;-</span> results_state <span class="sc">%&gt;%</span></span>
<span id="cb6-48"><a href="#cb6-48"></a>  <span class="fu">mutate</span>(</span>
<span id="cb6-49"><a href="#cb6-49"></a>    <span class="at">ci_low =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb6-50"><a href="#cb6-50"></a>    <span class="at">ci_high =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb6-51"><a href="#cb6-51"></a>  )</span>
<span id="cb6-52"><a href="#cb6-52"></a></span>
<span id="cb6-53"><a href="#cb6-53"></a><span class="fu">ggplot</span>(results_state, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> estimate, <span class="at">color =</span> state, <span class="at">fill =</span> state)) <span class="sc">+</span></span>
<span id="cb6-54"><a href="#cb6-54"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb6-55"><a href="#cb6-55"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_low, <span class="at">ymax =</span> ci_high), <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb6-56"><a href="#cb6-56"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb6-57"><a href="#cb6-57"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb6-58"><a href="#cb6-58"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Low"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>, <span class="st">"High"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb6-59"><a href="#cb6-59"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Low"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>, <span class="st">"High"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb6-60"><a href="#cb6-60"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"State-Dependent Impulse Responses"</span>,</span>
<span id="cb6-61"><a href="#cb6-61"></a>       <span class="at">subtitle =</span> <span class="st">"Response to shock differs by regime"</span>,</span>
<span id="cb6-62"><a href="#cb6-62"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Cumulative Response"</span>,</span>
<span id="cb6-63"><a href="#cb6-63"></a>       <span class="at">color =</span> <span class="st">"State"</span>, <span class="at">fill =</span> <span class="st">"State"</span>) <span class="sc">+</span></span>
<span id="cb6-64"><a href="#cb6-64"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/state-dependent-lp-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>State-dependent LP: Responses differ by regime</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="smooth-transition-auerbach-gorodnichenko" class="level2">
<h2 class="anchored" data-anchor-id="smooth-transition-auerbach-gorodnichenko">Smooth Transition (Auerbach-Gorodnichenko)</h2>
<p>Instead of hard switching, use a logistic function for smooth transition:</p>
<p><span class="math display">\[
F(z_t) = \frac{\exp(-\gamma z_t)}{1 + \exp(-\gamma z_t)}
\]</span></p>
<p>where: - <span class="math inline">\(z_t\)</span> is the (standardized) state variable - <span class="math inline">\(\gamma &gt; 0\)</span> controls transition speed - <span class="math inline">\(F(z_t) \to 1\)</span> when <span class="math inline">\(z_t \to -\infty\)</span> (e.g., deep recession) - <span class="math inline">\(F(z_t) \to 0\)</span> when <span class="math inline">\(z_t \to +\infty\)</span> (e.g., strong expansion)</p>
<p>The LP specification becomes:</p>
<p><span class="math display">\[
y_{t+h} = F(z_{t-1}) \cdot [\alpha_R^h + \beta_R^h \cdot \text{shock}_t] + (1 - F(z_{t-1})) \cdot [\alpha_E^h + \beta_E^h \cdot \text{shock}_t] + \cdots
\]</span></p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Demonstrate the logistic transition function</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>z <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a>gamma_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a>transition_df <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">z =</span> z, <span class="at">gamma =</span> gamma_values) <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="at">F_z =</span> <span class="fu">exp</span>(<span class="sc">-</span>gamma <span class="sc">*</span> z) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>gamma <span class="sc">*</span> z)),</span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="at">gamma_label =</span> <span class="fu">paste</span>(<span class="st">"γ ="</span>, gamma)</span>
<span id="cb7-9"><a href="#cb7-9"></a>  )</span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="fu">ggplot</span>(transition_df, <span class="fu">aes</span>(<span class="at">x =</span> z, <span class="at">y =</span> F_z, <span class="at">color =</span> gamma_label)) <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Logistic Transition Function"</span>,</span>
<span id="cb7-16"><a href="#cb7-16"></a>       <span class="at">subtitle =</span> <span class="st">"Higher γ = sharper transition between regimes"</span>,</span>
<span id="cb7-17"><a href="#cb7-17"></a>       <span class="at">x =</span> <span class="st">"Standardized State Variable (z)"</span>,</span>
<span id="cb7-18"><a href="#cb7-18"></a>       <span class="at">y =</span> <span class="st">"F(z) = Probability of 'Recession' Regime"</span>,</span>
<span id="cb7-19"><a href="#cb7-19"></a>       <span class="at">color =</span> <span class="st">"Smoothness"</span>) <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">y =</span> <span class="fl">0.9</span>, <span class="at">label =</span> <span class="st">"Recession</span><span class="sc">\n</span><span class="st">regime"</span>) <span class="sc">+</span></span>
<span id="cb7-21"><a href="#cb7-21"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">label =</span> <span class="st">"Expansion</span><span class="sc">\n</span><span class="st">regime"</span>) <span class="sc">+</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/smooth-transition-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Smooth transition function for state-dependent LP</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="testing-for-state-dependence" class="level2">
<h2 class="anchored" data-anchor-id="testing-for-state-dependence">Testing for State Dependence</h2>
<p>To test whether responses genuinely differ across states:</p>
<p><span class="math display">\[
H_0: \beta_0^h = \beta_1^h \quad \forall h
\]</span></p>
<p><strong>Methods:</strong> 1. <strong>Joint F-test</strong>: Test equality of coefficients across horizons 2. <strong>Horizon-by-horizon t-tests</strong>: Test <span class="math inline">\(\beta_0^h - \beta_1^h = 0\)</span> at each <span class="math inline">\(h\)</span> 3. <strong>Cumulative difference</strong>: Test whether cumulative response differs</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Common Mistake
</div>
</div>
<div class="callout-body-container callout-body">
<p>Showing that <span class="math inline">\(\beta_0^h\)</span> is significant and <span class="math inline">\(\beta_1^h\)</span> is not significant does NOT prove they’re different. You must test the <strong>difference</strong> directly.</p>
</div>
</div>
</section>
</section>
<section id="lp-did-combining-lp-with-difference-in-differences" class="level1 unnumbered">
<h1 class="unnumbered">LP-DiD: Combining LP with Difference-in-Differences</h1>
<p>LP-DiD (Jordà, Dube, Girardi &amp; Taylor, 2024) extends local projections to treatment effect settings with staggered adoption.</p>
<section id="the-setting" class="level2">
<h2 class="anchored" data-anchor-id="the-setting">The Setting</h2>
<ul>
<li>Some units receive treatment at different times</li>
<li>We want to trace out the <strong>dynamic treatment effect</strong> at each horizon</li>
<li>Standard DiD gives one number; LP-DiD gives a path</li>
</ul>
</section>
<section id="the-specification-1" class="level2">
<h2 class="anchored" data-anchor-id="the-specification-1">The Specification</h2>
<p><span class="math display">\[
y_{i,t+h} - y_{i,t-1} = \alpha_i + \delta_t + \beta^h \cdot D_{it} + \mathbf{X}_{it}'\boldsymbol{\gamma}^h + \varepsilon_{i,t+h}
\]</span></p>
<p>where: - <span class="math inline">\(D_{it} = 1\)</span> if unit <span class="math inline">\(i\)</span> is treated at time <span class="math inline">\(t\)</span> - <span class="math inline">\(\alpha_i\)</span> = unit fixed effects - <span class="math inline">\(\delta_t\)</span> = time fixed effects - <span class="math inline">\(\beta^h\)</span> = treatment effect at horizon <span class="math inline">\(h\)</span></p>
<p><strong>Key features:</strong> - Estimates treatment effect at each horizon (not just one average) - Includes negative horizons to test pre-trends - Robust to heterogeneous treatment timing</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Simulate LP-DiD setting (simplified: single treatment time)</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>N_did <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>T_did <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>T_treat <span class="ot">&lt;-</span> <span class="dv">15</span>  <span class="co"># Treatment at period 15</span></span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co"># Generate unit fixed effects</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>unit_fe <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N_did, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb8-8"><a href="#cb8-8"></a>time_fe <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">:</span>T_did) <span class="sc">+</span> <span class="fu">rnorm</span>(T_did, <span class="dv">0</span>, <span class="fl">0.3</span>)</span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a>did_data <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span>N_did,</span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_did</span>
<span id="cb8-13"><a href="#cb8-13"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>  <span class="fu">arrange</span>(unit, time) <span class="sc">%&gt;%</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-16"><a href="#cb8-16"></a>    <span class="co"># First 20 units are treated, rest are control</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>    <span class="at">treated_unit =</span> unit <span class="sc">&lt;=</span> <span class="dv">20</span>,</span>
<span id="cb8-18"><a href="#cb8-18"></a>    <span class="at">post =</span> time <span class="sc">&gt;=</span> T_treat,</span>
<span id="cb8-19"><a href="#cb8-19"></a>    <span class="at">treated =</span> treated_unit <span class="sc">&amp;</span> post,</span>
<span id="cb8-20"><a href="#cb8-20"></a>    <span class="at">rel_time =</span> <span class="fu">ifelse</span>(treated_unit, time <span class="sc">-</span> T_treat, <span class="cn">NA</span>),</span>
<span id="cb8-21"><a href="#cb8-21"></a>    <span class="co"># Fixed effects</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>    <span class="at">unit_effect =</span> unit_fe[unit],</span>
<span id="cb8-23"><a href="#cb8-23"></a>    <span class="at">time_effect =</span> time_fe[time],</span>
<span id="cb8-24"><a href="#cb8-24"></a>    <span class="co"># True treatment effect builds over time (max at +5)</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>    <span class="at">true_effect =</span> <span class="fu">ifelse</span>(treated, <span class="fu">pmin</span>(time <span class="sc">-</span> T_treat <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">5</span>) <span class="sc">*</span> <span class="fl">0.4</span>, <span class="dv">0</span>),</span>
<span id="cb8-26"><a href="#cb8-26"></a>    <span class="at">y =</span> unit_effect <span class="sc">+</span> time_effect <span class="sc">+</span> true_effect <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="fl">0.8</span>)</span>
<span id="cb8-27"><a href="#cb8-27"></a>  )</span>
<span id="cb8-28"><a href="#cb8-28"></a></span>
<span id="cb8-29"><a href="#cb8-29"></a><span class="co"># Estimate LP-DiD at each horizon</span></span>
<span id="cb8-30"><a href="#cb8-30"></a>H_did <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>lp_did_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-32"><a href="#cb8-32"></a>  <span class="at">horizon =</span> <span class="dv">0</span><span class="sc">:</span>H_did,</span>
<span id="cb8-33"><a href="#cb8-33"></a>  <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb8-34"><a href="#cb8-34"></a>  <span class="at">se =</span> <span class="cn">NA_real_</span></span>
<span id="cb8-35"><a href="#cb8-35"></a>)</span>
<span id="cb8-36"><a href="#cb8-36"></a></span>
<span id="cb8-37"><a href="#cb8-37"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H_did) {</span>
<span id="cb8-38"><a href="#cb8-38"></a>  <span class="co"># Create lead of y manually</span></span>
<span id="cb8-39"><a href="#cb8-39"></a>  did_data_h <span class="ot">&lt;-</span> did_data <span class="sc">%&gt;%</span></span>
<span id="cb8-40"><a href="#cb8-40"></a>    <span class="fu">group_by</span>(unit) <span class="sc">%&gt;%</span></span>
<span id="cb8-41"><a href="#cb8-41"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-42"><a href="#cb8-42"></a>      <span class="at">y_lead =</span> <span class="fu">lead</span>(y, h),</span>
<span id="cb8-43"><a href="#cb8-43"></a>      <span class="at">y_lag =</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)</span>
<span id="cb8-44"><a href="#cb8-44"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-45"><a href="#cb8-45"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-46"><a href="#cb8-46"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(y_lead) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_lag))</span>
<span id="cb8-47"><a href="#cb8-47"></a></span>
<span id="cb8-48"><a href="#cb8-48"></a>  model_did <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb8-49"><a href="#cb8-49"></a>    y_lead <span class="sc">-</span> y_lag <span class="sc">~</span> treated <span class="sc">|</span> unit <span class="sc">+</span> time,</span>
<span id="cb8-50"><a href="#cb8-50"></a>    <span class="at">data =</span> did_data_h,</span>
<span id="cb8-51"><a href="#cb8-51"></a>    <span class="at">vcov =</span> <span class="sc">~</span>unit</span>
<span id="cb8-52"><a href="#cb8-52"></a>  )</span>
<span id="cb8-53"><a href="#cb8-53"></a></span>
<span id="cb8-54"><a href="#cb8-54"></a>  lp_did_results<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_did)[<span class="st">"treatedTRUE"</span>]</span>
<span id="cb8-55"><a href="#cb8-55"></a>  lp_did_results<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_did)[<span class="st">"treatedTRUE"</span>]</span>
<span id="cb8-56"><a href="#cb8-56"></a>}</span>
<span id="cb8-57"><a href="#cb8-57"></a></span>
<span id="cb8-58"><a href="#cb8-58"></a>lp_did_results <span class="ot">&lt;-</span> lp_did_results <span class="sc">%&gt;%</span></span>
<span id="cb8-59"><a href="#cb8-59"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-60"><a href="#cb8-60"></a>    <span class="at">ci_low =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb8-61"><a href="#cb8-61"></a>    <span class="at">ci_high =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb8-62"><a href="#cb8-62"></a>  )</span>
<span id="cb8-63"><a href="#cb8-63"></a></span>
<span id="cb8-64"><a href="#cb8-64"></a><span class="co"># Also compute pre-trend check (negative horizons)</span></span>
<span id="cb8-65"><a href="#cb8-65"></a><span class="co"># For pre-trends, we test whether treated units had different growth rates</span></span>
<span id="cb8-66"><a href="#cb8-66"></a><span class="co"># before treatment. Since treated_unit is time-invariant, we use time FE only</span></span>
<span id="cb8-67"><a href="#cb8-67"></a><span class="co"># (not unit FE) to avoid collinearity.</span></span>
<span id="cb8-68"><a href="#cb8-68"></a>pre_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-69"><a href="#cb8-69"></a>  <span class="at">horizon =</span> (<span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb8-70"><a href="#cb8-70"></a>  <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb8-71"><a href="#cb8-71"></a>  <span class="at">se =</span> <span class="cn">NA_real_</span></span>
<span id="cb8-72"><a href="#cb8-72"></a>)</span>
<span id="cb8-73"><a href="#cb8-73"></a></span>
<span id="cb8-74"><a href="#cb8-74"></a><span class="cf">for</span> (h <span class="cf">in</span> (<span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="sc">-</span><span class="dv">1</span>)) {</span>
<span id="cb8-75"><a href="#cb8-75"></a>  did_data_h <span class="ot">&lt;-</span> did_data <span class="sc">%&gt;%</span></span>
<span id="cb8-76"><a href="#cb8-76"></a>    <span class="fu">filter</span>(time <span class="sc">&lt;</span> T_treat) <span class="sc">%&gt;%</span>  <span class="co"># Pre-treatment only</span></span>
<span id="cb8-77"><a href="#cb8-77"></a>    <span class="fu">group_by</span>(unit) <span class="sc">%&gt;%</span></span>
<span id="cb8-78"><a href="#cb8-78"></a>    <span class="fu">mutate</span>(</span>
<span id="cb8-79"><a href="#cb8-79"></a>      <span class="at">y_lead =</span> <span class="fu">lead</span>(y, <span class="sc">-</span>h),  <span class="co"># Note: negative h means lag</span></span>
<span id="cb8-80"><a href="#cb8-80"></a>      <span class="at">y_lag =</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)</span>
<span id="cb8-81"><a href="#cb8-81"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb8-82"><a href="#cb8-82"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-83"><a href="#cb8-83"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(y_lead) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_lag))</span>
<span id="cb8-84"><a href="#cb8-84"></a></span>
<span id="cb8-85"><a href="#cb8-85"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(did_data_h) <span class="sc">&gt;</span> <span class="dv">50</span>) {</span>
<span id="cb8-86"><a href="#cb8-86"></a>    <span class="co"># Use time FE only for pre-trends (treated_unit is unit-level, collinear with unit FE)</span></span>
<span id="cb8-87"><a href="#cb8-87"></a>    <span class="co"># This tests: did treated units have different GROWTH before treatment?</span></span>
<span id="cb8-88"><a href="#cb8-88"></a>    model_pre <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb8-89"><a href="#cb8-89"></a>      y_lead <span class="sc">-</span> y_lag <span class="sc">~</span> treated_unit <span class="sc">|</span> time,</span>
<span id="cb8-90"><a href="#cb8-90"></a>      <span class="at">data =</span> did_data_h,</span>
<span id="cb8-91"><a href="#cb8-91"></a>      <span class="at">vcov =</span> <span class="sc">~</span>unit</span>
<span id="cb8-92"><a href="#cb8-92"></a>    )</span>
<span id="cb8-93"><a href="#cb8-93"></a>    idx <span class="ot">&lt;-</span> h <span class="sc">+</span> <span class="dv">5</span></span>
<span id="cb8-94"><a href="#cb8-94"></a>    pre_results<span class="sc">$</span>estimate[idx] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_pre)[<span class="st">"treated_unitTRUE"</span>]</span>
<span id="cb8-95"><a href="#cb8-95"></a>    pre_results<span class="sc">$</span>se[idx] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_pre)[<span class="st">"treated_unitTRUE"</span>]</span>
<span id="cb8-96"><a href="#cb8-96"></a>  }</span>
<span id="cb8-97"><a href="#cb8-97"></a>}</span>
<span id="cb8-98"><a href="#cb8-98"></a></span>
<span id="cb8-99"><a href="#cb8-99"></a>pre_results <span class="ot">&lt;-</span> pre_results <span class="sc">%&gt;%</span></span>
<span id="cb8-100"><a href="#cb8-100"></a>  <span class="fu">mutate</span>(<span class="at">ci_low =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se, <span class="at">ci_high =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se)</span>
<span id="cb8-101"><a href="#cb8-101"></a></span>
<span id="cb8-102"><a href="#cb8-102"></a><span class="co"># Combine</span></span>
<span id="cb8-103"><a href="#cb8-103"></a>all_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb8-104"><a href="#cb8-104"></a>  pre_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">period =</span> <span class="st">"Pre-treatment"</span>),</span>
<span id="cb8-105"><a href="#cb8-105"></a>  lp_did_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">period =</span> <span class="st">"Post-treatment"</span>)</span>
<span id="cb8-106"><a href="#cb8-106"></a>)</span>
<span id="cb8-107"><a href="#cb8-107"></a></span>
<span id="cb8-108"><a href="#cb8-108"></a><span class="fu">ggplot</span>(all_results, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb8-109"><a href="#cb8-109"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb8-110"><a href="#cb8-110"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb8-111"><a href="#cb8-111"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_low, <span class="at">ymax =</span> ci_high, <span class="at">fill =</span> period), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb8-112"><a href="#cb8-112"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> period), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb8-113"><a href="#cb8-113"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> period), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb8-114"><a href="#cb8-114"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-treatment"</span> <span class="ot">=</span> <span class="st">"#95a5a6"</span>, <span class="st">"Post-treatment"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb8-115"><a href="#cb8-115"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-treatment"</span> <span class="ot">=</span> <span class="st">"#95a5a6"</span>, <span class="st">"Post-treatment"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb8-116"><a href="#cb8-116"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LP-DiD: Dynamic Treatment Effects"</span>,</span>
<span id="cb8-117"><a href="#cb8-117"></a>       <span class="at">subtitle =</span> <span class="st">"Pre-treatment coefficients test parallel trends"</span>,</span>
<span id="cb8-118"><a href="#cb8-118"></a>       <span class="at">x =</span> <span class="st">"Horizon (periods relative to treatment)"</span>,</span>
<span id="cb8-119"><a href="#cb8-119"></a>       <span class="at">y =</span> <span class="st">"Treatment Effect"</span>,</span>
<span id="cb8-120"><a href="#cb8-120"></a>       <span class="at">color =</span> <span class="st">"Period"</span>, <span class="at">fill =</span> <span class="st">"Period"</span>) <span class="sc">+</span></span>
<span id="cb8-121"><a href="#cb8-121"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">2.5</span>, <span class="at">y =</span> <span class="fl">0.3</span>, <span class="at">label =</span> <span class="st">"Pre-trends</span><span class="sc">\n</span><span class="st">(≈ 0)"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb8-122"><a href="#cb8-122"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="st">"Treatment</span><span class="sc">\n</span><span class="st">effect builds"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb8-123"><a href="#cb8-123"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/lp-did-simulation-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>LP-DiD: Dynamic treatment effects with pre-trend check</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="lp-did-vs.-standard-event-study" class="level2">
<h2 class="anchored" data-anchor-id="lp-did-vs.-standard-event-study">LP-DiD vs.&nbsp;Standard Event Study</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Feature</th>
<th>Standard Event Study</th>
<th>LP-DiD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>LHS</td>
<td><span class="math inline">\(y_{it}\)</span></td>
<td><span class="math inline">\(y_{i,t+h} - y_{i,t-1}\)</span></td>
</tr>
<tr class="even">
<td>Interpretation</td>
<td>Level relative to <span class="math inline">\(t=-1\)</span></td>
<td>Cumulative change</td>
</tr>
<tr class="odd">
<td>Horizons</td>
<td>Relative time dummies</td>
<td>Direct projection</td>
</tr>
<tr class="even">
<td>Handles dynamics</td>
<td>Imposes structure</td>
<td>Flexible</td>
</tr>
</tbody>
</table>
<p>LP-DiD is particularly useful when: - Treatment effects build gradually - You want impulse response interpretation - Dynamics are complex or nonlinear</p>
</section>
</section>
<section id="diagnostics-and-practical-issues" class="level1 unnumbered">
<h1 class="unnumbered">Diagnostics and Practical Issues</h1>
<section id="sample-erosion-at-long-horizons" class="level2">
<h2 class="anchored" data-anchor-id="sample-erosion-at-long-horizons">Sample Erosion at Long Horizons</h2>
<p>At horizon <span class="math inline">\(h\)</span>, you lose <span class="math inline">\(h\)</span> observations from the end of your sample: - <span class="math inline">\(h = 0\)</span>: Full sample - <span class="math inline">\(h = 12\)</span>: Lose 12 periods (3 years of quarterly data)</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>sample_sizes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="at">horizon =</span> <span class="dv">0</span><span class="sc">:</span>H,</span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="at">n_obs =</span> <span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span>H, <span class="cf">function</span>(h) {</span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(panel_data<span class="sc">$</span>y) <span class="sc">&amp;</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>        (panel_data<span class="sc">$</span>time <span class="sc">&lt;=</span> T_obs <span class="sc">-</span> h) <span class="sc">&amp;</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>        (panel_data<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">2</span>))</span>
<span id="cb9-7"><a href="#cb9-7"></a>  })</span>
<span id="cb9-8"><a href="#cb9-8"></a>)</span>
<span id="cb9-9"><a href="#cb9-9"></a></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="fu">ggplot</span>(sample_sizes, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> n_obs)) <span class="sc">+</span></span>
<span id="cb9-11"><a href="#cb9-11"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"#9b59b6"</span>) <span class="sc">+</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#9b59b6"</span>) <span class="sc">+</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sample Size by Horizon"</span>,</span>
<span id="cb9-14"><a href="#cb9-14"></a>       <span class="at">subtitle =</span> <span class="st">"Sample shrinks as horizon increases"</span>,</span>
<span id="cb9-15"><a href="#cb9-15"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Number of Observations"</span>) <span class="sc">+</span></span>
<span id="cb9-16"><a href="#cb9-16"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/sample-erosion-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p><strong>Implications:</strong> - Confidence intervals widen at longer horizons (less data + more uncertainty) - Truncate horizons when CIs become uninformative - Report effective sample size at each horizon</p>
</section>
<section id="lag-selection" class="level2">
<h2 class="anchored" data-anchor-id="lag-selection">Lag Selection</h2>
<p><strong>Rule:</strong> Use the <strong>same lag structure across all horizons</strong> for comparability.</p>
<p>Methods: 1. Information criteria (AIC, BIC) on the <span class="math inline">\(h = 0\)</span> regression 2. LM test for serial correlation in residuals 3. Rule of thumb: 2-4 lags for quarterly, 1-2 for annual</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="co"># Compare different lag specifications at h = 4</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>lag_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="at">lags =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb10-4"><a href="#cb10-4"></a>  <span class="at">aic =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="at">bic =</span> <span class="cn">NA_real_</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>)</span>
<span id="cb10-7"><a href="#cb10-7"></a></span>
<span id="cb10-8"><a href="#cb10-8"></a>h_test <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb10-9"><a href="#cb10-9"></a></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="cf">for</span> (p <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) {</span>
<span id="cb10-11"><a href="#cb10-11"></a>  <span class="co"># Build formula with p lags</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>  formula_str <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"f(y, "</span>, h_test, <span class="st">") - l(y, 1) ~ shock + l(y, 1:"</span>, p, <span class="st">") | country + time"</span>)</span>
<span id="cb10-13"><a href="#cb10-13"></a></span>
<span id="cb10-14"><a href="#cb10-14"></a>  model_lag <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> pdata, <span class="at">vcov =</span> <span class="sc">~</span>country)</span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a>  lag_comparison<span class="sc">$</span>aic[p] <span class="ot">&lt;-</span> <span class="fu">AIC</span>(model_lag)</span>
<span id="cb10-17"><a href="#cb10-17"></a>  lag_comparison<span class="sc">$</span>bic[p] <span class="ot">&lt;-</span> <span class="fu">BIC</span>(model_lag)</span>
<span id="cb10-18"><a href="#cb10-18"></a>}</span>
<span id="cb10-19"><a href="#cb10-19"></a></span>
<span id="cb10-20"><a href="#cb10-20"></a>lag_comparison_long <span class="ot">&lt;-</span> lag_comparison <span class="sc">%&gt;%</span></span>
<span id="cb10-21"><a href="#cb10-21"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(aic, bic), <span class="at">names_to =</span> <span class="st">"criterion"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb10-22"><a href="#cb10-22"></a></span>
<span id="cb10-23"><a href="#cb10-23"></a><span class="fu">ggplot</span>(lag_comparison_long, <span class="fu">aes</span>(<span class="at">x =</span> lags, <span class="at">y =</span> value, <span class="at">color =</span> criterion)) <span class="sc">+</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb10-25"><a href="#cb10-25"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb10-26"><a href="#cb10-26"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"aic"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>, <span class="st">"bic"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb10-27"><a href="#cb10-27"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"AIC"</span>, <span class="st">"BIC"</span>)) <span class="sc">+</span></span>
<span id="cb10-28"><a href="#cb10-28"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Lag Selection for LP"</span>,</span>
<span id="cb10-29"><a href="#cb10-29"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Information criteria at horizon h ="</span>, h_test),</span>
<span id="cb10-30"><a href="#cb10-30"></a>       <span class="at">x =</span> <span class="st">"Number of Lags"</span>, <span class="at">y =</span> <span class="st">"Information Criterion"</span>,</span>
<span id="cb10-31"><a href="#cb10-31"></a>       <span class="at">color =</span> <span class="st">"Criterion"</span>) <span class="sc">+</span></span>
<span id="cb10-32"><a href="#cb10-32"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/lag-selection-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="cumulative-vs.-non-cumulative" class="level2">
<h2 class="anchored" data-anchor-id="cumulative-vs.-non-cumulative">Cumulative vs.&nbsp;Non-Cumulative</h2>
<p><strong>Cumulative (recommended for levels):</strong> <span class="math display">\[
\text{LHS} = y_{t+h} - y_{t-1}
\]</span> Interpretation: Total change from <span class="math inline">\(t-1\)</span> to <span class="math inline">\(t+h\)</span>.</p>
<p><strong>Non-cumulative:</strong> <span class="math display">\[
\text{LHS} = y_{t+h}
\]</span> Interpretation: Level at <span class="math inline">\(t+h\)</span> (includes pre-existing trend).</p>
<p>Use cumulative for: - GDP, debt/GDP, price level - Any variable where you care about the total change</p>
<p>Use non-cumulative for: - Growth rates, inflation (already differenced) - When you want the level effect</p>
</section>
<section id="comparing-lp-and-var-irfs" class="level2">
<h2 class="anchored" data-anchor-id="comparing-lp-and-var-irfs">Comparing LP and VAR IRFs</h2>
<p>Always compare LP and VAR when possible:</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># This is stylized - in practice, estimate both and compare</span></span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a>comparison_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb11-4"><a href="#cb11-4"></a>  <span class="at">horizon =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>H, <span class="dv">2</span>),</span>
<span id="cb11-5"><a href="#cb11-5"></a>  <span class="at">method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"LP"</span>, <span class="st">"VAR"</span>), <span class="at">each =</span> H <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="at">estimate =</span> <span class="fu">c</span>(results<span class="sc">$</span>estimate, results<span class="sc">$</span>estimate <span class="sc">*</span> <span class="fl">0.95</span>),  <span class="co"># Stylized: VAR slightly different</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>  <span class="at">ci_width =</span> <span class="fu">c</span>(results<span class="sc">$</span>se <span class="sc">*</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="dv">2</span>, results<span class="sc">$</span>se <span class="sc">*</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fl">1.3</span>)  <span class="co"># LP wider CIs</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>)</span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="fu">ggplot</span>(comparison_data, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> estimate, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> estimate <span class="sc">-</span> ci_width<span class="sc">/</span><span class="dv">2</span>, <span class="at">ymax =</span> estimate <span class="sc">+</span> ci_width<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb11-14"><a href="#cb11-14"></a>                <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"LP"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>, <span class="st">"VAR"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>)) <span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LP vs VAR: Point Estimates and Confidence Intervals"</span>,</span>
<span id="cb11-17"><a href="#cb11-17"></a>       <span class="at">subtitle =</span> <span class="st">"LP has wider CIs but is more robust to misspecification"</span>,</span>
<span id="cb11-18"><a href="#cb11-18"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Response"</span>,</span>
<span id="cb11-19"><a href="#cb11-19"></a>       <span class="at">color =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="03_local_projections_files/figure-html/lp-var-comparison-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>LP produces wider but more robust confidence intervals than VAR</figcaption>
</figure>
</div>
</div>
</div>
<p><strong>When LP and VAR disagree:</strong> - Check VAR specification (lags, variables) - LP is likely more robust to misspecification - VAR may be picking up spurious dynamics</p>
</section>
</section>
<section id="frequently-asked-questions" class="level1 unnumbered">
<h1 class="unnumbered">Frequently Asked Questions</h1>
<section id="when-should-i-use-lp-vs.-var" class="level2">
<h2 class="anchored" data-anchor-id="when-should-i-use-lp-vs.-var">When should I use LP vs.&nbsp;VAR?</h2>
<p><strong>Use LP when:</strong> - You only need to identify ONE shock - Misspecification is a concern - You want state-dependent or nonlinear responses - You’re working with panel data</p>
<p><strong>Use VAR when:</strong> - You need the full system (FEVD, historical decomposition) - Efficiency matters and you trust the specification - Short horizons with well-identified structure</p>
</section>
<section id="how-do-i-choose-the-horizon-h" class="level2">
<h2 class="anchored" data-anchor-id="how-do-i-choose-the-horizon-h">How do I choose the horizon H?</h2>
<ul>
<li>Plot IRFs and extend until they converge to zero (or steady state)</li>
<li>Stop when confidence intervals become uninformative</li>
<li>Rule of thumb: H = 4-5 years for quarterly macro data</li>
<li>Report effective sample sizes</li>
</ul>
</section>
<section id="what-controls-should-i-include" class="level2">
<h2 class="anchored" data-anchor-id="what-controls-should-i-include">What controls should I include?</h2>
<ul>
<li>Lagged dependent variable (always)</li>
<li>Variables that affect both shock and outcome (confounders)</li>
<li><strong>Don’t include</strong> post-treatment controls (bad controls)</li>
<li>Keep controls consistent across horizons</li>
</ul>
</section>
<section id="how-do-i-report-results" class="level2">
<h2 class="anchored" data-anchor-id="how-do-i-report-results">How do I report results?</h2>
<ol type="1">
<li><strong>Plot the IRF</strong> with confidence bands</li>
<li><strong>Report</strong> the peak response and time to peak</li>
<li><strong>Table</strong> with point estimates and SEs at key horizons</li>
<li><strong>Report</strong> sample size at each horizon</li>
<li><strong>Compare</strong> with VAR if possible</li>
</ol>
</section>
</section>
<section id="summary" class="level1 unnumbered">
<h1 class="unnumbered">Summary</h1>
<p>Key takeaways from this module:</p>
<ol type="1">
<li><p><strong>LP estimates IRFs directly</strong> at each horizon—no need to specify full system</p></li>
<li><p><strong>LP and VAR give same population IRFs</strong> but LP is more robust to misspecification</p></li>
<li><p><strong>Use HAC or clustered SEs</strong>—overlapping residuals create serial correlation</p></li>
<li><p><strong>State-dependent LP</strong> is easy: interact shock with state indicator</p></li>
<li><p><strong>LP-DiD</strong> extends to treatment effect settings with dynamic effects</p></li>
<li><p><strong>Sample erodes</strong> at longer horizons—report effective sample sizes</p></li>
<li><p><strong>Confidence intervals widen</strong> with horizon—this is a feature, not a bug</p></li>
</ol>
<hr>
<p><em>Next: <a href="../chapters/04_var_svar.html">Module 4: Vector Autoregressions</a></em></p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-jorda2005" class="csl-entry" role="listitem">
Jordà, Òscar. 2005. <span>“Estimation and Inference of Impulse Responses by Local Projections.”</span> <em>American Economic Review</em> 95 (1): 161–82.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/02_identification.html" class="pagination-link" aria-label="Identification in Macroeconomics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">Identification in Macroeconomics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/04_var_svar.html" class="pagination-link" aria-label="Vector Autoregressions">
        <span class="nav-page-text"><span class="chapter-title">Vector Autoregressions</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">---</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="an">title:</span><span class="co"> "Local Projections"</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="an">subtitle:</span><span class="co"> "Flexible Impulse Response Estimation"</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co">---</span></span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="in">```{r}</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="co">#| label: setup</span></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">#| include: false</span></span>
<span id="cb12-11"><a href="#cb12-11"></a></span>
<span id="cb12-12"><a href="#cb12-12"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb12-13"><a href="#cb12-13"></a>  <span class="at">echo =</span> <span class="cn">TRUE</span>, <span class="at">warning =</span> <span class="cn">FALSE</span>, <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-14"><a href="#cb12-14"></a>  <span class="at">fig.width =</span> <span class="dv">10</span>, <span class="at">fig.height =</span> <span class="dv">6</span>, <span class="at">fig.align =</span> <span class="st">"center"</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>)</span>
<span id="cb12-16"><a href="#cb12-16"></a></span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb12-18"><a href="#cb12-18"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="fu">library</span>(fixest)</span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="fu">library</span>(MASS)</span>
<span id="cb12-22"><a href="#cb12-22"></a><span class="fu">library</span>(sandwich)</span>
<span id="cb12-23"><a href="#cb12-23"></a></span>
<span id="cb12-24"><a href="#cb12-24"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>))</span>
<span id="cb12-25"><a href="#cb12-25"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb12-26"><a href="#cb12-26"></a><span class="in">```</span></span>
<span id="cb12-27"><a href="#cb12-27"></a></span>
<span id="cb12-28"><a href="#cb12-28"></a><span class="fu"># The Local Projections Idea {.unnumbered}</span></span>
<span id="cb12-29"><a href="#cb12-29"></a></span>
<span id="cb12-30"><a href="#cb12-30"></a>Local Projections (LP), introduced by @jorda2005, provide a flexible alternative to Vector Autoregressions for estimating impulse response functions. The key insight: instead of specifying and iterating a full dynamic system, directly regress the outcome $h$ periods ahead on today's shock.</span>
<span id="cb12-31"><a href="#cb12-31"></a></span>
<span id="cb12-32"><a href="#cb12-32"></a><span class="fu">## From VAR to LP</span></span>
<span id="cb12-33"><a href="#cb12-33"></a></span>
<span id="cb12-34"><a href="#cb12-34"></a><span class="fu">### The VAR Approach</span></span>
<span id="cb12-35"><a href="#cb12-35"></a></span>
<span id="cb12-36"><a href="#cb12-36"></a>A VAR(p) models the joint dynamics of a vector $\mathbf{y}_t$:</span>
<span id="cb12-37"><a href="#cb12-37"></a></span>
<span id="cb12-38"><a href="#cb12-38"></a>$$</span>
<span id="cb12-39"><a href="#cb12-39"></a>\mathbf{y}_t = \mathbf{c} + \mathbf{A}_1 \mathbf{y}_{t-1} + \cdots + \mathbf{A}_p \mathbf{y}_{t-p} + \mathbf{u}_t</span>
<span id="cb12-40"><a href="#cb12-40"></a>$$</span>
<span id="cb12-41"><a href="#cb12-41"></a></span>
<span id="cb12-42"><a href="#cb12-42"></a>To get impulse responses, we:</span>
<span id="cb12-43"><a href="#cb12-43"></a><span class="ss">1. </span>Identify structural shocks (Cholesky, sign restrictions, etc.)</span>
<span id="cb12-44"><a href="#cb12-44"></a><span class="ss">2. </span>Iterate the system forward to compute $\frac{\partial \mathbf{y}_{t+h}}{\partial \varepsilon_t}$</span>
<span id="cb12-45"><a href="#cb12-45"></a></span>
<span id="cb12-46"><a href="#cb12-46"></a>This requires **correct specification of the entire system**.</span>
<span id="cb12-47"><a href="#cb12-47"></a></span>
<span id="cb12-48"><a href="#cb12-48"></a><span class="fu">### The LP Approach</span></span>
<span id="cb12-49"><a href="#cb12-49"></a></span>
<span id="cb12-50"><a href="#cb12-50"></a>LP estimates the response at each horizon $h$ directly:</span>
<span id="cb12-51"><a href="#cb12-51"></a></span>
<span id="cb12-52"><a href="#cb12-52"></a>$$</span>
<span id="cb12-53"><a href="#cb12-53"></a>y_{t+h} = \alpha^h + \beta^h \cdot \text{shock}_t + \mathbf{X}_t' \boldsymbol{\gamma}^h + \varepsilon_{t+h}</span>
<span id="cb12-54"><a href="#cb12-54"></a>$$</span>
<span id="cb12-55"><a href="#cb12-55"></a></span>
<span id="cb12-56"><a href="#cb12-56"></a>where:</span>
<span id="cb12-57"><a href="#cb12-57"></a><span class="ss">- </span>$\beta^h$ is the impulse response at horizon $h$</span>
<span id="cb12-58"><a href="#cb12-58"></a><span class="ss">- </span>$\mathbf{X}_t$ contains controls (lags of $y$, other variables)</span>
<span id="cb12-59"><a href="#cb12-59"></a><span class="ss">- </span>Each horizon is a **separate regression**</span>
<span id="cb12-60"><a href="#cb12-60"></a></span>
<span id="cb12-61"><a href="#cb12-61"></a>::: {.callout-tip}</span>
<span id="cb12-62"><a href="#cb12-62"></a><span class="fu">## Key Insight</span></span>
<span id="cb12-63"><a href="#cb12-63"></a>LP doesn't require specifying the full dynamic system. We only need to identify the shock of interest—the rest of the economy can be a "black box."</span>
<span id="cb12-64"><a href="#cb12-64"></a>:::</span>
<span id="cb12-65"><a href="#cb12-65"></a></span>
<span id="cb12-66"><a href="#cb12-66"></a><span class="fu">## When LP and VAR Give the Same Answer</span></span>
<span id="cb12-67"><a href="#cb12-67"></a></span>
<span id="cb12-68"><a href="#cb12-68"></a>**Theorem (Plagborg-Møller &amp; Wolf, 2021):** Under correct specification, LP and VAR estimate the same population impulse responses.</span>
<span id="cb12-69"><a href="#cb12-69"></a></span>
<span id="cb12-70"><a href="#cb12-70"></a>Both methods are consistent for:</span>
<span id="cb12-71"><a href="#cb12-71"></a>$$</span>
<span id="cb12-72"><a href="#cb12-72"></a>\text{IRF}(h) = \frac{\partial \mathbb{E}<span class="co">[</span><span class="ot">y_{t+h} | \mathcal{I}_t</span><span class="co">]</span>}{\partial \text{shock}_t}</span>
<span id="cb12-73"><a href="#cb12-73"></a>$$</span>
<span id="cb12-74"><a href="#cb12-74"></a></span>
<span id="cb12-75"><a href="#cb12-75"></a>The difference is in **finite samples** and **misspecification**:</span>
<span id="cb12-76"><a href="#cb12-76"></a></span>
<span id="cb12-77"><a href="#cb12-77"></a><span class="pp">|</span> Aspect <span class="pp">|</span> VAR <span class="pp">|</span> LP <span class="pp">|</span></span>
<span id="cb12-78"><a href="#cb12-78"></a><span class="pp">|--------|-----|-----|</span></span>
<span id="cb12-79"><a href="#cb12-79"></a><span class="pp">|</span> Specification <span class="pp">|</span> Imposes structure <span class="pp">|</span> Agnostic at each horizon <span class="pp">|</span></span>
<span id="cb12-80"><a href="#cb12-80"></a><span class="pp">|</span> Efficiency <span class="pp">|</span> More efficient if correct <span class="pp">|</span> Less efficient (more parameters) <span class="pp">|</span></span>
<span id="cb12-81"><a href="#cb12-81"></a><span class="pp">|</span> Misspecification <span class="pp">|</span> Biased if wrong <span class="pp">|</span> Robust <span class="pp">|</span></span>
<span id="cb12-82"><a href="#cb12-82"></a><span class="pp">|</span> Confidence intervals <span class="pp">|</span> Tighter <span class="pp">|</span> Wider (but honest) <span class="pp">|</span></span>
<span id="cb12-83"><a href="#cb12-83"></a></span>
<span id="cb12-84"><a href="#cb12-84"></a><span class="fu">## When They Diverge</span></span>
<span id="cb12-85"><a href="#cb12-85"></a></span>
<span id="cb12-86"><a href="#cb12-86"></a>LP and VAR can give different answers when:</span>
<span id="cb12-87"><a href="#cb12-87"></a></span>
<span id="cb12-88"><a href="#cb12-88"></a><span class="ss">1. </span>**VAR is misspecified**: Wrong lag length, omitted variables, nonlinearities</span>
<span id="cb12-89"><a href="#cb12-89"></a><span class="ss">2. </span>**Small samples**: LP's horizon-by-horizon estimation is noisier</span>
<span id="cb12-90"><a href="#cb12-90"></a><span class="ss">3. </span>**Long horizons**: VAR extrapolates; LP estimates directly (sample shrinks)</span>
<span id="cb12-91"><a href="#cb12-91"></a></span>
<span id="cb12-94"><a href="#cb12-94"></a><span class="in">```{r}</span></span>
<span id="cb12-95"><a href="#cb12-95"></a><span class="co">#| label: lp-vs-var-simulation</span></span>
<span id="cb12-96"><a href="#cb12-96"></a><span class="co">#| fig-cap: "LP vs VAR: Both recover true IRF from correctly specified DGP"</span></span>
<span id="cb12-97"><a href="#cb12-97"></a></span>
<span id="cb12-98"><a href="#cb12-98"></a><span class="co"># Simulate a simple AR(1) process</span></span>
<span id="cb12-99"><a href="#cb12-99"></a>T <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb12-100"><a href="#cb12-100"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb12-101"><a href="#cb12-101"></a>y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T)</span>
<span id="cb12-102"><a href="#cb12-102"></a>shock <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">rep</span>(<span class="dv">0</span>, T<span class="dv">-1</span>))  <span class="co"># Unit impulse at t=1</span></span>
<span id="cb12-103"><a href="#cb12-103"></a></span>
<span id="cb12-104"><a href="#cb12-104"></a><span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>T) {</span>
<span id="cb12-105"><a href="#cb12-105"></a>  y[t] <span class="ot">&lt;-</span> rho <span class="sc">*</span> y[t<span class="dv">-1</span>] <span class="sc">+</span> shock[t]</span>
<span id="cb12-106"><a href="#cb12-106"></a>}</span>
<span id="cb12-107"><a href="#cb12-107"></a></span>
<span id="cb12-108"><a href="#cb12-108"></a><span class="co"># True IRF: rho^h</span></span>
<span id="cb12-109"><a href="#cb12-109"></a>H <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb12-110"><a href="#cb12-110"></a>true_irf <span class="ot">&lt;-</span> rho<span class="sc">^</span>(<span class="dv">0</span><span class="sc">:</span>H)</span>
<span id="cb12-111"><a href="#cb12-111"></a></span>
<span id="cb12-112"><a href="#cb12-112"></a><span class="co"># LP estimation</span></span>
<span id="cb12-113"><a href="#cb12-113"></a>lp_irf <span class="ot">&lt;-</span> <span class="fu">numeric</span>(H <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb12-114"><a href="#cb12-114"></a>lp_se <span class="ot">&lt;-</span> <span class="fu">numeric</span>(H <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb12-115"><a href="#cb12-115"></a></span>
<span id="cb12-116"><a href="#cb12-116"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H) {</span>
<span id="cb12-117"><a href="#cb12-117"></a>  <span class="co"># Create lead of y</span></span>
<span id="cb12-118"><a href="#cb12-118"></a>  y_lead <span class="ot">&lt;-</span> <span class="fu">c</span>(y[(h<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>T], <span class="fu">rep</span>(<span class="cn">NA</span>, h))</span>
<span id="cb12-119"><a href="#cb12-119"></a>  y_lag <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, y[<span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)])</span>
<span id="cb12-120"><a href="#cb12-120"></a></span>
<span id="cb12-121"><a href="#cb12-121"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y_lead =</span> y_lead, <span class="at">shock =</span> shock, <span class="at">y_lag =</span> y_lag) <span class="sc">%&gt;%</span></span>
<span id="cb12-122"><a href="#cb12-122"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(y_lead) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_lag))</span>
<span id="cb12-123"><a href="#cb12-123"></a></span>
<span id="cb12-124"><a href="#cb12-124"></a>  fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_lead <span class="sc">~</span> shock <span class="sc">+</span> y_lag, <span class="at">data =</span> df)</span>
<span id="cb12-125"><a href="#cb12-125"></a>  lp_irf[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)[<span class="st">"shock"</span>]</span>
<span id="cb12-126"><a href="#cb12-126"></a>  lp_se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">diag</span>(<span class="fu">vcov</span>(fit)))[<span class="st">"shock"</span>]</span>
<span id="cb12-127"><a href="#cb12-127"></a>}</span>
<span id="cb12-128"><a href="#cb12-128"></a></span>
<span id="cb12-129"><a href="#cb12-129"></a><span class="co"># VAR estimation (just AR(1) here)</span></span>
<span id="cb12-130"><a href="#cb12-130"></a>var_fit <span class="ot">&lt;-</span> <span class="fu">lm</span>(y[<span class="dv">2</span><span class="sc">:</span>T] <span class="sc">~</span> y[<span class="dv">1</span><span class="sc">:</span>(T<span class="dv">-1</span>)])</span>
<span id="cb12-131"><a href="#cb12-131"></a>rho_hat <span class="ot">&lt;-</span> <span class="fu">coef</span>(var_fit)[<span class="dv">2</span>]</span>
<span id="cb12-132"><a href="#cb12-132"></a>var_irf <span class="ot">&lt;-</span> rho_hat<span class="sc">^</span>(<span class="dv">0</span><span class="sc">:</span>H)</span>
<span id="cb12-133"><a href="#cb12-133"></a></span>
<span id="cb12-134"><a href="#cb12-134"></a><span class="co"># Plot comparison</span></span>
<span id="cb12-135"><a href="#cb12-135"></a>irf_compare <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-136"><a href="#cb12-136"></a>  <span class="at">horizon =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>H, <span class="dv">3</span>),</span>
<span id="cb12-137"><a href="#cb12-137"></a>  <span class="at">irf =</span> <span class="fu">c</span>(true_irf, lp_irf, var_irf),</span>
<span id="cb12-138"><a href="#cb12-138"></a>  <span class="at">method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"True"</span>, <span class="st">"LP"</span>, <span class="st">"VAR"</span>), <span class="at">each =</span> H <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb12-139"><a href="#cb12-139"></a>)</span>
<span id="cb12-140"><a href="#cb12-140"></a></span>
<span id="cb12-141"><a href="#cb12-141"></a><span class="fu">ggplot</span>(irf_compare, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> irf, <span class="at">color =</span> method, <span class="at">linetype =</span> method)) <span class="sc">+</span></span>
<span id="cb12-142"><a href="#cb12-142"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-143"><a href="#cb12-143"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-144"><a href="#cb12-144"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"True"</span> <span class="ot">=</span> <span class="st">"black"</span>, <span class="st">"LP"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>, <span class="st">"VAR"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>)) <span class="sc">+</span></span>
<span id="cb12-145"><a href="#cb12-145"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"True"</span> <span class="ot">=</span> <span class="st">"solid"</span>, <span class="st">"LP"</span> <span class="ot">=</span> <span class="st">"dashed"</span>, <span class="st">"VAR"</span> <span class="ot">=</span> <span class="st">"dotted"</span>)) <span class="sc">+</span></span>
<span id="cb12-146"><a href="#cb12-146"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LP vs VAR: Impulse Response Comparison"</span>,</span>
<span id="cb12-147"><a href="#cb12-147"></a>       <span class="at">subtitle =</span> <span class="st">"Both recover the true IRF from an AR(1) DGP"</span>,</span>
<span id="cb12-148"><a href="#cb12-148"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Response to Unit Shock"</span>,</span>
<span id="cb12-149"><a href="#cb12-149"></a>       <span class="at">color =</span> <span class="st">"Method"</span>, <span class="at">linetype =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb12-150"><a href="#cb12-150"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb12-151"><a href="#cb12-151"></a><span class="in">```</span></span>
<span id="cb12-152"><a href="#cb12-152"></a></span>
<span id="cb12-153"><a href="#cb12-153"></a><span class="fu"># Basic LP Estimation {.unnumbered}</span></span>
<span id="cb12-154"><a href="#cb12-154"></a></span>
<span id="cb12-155"><a href="#cb12-155"></a><span class="fu">## The Specification</span></span>
<span id="cb12-156"><a href="#cb12-156"></a></span>
<span id="cb12-157"><a href="#cb12-157"></a>For a panel of countries observed over time:</span>
<span id="cb12-158"><a href="#cb12-158"></a></span>
<span id="cb12-159"><a href="#cb12-159"></a>$$</span>
<span id="cb12-160"><a href="#cb12-160"></a>y_{i,t+h} - y_{i,t-1} = \alpha_i^h + \delta_t^h + \beta^h \cdot \text{shock}_{it} + \mathbf{X}_{it}'\boldsymbol{\gamma}^h + \varepsilon_{i,t+h}</span>
<span id="cb12-161"><a href="#cb12-161"></a>$$</span>
<span id="cb12-162"><a href="#cb12-162"></a></span>
<span id="cb12-163"><a href="#cb12-163"></a>**Left-hand side:** Cumulative change from $t-1$ to $t+h$. This gives the **cumulative multiplier**—how much $y$ has changed in total by horizon $h$.</span>
<span id="cb12-164"><a href="#cb12-164"></a></span>
<span id="cb12-165"><a href="#cb12-165"></a>**Right-hand side:**</span>
<span id="cb12-166"><a href="#cb12-166"></a><span class="ss">- </span>$\alpha_i^h$: Country fixed effects (absorb level differences)</span>
<span id="cb12-167"><a href="#cb12-167"></a><span class="ss">- </span>$\delta_t^h$: Time fixed effects (absorb common shocks)</span>
<span id="cb12-168"><a href="#cb12-168"></a><span class="ss">- </span>$\text{shock}_{it}$: The impulse of interest</span>
<span id="cb12-169"><a href="#cb12-169"></a><span class="ss">- </span>$\mathbf{X}_{it}$: Controls (lags of $y$, other variables)</span>
<span id="cb12-170"><a href="#cb12-170"></a></span>
<span id="cb12-171"><a href="#cb12-171"></a><span class="fu">## Implementation with fixest</span></span>
<span id="cb12-172"><a href="#cb12-172"></a></span>
<span id="cb12-175"><a href="#cb12-175"></a><span class="in">```{r}</span></span>
<span id="cb12-176"><a href="#cb12-176"></a><span class="co">#| label: lp-panel-setup</span></span>
<span id="cb12-177"><a href="#cb12-177"></a></span>
<span id="cb12-178"><a href="#cb12-178"></a><span class="co"># Generate synthetic panel data</span></span>
<span id="cb12-179"><a href="#cb12-179"></a>N <span class="ot">&lt;-</span> <span class="dv">30</span>  <span class="co"># countries</span></span>
<span id="cb12-180"><a href="#cb12-180"></a>T_obs <span class="ot">&lt;-</span> <span class="dv">60</span>  <span class="co"># quarters</span></span>
<span id="cb12-181"><a href="#cb12-181"></a></span>
<span id="cb12-182"><a href="#cb12-182"></a><span class="co"># Country fixed effects</span></span>
<span id="cb12-183"><a href="#cb12-183"></a>country_fe <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb12-184"><a href="#cb12-184"></a></span>
<span id="cb12-185"><a href="#cb12-185"></a><span class="co"># Generate panel</span></span>
<span id="cb12-186"><a href="#cb12-186"></a>panel_data <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb12-187"><a href="#cb12-187"></a>  <span class="at">country =</span> <span class="dv">1</span><span class="sc">:</span>N,</span>
<span id="cb12-188"><a href="#cb12-188"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_obs</span>
<span id="cb12-189"><a href="#cb12-189"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb12-190"><a href="#cb12-190"></a>  <span class="fu">arrange</span>(country, time) <span class="sc">%&gt;%</span></span>
<span id="cb12-191"><a href="#cb12-191"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-192"><a href="#cb12-192"></a>    <span class="co"># Country effect</span></span>
<span id="cb12-193"><a href="#cb12-193"></a>    <span class="at">alpha =</span> country_fe[country],</span>
<span id="cb12-194"><a href="#cb12-194"></a>    <span class="co"># Time trend + cycle</span></span>
<span id="cb12-195"><a href="#cb12-195"></a>    <span class="at">time_effect =</span> <span class="fl">0.02</span> <span class="sc">*</span> time <span class="sc">+</span> <span class="fu">sin</span>(time <span class="sc">/</span> <span class="dv">4</span>) <span class="sc">*</span> <span class="fl">0.5</span>,</span>
<span id="cb12-196"><a href="#cb12-196"></a>    <span class="co"># Shock (e.g., inflation surprise)</span></span>
<span id="cb12-197"><a href="#cb12-197"></a>    <span class="at">shock =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb12-198"><a href="#cb12-198"></a>    <span class="co"># Autoregressive outcome with shock response</span></span>
<span id="cb12-199"><a href="#cb12-199"></a>    <span class="at">y =</span> <span class="cn">NA_real_</span></span>
<span id="cb12-200"><a href="#cb12-200"></a>  )</span>
<span id="cb12-201"><a href="#cb12-201"></a></span>
<span id="cb12-202"><a href="#cb12-202"></a><span class="co"># Generate AR process with shock impact</span></span>
<span id="cb12-203"><a href="#cb12-203"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb12-204"><a href="#cb12-204"></a>  idx <span class="ot">&lt;-</span> <span class="fu">which</span>(panel_data<span class="sc">$</span>country <span class="sc">==</span> i)</span>
<span id="cb12-205"><a href="#cb12-205"></a>  y_country <span class="ot">&lt;-</span> <span class="fu">numeric</span>(T_obs)</span>
<span id="cb12-206"><a href="#cb12-206"></a></span>
<span id="cb12-207"><a href="#cb12-207"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>T_obs) {</span>
<span id="cb12-208"><a href="#cb12-208"></a>    <span class="co"># True DGP: y responds to shock with persistence</span></span>
<span id="cb12-209"><a href="#cb12-209"></a>    y_country[t] <span class="ot">&lt;-</span> <span class="fl">0.7</span> <span class="sc">*</span> y_country[t<span class="dv">-1</span>] <span class="sc">+</span></span>
<span id="cb12-210"><a href="#cb12-210"></a>                    <span class="fl">0.5</span> <span class="sc">*</span> panel_data<span class="sc">$</span>shock[idx[t]] <span class="sc">+</span>  <span class="co"># Immediate impact</span></span>
<span id="cb12-211"><a href="#cb12-211"></a>                    <span class="fl">0.3</span> <span class="sc">*</span> panel_data<span class="sc">$</span>shock[idx[t<span class="dv">-1</span>]] <span class="sc">+</span> <span class="co"># Delayed impact</span></span>
<span id="cb12-212"><a href="#cb12-212"></a>                    country_fe[i] <span class="sc">*</span> <span class="fl">0.1</span> <span class="sc">+</span></span>
<span id="cb12-213"><a href="#cb12-213"></a>                    <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.5</span>)</span>
<span id="cb12-214"><a href="#cb12-214"></a>  }</span>
<span id="cb12-215"><a href="#cb12-215"></a>  panel_data<span class="sc">$</span>y[idx] <span class="ot">&lt;-</span> y_country</span>
<span id="cb12-216"><a href="#cb12-216"></a>}</span>
<span id="cb12-217"><a href="#cb12-217"></a></span>
<span id="cb12-218"><a href="#cb12-218"></a><span class="co"># Convert to panel</span></span>
<span id="cb12-219"><a href="#cb12-219"></a>pdata <span class="ot">&lt;-</span> <span class="fu">panel</span>(panel_data, <span class="sc">~</span>country <span class="sc">+</span> time)</span>
<span id="cb12-220"><a href="#cb12-220"></a></span>
<span id="cb12-221"><a href="#cb12-221"></a><span class="fu">cat</span>(<span class="st">"Panel dimensions:"</span>, N, <span class="st">"countries,"</span>, T_obs, <span class="st">"periods</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-222"><a href="#cb12-222"></a><span class="in">```</span></span>
<span id="cb12-223"><a href="#cb12-223"></a></span>
<span id="cb12-226"><a href="#cb12-226"></a><span class="in">```{r}</span></span>
<span id="cb12-227"><a href="#cb12-227"></a><span class="co">#| label: lp-estimation</span></span>
<span id="cb12-228"><a href="#cb12-228"></a><span class="co">#| fig-cap: "Local Projection impulse responses with 95% confidence bands"</span></span>
<span id="cb12-229"><a href="#cb12-229"></a></span>
<span id="cb12-230"><a href="#cb12-230"></a><span class="co"># Estimate LP at each horizon</span></span>
<span id="cb12-231"><a href="#cb12-231"></a>H <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb12-232"><a href="#cb12-232"></a>results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-233"><a href="#cb12-233"></a>  <span class="at">horizon =</span> <span class="dv">0</span><span class="sc">:</span>H,</span>
<span id="cb12-234"><a href="#cb12-234"></a>  <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb12-235"><a href="#cb12-235"></a>  <span class="at">se =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb12-236"><a href="#cb12-236"></a>  <span class="at">ci_low =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb12-237"><a href="#cb12-237"></a>  <span class="at">ci_high =</span> <span class="cn">NA_real_</span></span>
<span id="cb12-238"><a href="#cb12-238"></a>)</span>
<span id="cb12-239"><a href="#cb12-239"></a></span>
<span id="cb12-240"><a href="#cb12-240"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H) {</span>
<span id="cb12-241"><a href="#cb12-241"></a>  <span class="co"># LP regression: y_{t+h} - y_{t-1} on shock_t</span></span>
<span id="cb12-242"><a href="#cb12-242"></a>  model <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb12-243"><a href="#cb12-243"></a>    <span class="fu">f</span>(y, h) <span class="sc">-</span> <span class="fu">l</span>(y, <span class="dv">1</span>) <span class="sc">~</span> shock <span class="sc">+</span> <span class="fu">l</span>(y, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">|</span> country <span class="sc">+</span> time,</span>
<span id="cb12-244"><a href="#cb12-244"></a>    <span class="at">data =</span> pdata,</span>
<span id="cb12-245"><a href="#cb12-245"></a>    <span class="at">vcov =</span> <span class="sc">~</span>country  <span class="co"># Cluster by country</span></span>
<span id="cb12-246"><a href="#cb12-246"></a>  )</span>
<span id="cb12-247"><a href="#cb12-247"></a></span>
<span id="cb12-248"><a href="#cb12-248"></a>  results<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model)[<span class="st">"shock"</span>]</span>
<span id="cb12-249"><a href="#cb12-249"></a>  results<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">se</span>(model)[<span class="st">"shock"</span>]</span>
<span id="cb12-250"><a href="#cb12-250"></a>  results<span class="sc">$</span>ci_low[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> results<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> results<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-251"><a href="#cb12-251"></a>  results<span class="sc">$</span>ci_high[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> results<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> results<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb12-252"><a href="#cb12-252"></a>}</span>
<span id="cb12-253"><a href="#cb12-253"></a></span>
<span id="cb12-254"><a href="#cb12-254"></a><span class="co"># Plot IRF</span></span>
<span id="cb12-255"><a href="#cb12-255"></a><span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb12-256"><a href="#cb12-256"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-257"><a href="#cb12-257"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_low, <span class="at">ymax =</span> ci_high), <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"#3498db"</span>) <span class="sc">+</span></span>
<span id="cb12-258"><a href="#cb12-258"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-259"><a href="#cb12-259"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-260"><a href="#cb12-260"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Local Projection: Response to Unit Shock"</span>,</span>
<span id="cb12-261"><a href="#cb12-261"></a>       <span class="at">subtitle =</span> <span class="st">"Cumulative response with 95% confidence bands (clustered by country)"</span>,</span>
<span id="cb12-262"><a href="#cb12-262"></a>       <span class="at">x =</span> <span class="st">"Horizon (periods)"</span>,</span>
<span id="cb12-263"><a href="#cb12-263"></a>       <span class="at">y =</span> <span class="st">"Cumulative Response"</span>) <span class="sc">+</span></span>
<span id="cb12-264"><a href="#cb12-264"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="dv">0</span><span class="sc">:</span>H)</span>
<span id="cb12-265"><a href="#cb12-265"></a><span class="in">```</span></span>
<span id="cb12-266"><a href="#cb12-266"></a></span>
<span id="cb12-267"><a href="#cb12-267"></a><span class="fu">## Inference: Why HAC/Clustering Matters</span></span>
<span id="cb12-268"><a href="#cb12-268"></a></span>
<span id="cb12-269"><a href="#cb12-269"></a>At horizon $h$, the LP residual $\varepsilon_{i,t+h}$ is correlated with $\varepsilon_{i,t+h-1}, \ldots, \varepsilon_{i,t+1}$ by construction (overlapping observations).</span>
<span id="cb12-270"><a href="#cb12-270"></a></span>
<span id="cb12-271"><a href="#cb12-271"></a>**This induces MA(h-1) serial correlation in errors.**</span>
<span id="cb12-272"><a href="#cb12-272"></a></span>
<span id="cb12-273"><a href="#cb12-273"></a>Standard OLS standard errors are **invalid**. Must use:</span>
<span id="cb12-274"><a href="#cb12-274"></a></span>
<span id="cb12-275"><a href="#cb12-275"></a><span class="pp">|</span> Method <span class="pp">|</span> When <span class="pp">|</span> Implementation <span class="pp">|</span></span>
<span id="cb12-276"><a href="#cb12-276"></a><span class="pp">|--------|------|----------------|</span></span>
<span id="cb12-277"><a href="#cb12-277"></a><span class="pp">|</span> Newey-West HAC <span class="pp">|</span> Time series <span class="pp">|</span> <span class="in">`sandwich::NeweyWest(lags = h)`</span> <span class="pp">|</span></span>
<span id="cb12-278"><a href="#cb12-278"></a><span class="pp">|</span> Cluster by unit <span class="pp">|</span> Panel, short T <span class="pp">|</span> <span class="in">`vcov = ~country`</span> <span class="pp">|</span></span>
<span id="cb12-279"><a href="#cb12-279"></a><span class="pp">|</span> Driscoll-Kraay <span class="pp">|</span> Panel, cross-sectional dependence <span class="pp">|</span> <span class="in">`vcov = "DK"`</span> in some packages <span class="pp">|</span></span>
<span id="cb12-280"><a href="#cb12-280"></a></span>
<span id="cb12-283"><a href="#cb12-283"></a><span class="in">```{r}</span></span>
<span id="cb12-284"><a href="#cb12-284"></a><span class="co">#| label: se-comparison</span></span>
<span id="cb12-285"><a href="#cb12-285"></a><span class="co">#| fig-cap: "Standard errors grow with horizon due to overlapping residuals"</span></span>
<span id="cb12-286"><a href="#cb12-286"></a></span>
<span id="cb12-287"><a href="#cb12-287"></a><span class="co"># Compare SE across horizons</span></span>
<span id="cb12-288"><a href="#cb12-288"></a>se_by_horizon <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-289"><a href="#cb12-289"></a>  <span class="at">horizon =</span> <span class="dv">0</span><span class="sc">:</span>H,</span>
<span id="cb12-290"><a href="#cb12-290"></a>  <span class="at">cluster_se =</span> results<span class="sc">$</span>se,</span>
<span id="cb12-291"><a href="#cb12-291"></a>  <span class="co"># For comparison, also compute OLS SE (wrong!)</span></span>
<span id="cb12-292"><a href="#cb12-292"></a>  <span class="at">ols_se =</span> <span class="cn">NA_real_</span></span>
<span id="cb12-293"><a href="#cb12-293"></a>)</span>
<span id="cb12-294"><a href="#cb12-294"></a></span>
<span id="cb12-295"><a href="#cb12-295"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H) {</span>
<span id="cb12-296"><a href="#cb12-296"></a>  model_ols <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb12-297"><a href="#cb12-297"></a>    <span class="fu">f</span>(y, h) <span class="sc">-</span> <span class="fu">l</span>(y, <span class="dv">1</span>) <span class="sc">~</span> shock <span class="sc">+</span> <span class="fu">l</span>(y, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">|</span> country <span class="sc">+</span> time,</span>
<span id="cb12-298"><a href="#cb12-298"></a>    <span class="at">data =</span> pdata,</span>
<span id="cb12-299"><a href="#cb12-299"></a>    <span class="at">vcov =</span> <span class="st">"iid"</span>  <span class="co"># Wrong but instructive</span></span>
<span id="cb12-300"><a href="#cb12-300"></a>  )</span>
<span id="cb12-301"><a href="#cb12-301"></a>  se_by_horizon<span class="sc">$</span>ols_se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_ols)[<span class="st">"shock"</span>]</span>
<span id="cb12-302"><a href="#cb12-302"></a>}</span>
<span id="cb12-303"><a href="#cb12-303"></a></span>
<span id="cb12-304"><a href="#cb12-304"></a>se_long <span class="ot">&lt;-</span> se_by_horizon <span class="sc">%&gt;%</span></span>
<span id="cb12-305"><a href="#cb12-305"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(cluster_se, ols_se),</span>
<span id="cb12-306"><a href="#cb12-306"></a>               <span class="at">names_to =</span> <span class="st">"method"</span>, <span class="at">values_to =</span> <span class="st">"se"</span>)</span>
<span id="cb12-307"><a href="#cb12-307"></a></span>
<span id="cb12-308"><a href="#cb12-308"></a><span class="fu">ggplot</span>(se_long, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> se, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb12-309"><a href="#cb12-309"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-310"><a href="#cb12-310"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-311"><a href="#cb12-311"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"cluster_se"</span> <span class="ot">=</span> <span class="st">"#2ecc71"</span>, <span class="st">"ols_se"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb12-312"><a href="#cb12-312"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Clustered (correct)"</span>, <span class="st">"IID (wrong)"</span>)) <span class="sc">+</span></span>
<span id="cb12-313"><a href="#cb12-313"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Standard Errors by Horizon"</span>,</span>
<span id="cb12-314"><a href="#cb12-314"></a>       <span class="at">subtitle =</span> <span class="st">"Clustered SEs account for serial correlation; IID SEs are too small"</span>,</span>
<span id="cb12-315"><a href="#cb12-315"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Standard Error"</span>,</span>
<span id="cb12-316"><a href="#cb12-316"></a>       <span class="at">color =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb12-317"><a href="#cb12-317"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb12-318"><a href="#cb12-318"></a><span class="in">```</span></span>
<span id="cb12-319"><a href="#cb12-319"></a></span>
<span id="cb12-320"><a href="#cb12-320"></a><span class="fu"># State-Dependent Local Projections {.unnumbered}</span></span>
<span id="cb12-321"><a href="#cb12-321"></a></span>
<span id="cb12-322"><a href="#cb12-322"></a>A major advantage of LP over VAR: it's easy to allow impulse responses to vary with the state of the economy.</span>
<span id="cb12-323"><a href="#cb12-323"></a></span>
<span id="cb12-324"><a href="#cb12-324"></a><span class="fu">## Binary State Switching</span></span>
<span id="cb12-325"><a href="#cb12-325"></a></span>
<span id="cb12-326"><a href="#cb12-326"></a>The simplest approach: interact the shock with a state indicator.</span>
<span id="cb12-327"><a href="#cb12-327"></a></span>
<span id="cb12-328"><a href="#cb12-328"></a>$$</span>
<span id="cb12-329"><a href="#cb12-329"></a>y_{i,t+h} - y_{i,t-1} = \alpha_i^h + \beta_0^h \cdot (1 - S_{it}) \cdot \text{shock}_{it} + \beta_1^h \cdot S_{it} \cdot \text{shock}_{it} + \cdots</span>
<span id="cb12-330"><a href="#cb12-330"></a>$$</span>
<span id="cb12-331"><a href="#cb12-331"></a></span>
<span id="cb12-332"><a href="#cb12-332"></a>where $S_{it} = 1$ if country $i$ is in "state 1" at time $t$.</span>
<span id="cb12-333"><a href="#cb12-333"></a></span>
<span id="cb12-334"><a href="#cb12-334"></a>**Examples of state variables:**</span>
<span id="cb12-335"><a href="#cb12-335"></a><span class="ss">- </span>Recession vs. expansion</span>
<span id="cb12-336"><a href="#cb12-336"></a><span class="ss">- </span>High vs. low debt</span>
<span id="cb12-337"><a href="#cb12-337"></a><span class="ss">- </span>Financial crisis vs. normal times</span>
<span id="cb12-338"><a href="#cb12-338"></a><span class="ss">- </span>High vs. low bank holdings of sovereign debt</span>
<span id="cb12-339"><a href="#cb12-339"></a></span>
<span id="cb12-342"><a href="#cb12-342"></a><span class="in">```{r}</span></span>
<span id="cb12-343"><a href="#cb12-343"></a><span class="co">#| label: state-dependent-lp</span></span>
<span id="cb12-344"><a href="#cb12-344"></a><span class="co">#| fig-cap: "State-dependent LP: Responses differ by regime"</span></span>
<span id="cb12-345"><a href="#cb12-345"></a></span>
<span id="cb12-346"><a href="#cb12-346"></a><span class="co"># Add state variable: high vs low initial shock exposure</span></span>
<span id="cb12-347"><a href="#cb12-347"></a>panel_data <span class="ot">&lt;-</span> panel_data <span class="sc">%&gt;%</span></span>
<span id="cb12-348"><a href="#cb12-348"></a>  <span class="fu">group_by</span>(country) <span class="sc">%&gt;%</span></span>
<span id="cb12-349"><a href="#cb12-349"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-350"><a href="#cb12-350"></a>    <span class="co"># State based on lagged cumulative shock exposure</span></span>
<span id="cb12-351"><a href="#cb12-351"></a>    <span class="at">cum_shock =</span> <span class="fu">cumsum</span>(shock),</span>
<span id="cb12-352"><a href="#cb12-352"></a>    <span class="at">high_state =</span> <span class="fu">as.integer</span>(<span class="fu">lag</span>(cum_shock, <span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fu">median</span>(<span class="fu">lag</span>(cum_shock, <span class="dv">1</span>), <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb12-353"><a href="#cb12-353"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb12-354"><a href="#cb12-354"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-355"><a href="#cb12-355"></a>  <span class="fu">mutate</span>(<span class="at">high_state =</span> <span class="fu">replace_na</span>(high_state, <span class="dv">0</span>))</span>
<span id="cb12-356"><a href="#cb12-356"></a></span>
<span id="cb12-357"><a href="#cb12-357"></a>pdata <span class="ot">&lt;-</span> <span class="fu">panel</span>(panel_data, <span class="sc">~</span>country <span class="sc">+</span> time)</span>
<span id="cb12-358"><a href="#cb12-358"></a></span>
<span id="cb12-359"><a href="#cb12-359"></a><span class="co"># Estimate state-dependent LP</span></span>
<span id="cb12-360"><a href="#cb12-360"></a>results_state <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-361"><a href="#cb12-361"></a>  <span class="at">horizon =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>H, <span class="dv">2</span>),</span>
<span id="cb12-362"><a href="#cb12-362"></a>  <span class="at">state =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Low"</span>, <span class="st">"High"</span>), <span class="at">each =</span> H <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb12-363"><a href="#cb12-363"></a>  <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb12-364"><a href="#cb12-364"></a>  <span class="at">se =</span> <span class="cn">NA_real_</span></span>
<span id="cb12-365"><a href="#cb12-365"></a>)</span>
<span id="cb12-366"><a href="#cb12-366"></a></span>
<span id="cb12-367"><a href="#cb12-367"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H) {</span>
<span id="cb12-368"><a href="#cb12-368"></a>  model_state <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb12-369"><a href="#cb12-369"></a>    <span class="fu">f</span>(y, h) <span class="sc">-</span> <span class="fu">l</span>(y, <span class="dv">1</span>) <span class="sc">~</span> <span class="fu">i</span>(high_state, shock) <span class="sc">+</span> <span class="fu">l</span>(y, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>) <span class="sc">|</span> country <span class="sc">+</span> time,</span>
<span id="cb12-370"><a href="#cb12-370"></a>    <span class="at">data =</span> pdata,</span>
<span id="cb12-371"><a href="#cb12-371"></a>    <span class="at">vcov =</span> <span class="sc">~</span>country</span>
<span id="cb12-372"><a href="#cb12-372"></a>  )</span>
<span id="cb12-373"><a href="#cb12-373"></a></span>
<span id="cb12-374"><a href="#cb12-374"></a>  <span class="co"># Extract coefficients for each state</span></span>
<span id="cb12-375"><a href="#cb12-375"></a>  coef_names <span class="ot">&lt;-</span> <span class="fu">names</span>(<span class="fu">coef</span>(model_state))</span>
<span id="cb12-376"><a href="#cb12-376"></a></span>
<span id="cb12-377"><a href="#cb12-377"></a>  <span class="co"># Low state (high_state = 0)</span></span>
<span id="cb12-378"><a href="#cb12-378"></a>  low_idx <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"high_state::0:shock"</span>, coef_names)</span>
<span id="cb12-379"><a href="#cb12-379"></a>  <span class="cf">if</span> (<span class="fu">length</span>(low_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb12-380"><a href="#cb12-380"></a>    results_state<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_state)[low_idx]</span>
<span id="cb12-381"><a href="#cb12-381"></a>    results_state<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_state)[low_idx]</span>
<span id="cb12-382"><a href="#cb12-382"></a>  }</span>
<span id="cb12-383"><a href="#cb12-383"></a></span>
<span id="cb12-384"><a href="#cb12-384"></a>  <span class="co"># High state (high_state = 1)</span></span>
<span id="cb12-385"><a href="#cb12-385"></a>  high_idx <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"high_state::1:shock"</span>, coef_names)</span>
<span id="cb12-386"><a href="#cb12-386"></a>  <span class="cf">if</span> (<span class="fu">length</span>(high_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb12-387"><a href="#cb12-387"></a>    results_state<span class="sc">$</span>estimate[H <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> h] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_state)[high_idx]</span>
<span id="cb12-388"><a href="#cb12-388"></a>    results_state<span class="sc">$</span>se[H <span class="sc">+</span> <span class="dv">2</span> <span class="sc">+</span> h] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_state)[high_idx]</span>
<span id="cb12-389"><a href="#cb12-389"></a>  }</span>
<span id="cb12-390"><a href="#cb12-390"></a>}</span>
<span id="cb12-391"><a href="#cb12-391"></a></span>
<span id="cb12-392"><a href="#cb12-392"></a>results_state <span class="ot">&lt;-</span> results_state <span class="sc">%&gt;%</span></span>
<span id="cb12-393"><a href="#cb12-393"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-394"><a href="#cb12-394"></a>    <span class="at">ci_low =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb12-395"><a href="#cb12-395"></a>    <span class="at">ci_high =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb12-396"><a href="#cb12-396"></a>  )</span>
<span id="cb12-397"><a href="#cb12-397"></a></span>
<span id="cb12-398"><a href="#cb12-398"></a><span class="fu">ggplot</span>(results_state, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> estimate, <span class="at">color =</span> state, <span class="at">fill =</span> state)) <span class="sc">+</span></span>
<span id="cb12-399"><a href="#cb12-399"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-400"><a href="#cb12-400"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_low, <span class="at">ymax =</span> ci_high), <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb12-401"><a href="#cb12-401"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-402"><a href="#cb12-402"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-403"><a href="#cb12-403"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Low"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>, <span class="st">"High"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb12-404"><a href="#cb12-404"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Low"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>, <span class="st">"High"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb12-405"><a href="#cb12-405"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"State-Dependent Impulse Responses"</span>,</span>
<span id="cb12-406"><a href="#cb12-406"></a>       <span class="at">subtitle =</span> <span class="st">"Response to shock differs by regime"</span>,</span>
<span id="cb12-407"><a href="#cb12-407"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Cumulative Response"</span>,</span>
<span id="cb12-408"><a href="#cb12-408"></a>       <span class="at">color =</span> <span class="st">"State"</span>, <span class="at">fill =</span> <span class="st">"State"</span>) <span class="sc">+</span></span>
<span id="cb12-409"><a href="#cb12-409"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb12-410"><a href="#cb12-410"></a><span class="in">```</span></span>
<span id="cb12-411"><a href="#cb12-411"></a></span>
<span id="cb12-412"><a href="#cb12-412"></a><span class="fu">## Smooth Transition (Auerbach-Gorodnichenko)</span></span>
<span id="cb12-413"><a href="#cb12-413"></a></span>
<span id="cb12-414"><a href="#cb12-414"></a>Instead of hard switching, use a logistic function for smooth transition:</span>
<span id="cb12-415"><a href="#cb12-415"></a></span>
<span id="cb12-416"><a href="#cb12-416"></a>$$</span>
<span id="cb12-417"><a href="#cb12-417"></a>F(z_t) = \frac{\exp(-\gamma z_t)}{1 + \exp(-\gamma z_t)}</span>
<span id="cb12-418"><a href="#cb12-418"></a>$$</span>
<span id="cb12-419"><a href="#cb12-419"></a></span>
<span id="cb12-420"><a href="#cb12-420"></a>where:</span>
<span id="cb12-421"><a href="#cb12-421"></a><span class="ss">- </span>$z_t$ is the (standardized) state variable</span>
<span id="cb12-422"><a href="#cb12-422"></a><span class="ss">- </span>$\gamma &gt; 0$ controls transition speed</span>
<span id="cb12-423"><a href="#cb12-423"></a><span class="ss">- </span>$F(z_t) \to 1$ when $z_t \to -\infty$ (e.g., deep recession)</span>
<span id="cb12-424"><a href="#cb12-424"></a><span class="ss">- </span>$F(z_t) \to 0$ when $z_t \to +\infty$ (e.g., strong expansion)</span>
<span id="cb12-425"><a href="#cb12-425"></a></span>
<span id="cb12-426"><a href="#cb12-426"></a>The LP specification becomes:</span>
<span id="cb12-427"><a href="#cb12-427"></a></span>
<span id="cb12-428"><a href="#cb12-428"></a>$$</span>
<span id="cb12-429"><a href="#cb12-429"></a>y_{t+h} = F(z_{t-1}) \cdot <span class="co">[</span><span class="ot">\alpha_R^h + \beta_R^h \cdot \text{shock}_t</span><span class="co">]</span> + (1 - F(z_{t-1})) \cdot <span class="co">[</span><span class="ot">\alpha_E^h + \beta_E^h \cdot \text{shock}_t</span><span class="co">]</span> + \cdots</span>
<span id="cb12-430"><a href="#cb12-430"></a>$$</span>
<span id="cb12-431"><a href="#cb12-431"></a></span>
<span id="cb12-434"><a href="#cb12-434"></a><span class="in">```{r}</span></span>
<span id="cb12-435"><a href="#cb12-435"></a><span class="co">#| label: smooth-transition</span></span>
<span id="cb12-436"><a href="#cb12-436"></a><span class="co">#| fig-cap: "Smooth transition function for state-dependent LP"</span></span>
<span id="cb12-437"><a href="#cb12-437"></a></span>
<span id="cb12-438"><a href="#cb12-438"></a><span class="co"># Demonstrate the logistic transition function</span></span>
<span id="cb12-439"><a href="#cb12-439"></a>z <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb12-440"><a href="#cb12-440"></a>gamma_values <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>)</span>
<span id="cb12-441"><a href="#cb12-441"></a></span>
<span id="cb12-442"><a href="#cb12-442"></a>transition_df <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">z =</span> z, <span class="at">gamma =</span> gamma_values) <span class="sc">%&gt;%</span></span>
<span id="cb12-443"><a href="#cb12-443"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-444"><a href="#cb12-444"></a>    <span class="at">F_z =</span> <span class="fu">exp</span>(<span class="sc">-</span>gamma <span class="sc">*</span> z) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>gamma <span class="sc">*</span> z)),</span>
<span id="cb12-445"><a href="#cb12-445"></a>    <span class="at">gamma_label =</span> <span class="fu">paste</span>(<span class="st">"γ ="</span>, gamma)</span>
<span id="cb12-446"><a href="#cb12-446"></a>  )</span>
<span id="cb12-447"><a href="#cb12-447"></a></span>
<span id="cb12-448"><a href="#cb12-448"></a><span class="fu">ggplot</span>(transition_df, <span class="fu">aes</span>(<span class="at">x =</span> z, <span class="at">y =</span> F_z, <span class="at">color =</span> gamma_label)) <span class="sc">+</span></span>
<span id="cb12-449"><a href="#cb12-449"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-450"><a href="#cb12-450"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb12-451"><a href="#cb12-451"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb12-452"><a href="#cb12-452"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Logistic Transition Function"</span>,</span>
<span id="cb12-453"><a href="#cb12-453"></a>       <span class="at">subtitle =</span> <span class="st">"Higher γ = sharper transition between regimes"</span>,</span>
<span id="cb12-454"><a href="#cb12-454"></a>       <span class="at">x =</span> <span class="st">"Standardized State Variable (z)"</span>,</span>
<span id="cb12-455"><a href="#cb12-455"></a>       <span class="at">y =</span> <span class="st">"F(z) = Probability of 'Recession' Regime"</span>,</span>
<span id="cb12-456"><a href="#cb12-456"></a>       <span class="at">color =</span> <span class="st">"Smoothness"</span>) <span class="sc">+</span></span>
<span id="cb12-457"><a href="#cb12-457"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">y =</span> <span class="fl">0.9</span>, <span class="at">label =</span> <span class="st">"Recession</span><span class="sc">\n</span><span class="st">regime"</span>) <span class="sc">+</span></span>
<span id="cb12-458"><a href="#cb12-458"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="fl">0.1</span>, <span class="at">label =</span> <span class="st">"Expansion</span><span class="sc">\n</span><span class="st">regime"</span>) <span class="sc">+</span></span>
<span id="cb12-459"><a href="#cb12-459"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb12-460"><a href="#cb12-460"></a><span class="in">```</span></span>
<span id="cb12-461"><a href="#cb12-461"></a></span>
<span id="cb12-462"><a href="#cb12-462"></a><span class="fu">## Testing for State Dependence</span></span>
<span id="cb12-463"><a href="#cb12-463"></a></span>
<span id="cb12-464"><a href="#cb12-464"></a>To test whether responses genuinely differ across states:</span>
<span id="cb12-465"><a href="#cb12-465"></a></span>
<span id="cb12-466"><a href="#cb12-466"></a>$$</span>
<span id="cb12-467"><a href="#cb12-467"></a>H_0: \beta_0^h = \beta_1^h \quad \forall h</span>
<span id="cb12-468"><a href="#cb12-468"></a>$$</span>
<span id="cb12-469"><a href="#cb12-469"></a></span>
<span id="cb12-470"><a href="#cb12-470"></a>**Methods:**</span>
<span id="cb12-471"><a href="#cb12-471"></a><span class="ss">1. </span>**Joint F-test**: Test equality of coefficients across horizons</span>
<span id="cb12-472"><a href="#cb12-472"></a><span class="ss">2. </span>**Horizon-by-horizon t-tests**: Test $\beta_0^h - \beta_1^h = 0$ at each $h$</span>
<span id="cb12-473"><a href="#cb12-473"></a><span class="ss">3. </span>**Cumulative difference**: Test whether cumulative response differs</span>
<span id="cb12-474"><a href="#cb12-474"></a></span>
<span id="cb12-475"><a href="#cb12-475"></a>::: {.callout-warning}</span>
<span id="cb12-476"><a href="#cb12-476"></a><span class="fu">## Common Mistake</span></span>
<span id="cb12-477"><a href="#cb12-477"></a>Showing that $\beta_0^h$ is significant and $\beta_1^h$ is not significant does NOT prove they're different. You must test the **difference** directly.</span>
<span id="cb12-478"><a href="#cb12-478"></a>:::</span>
<span id="cb12-479"><a href="#cb12-479"></a></span>
<span id="cb12-480"><a href="#cb12-480"></a><span class="fu"># LP-DiD: Combining LP with Difference-in-Differences {.unnumbered}</span></span>
<span id="cb12-481"><a href="#cb12-481"></a></span>
<span id="cb12-482"><a href="#cb12-482"></a>LP-DiD (Jordà, Dube, Girardi &amp; Taylor, 2024) extends local projections to treatment effect settings with staggered adoption.</span>
<span id="cb12-483"><a href="#cb12-483"></a></span>
<span id="cb12-484"><a href="#cb12-484"></a><span class="fu">## The Setting</span></span>
<span id="cb12-485"><a href="#cb12-485"></a></span>
<span id="cb12-486"><a href="#cb12-486"></a><span class="ss">- </span>Some units receive treatment at different times</span>
<span id="cb12-487"><a href="#cb12-487"></a><span class="ss">- </span>We want to trace out the **dynamic treatment effect** at each horizon</span>
<span id="cb12-488"><a href="#cb12-488"></a><span class="ss">- </span>Standard DiD gives one number; LP-DiD gives a path</span>
<span id="cb12-489"><a href="#cb12-489"></a></span>
<span id="cb12-490"><a href="#cb12-490"></a><span class="fu">## The Specification</span></span>
<span id="cb12-491"><a href="#cb12-491"></a></span>
<span id="cb12-492"><a href="#cb12-492"></a>$$</span>
<span id="cb12-493"><a href="#cb12-493"></a>y_{i,t+h} - y_{i,t-1} = \alpha_i + \delta_t + \beta^h \cdot D_{it} + \mathbf{X}_{it}'\boldsymbol{\gamma}^h + \varepsilon_{i,t+h}</span>
<span id="cb12-494"><a href="#cb12-494"></a>$$</span>
<span id="cb12-495"><a href="#cb12-495"></a></span>
<span id="cb12-496"><a href="#cb12-496"></a>where:</span>
<span id="cb12-497"><a href="#cb12-497"></a><span class="ss">- </span>$D_{it} = 1$ if unit $i$ is treated at time $t$</span>
<span id="cb12-498"><a href="#cb12-498"></a><span class="ss">- </span>$\alpha_i$ = unit fixed effects</span>
<span id="cb12-499"><a href="#cb12-499"></a><span class="ss">- </span>$\delta_t$ = time fixed effects</span>
<span id="cb12-500"><a href="#cb12-500"></a><span class="ss">- </span>$\beta^h$ = treatment effect at horizon $h$</span>
<span id="cb12-501"><a href="#cb12-501"></a></span>
<span id="cb12-502"><a href="#cb12-502"></a>**Key features:**</span>
<span id="cb12-503"><a href="#cb12-503"></a><span class="ss">- </span>Estimates treatment effect at each horizon (not just one average)</span>
<span id="cb12-504"><a href="#cb12-504"></a><span class="ss">- </span>Includes negative horizons to test pre-trends</span>
<span id="cb12-505"><a href="#cb12-505"></a><span class="ss">- </span>Robust to heterogeneous treatment timing</span>
<span id="cb12-506"><a href="#cb12-506"></a></span>
<span id="cb12-509"><a href="#cb12-509"></a><span class="in">```{r}</span></span>
<span id="cb12-510"><a href="#cb12-510"></a><span class="co">#| label: lp-did-simulation</span></span>
<span id="cb12-511"><a href="#cb12-511"></a><span class="co">#| fig-cap: "LP-DiD: Dynamic treatment effects with pre-trend check"</span></span>
<span id="cb12-512"><a href="#cb12-512"></a></span>
<span id="cb12-513"><a href="#cb12-513"></a><span class="co"># Simulate LP-DiD setting (simplified: single treatment time)</span></span>
<span id="cb12-514"><a href="#cb12-514"></a>N_did <span class="ot">&lt;-</span> <span class="dv">40</span></span>
<span id="cb12-515"><a href="#cb12-515"></a>T_did <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb12-516"><a href="#cb12-516"></a>T_treat <span class="ot">&lt;-</span> <span class="dv">15</span>  <span class="co"># Treatment at period 15</span></span>
<span id="cb12-517"><a href="#cb12-517"></a></span>
<span id="cb12-518"><a href="#cb12-518"></a><span class="co"># Generate unit fixed effects</span></span>
<span id="cb12-519"><a href="#cb12-519"></a>unit_fe <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N_did, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb12-520"><a href="#cb12-520"></a>time_fe <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="sc">*</span> (<span class="dv">1</span><span class="sc">:</span>T_did) <span class="sc">+</span> <span class="fu">rnorm</span>(T_did, <span class="dv">0</span>, <span class="fl">0.3</span>)</span>
<span id="cb12-521"><a href="#cb12-521"></a></span>
<span id="cb12-522"><a href="#cb12-522"></a>did_data <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb12-523"><a href="#cb12-523"></a>  <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span>N_did,</span>
<span id="cb12-524"><a href="#cb12-524"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_did</span>
<span id="cb12-525"><a href="#cb12-525"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb12-526"><a href="#cb12-526"></a>  <span class="fu">arrange</span>(unit, time) <span class="sc">%&gt;%</span></span>
<span id="cb12-527"><a href="#cb12-527"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-528"><a href="#cb12-528"></a>    <span class="co"># First 20 units are treated, rest are control</span></span>
<span id="cb12-529"><a href="#cb12-529"></a>    <span class="at">treated_unit =</span> unit <span class="sc">&lt;=</span> <span class="dv">20</span>,</span>
<span id="cb12-530"><a href="#cb12-530"></a>    <span class="at">post =</span> time <span class="sc">&gt;=</span> T_treat,</span>
<span id="cb12-531"><a href="#cb12-531"></a>    <span class="at">treated =</span> treated_unit <span class="sc">&amp;</span> post,</span>
<span id="cb12-532"><a href="#cb12-532"></a>    <span class="at">rel_time =</span> <span class="fu">ifelse</span>(treated_unit, time <span class="sc">-</span> T_treat, <span class="cn">NA</span>),</span>
<span id="cb12-533"><a href="#cb12-533"></a>    <span class="co"># Fixed effects</span></span>
<span id="cb12-534"><a href="#cb12-534"></a>    <span class="at">unit_effect =</span> unit_fe[unit],</span>
<span id="cb12-535"><a href="#cb12-535"></a>    <span class="at">time_effect =</span> time_fe[time],</span>
<span id="cb12-536"><a href="#cb12-536"></a>    <span class="co"># True treatment effect builds over time (max at +5)</span></span>
<span id="cb12-537"><a href="#cb12-537"></a>    <span class="at">true_effect =</span> <span class="fu">ifelse</span>(treated, <span class="fu">pmin</span>(time <span class="sc">-</span> T_treat <span class="sc">+</span> <span class="dv">1</span>, <span class="dv">5</span>) <span class="sc">*</span> <span class="fl">0.4</span>, <span class="dv">0</span>),</span>
<span id="cb12-538"><a href="#cb12-538"></a>    <span class="at">y =</span> unit_effect <span class="sc">+</span> time_effect <span class="sc">+</span> true_effect <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="fl">0.8</span>)</span>
<span id="cb12-539"><a href="#cb12-539"></a>  )</span>
<span id="cb12-540"><a href="#cb12-540"></a></span>
<span id="cb12-541"><a href="#cb12-541"></a><span class="co"># Estimate LP-DiD at each horizon</span></span>
<span id="cb12-542"><a href="#cb12-542"></a>H_did <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb12-543"><a href="#cb12-543"></a>lp_did_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-544"><a href="#cb12-544"></a>  <span class="at">horizon =</span> <span class="dv">0</span><span class="sc">:</span>H_did,</span>
<span id="cb12-545"><a href="#cb12-545"></a>  <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb12-546"><a href="#cb12-546"></a>  <span class="at">se =</span> <span class="cn">NA_real_</span></span>
<span id="cb12-547"><a href="#cb12-547"></a>)</span>
<span id="cb12-548"><a href="#cb12-548"></a></span>
<span id="cb12-549"><a href="#cb12-549"></a><span class="cf">for</span> (h <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span>H_did) {</span>
<span id="cb12-550"><a href="#cb12-550"></a>  <span class="co"># Create lead of y manually</span></span>
<span id="cb12-551"><a href="#cb12-551"></a>  did_data_h <span class="ot">&lt;-</span> did_data <span class="sc">%&gt;%</span></span>
<span id="cb12-552"><a href="#cb12-552"></a>    <span class="fu">group_by</span>(unit) <span class="sc">%&gt;%</span></span>
<span id="cb12-553"><a href="#cb12-553"></a>    <span class="fu">mutate</span>(</span>
<span id="cb12-554"><a href="#cb12-554"></a>      <span class="at">y_lead =</span> <span class="fu">lead</span>(y, h),</span>
<span id="cb12-555"><a href="#cb12-555"></a>      <span class="at">y_lag =</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)</span>
<span id="cb12-556"><a href="#cb12-556"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-557"><a href="#cb12-557"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-558"><a href="#cb12-558"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(y_lead) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_lag))</span>
<span id="cb12-559"><a href="#cb12-559"></a></span>
<span id="cb12-560"><a href="#cb12-560"></a>  model_did <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb12-561"><a href="#cb12-561"></a>    y_lead <span class="sc">-</span> y_lag <span class="sc">~</span> treated <span class="sc">|</span> unit <span class="sc">+</span> time,</span>
<span id="cb12-562"><a href="#cb12-562"></a>    <span class="at">data =</span> did_data_h,</span>
<span id="cb12-563"><a href="#cb12-563"></a>    <span class="at">vcov =</span> <span class="sc">~</span>unit</span>
<span id="cb12-564"><a href="#cb12-564"></a>  )</span>
<span id="cb12-565"><a href="#cb12-565"></a></span>
<span id="cb12-566"><a href="#cb12-566"></a>  lp_did_results<span class="sc">$</span>estimate[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_did)[<span class="st">"treatedTRUE"</span>]</span>
<span id="cb12-567"><a href="#cb12-567"></a>  lp_did_results<span class="sc">$</span>se[h <span class="sc">+</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_did)[<span class="st">"treatedTRUE"</span>]</span>
<span id="cb12-568"><a href="#cb12-568"></a>}</span>
<span id="cb12-569"><a href="#cb12-569"></a></span>
<span id="cb12-570"><a href="#cb12-570"></a>lp_did_results <span class="ot">&lt;-</span> lp_did_results <span class="sc">%&gt;%</span></span>
<span id="cb12-571"><a href="#cb12-571"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-572"><a href="#cb12-572"></a>    <span class="at">ci_low =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se,</span>
<span id="cb12-573"><a href="#cb12-573"></a>    <span class="at">ci_high =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se</span>
<span id="cb12-574"><a href="#cb12-574"></a>  )</span>
<span id="cb12-575"><a href="#cb12-575"></a></span>
<span id="cb12-576"><a href="#cb12-576"></a><span class="co"># Also compute pre-trend check (negative horizons)</span></span>
<span id="cb12-577"><a href="#cb12-577"></a><span class="co"># For pre-trends, we test whether treated units had different growth rates</span></span>
<span id="cb12-578"><a href="#cb12-578"></a><span class="co"># before treatment. Since treated_unit is time-invariant, we use time FE only</span></span>
<span id="cb12-579"><a href="#cb12-579"></a><span class="co"># (not unit FE) to avoid collinearity.</span></span>
<span id="cb12-580"><a href="#cb12-580"></a>pre_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-581"><a href="#cb12-581"></a>  <span class="at">horizon =</span> (<span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb12-582"><a href="#cb12-582"></a>  <span class="at">estimate =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb12-583"><a href="#cb12-583"></a>  <span class="at">se =</span> <span class="cn">NA_real_</span></span>
<span id="cb12-584"><a href="#cb12-584"></a>)</span>
<span id="cb12-585"><a href="#cb12-585"></a></span>
<span id="cb12-586"><a href="#cb12-586"></a><span class="cf">for</span> (h <span class="cf">in</span> (<span class="sc">-</span><span class="dv">4</span>)<span class="sc">:</span>(<span class="sc">-</span><span class="dv">1</span>)) {</span>
<span id="cb12-587"><a href="#cb12-587"></a>  did_data_h <span class="ot">&lt;-</span> did_data <span class="sc">%&gt;%</span></span>
<span id="cb12-588"><a href="#cb12-588"></a>    <span class="fu">filter</span>(time <span class="sc">&lt;</span> T_treat) <span class="sc">%&gt;%</span>  <span class="co"># Pre-treatment only</span></span>
<span id="cb12-589"><a href="#cb12-589"></a>    <span class="fu">group_by</span>(unit) <span class="sc">%&gt;%</span></span>
<span id="cb12-590"><a href="#cb12-590"></a>    <span class="fu">mutate</span>(</span>
<span id="cb12-591"><a href="#cb12-591"></a>      <span class="at">y_lead =</span> <span class="fu">lead</span>(y, <span class="sc">-</span>h),  <span class="co"># Note: negative h means lag</span></span>
<span id="cb12-592"><a href="#cb12-592"></a>      <span class="at">y_lag =</span> <span class="fu">lag</span>(y, <span class="dv">1</span>)</span>
<span id="cb12-593"><a href="#cb12-593"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb12-594"><a href="#cb12-594"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-595"><a href="#cb12-595"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(y_lead) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(y_lag))</span>
<span id="cb12-596"><a href="#cb12-596"></a></span>
<span id="cb12-597"><a href="#cb12-597"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(did_data_h) <span class="sc">&gt;</span> <span class="dv">50</span>) {</span>
<span id="cb12-598"><a href="#cb12-598"></a>    <span class="co"># Use time FE only for pre-trends (treated_unit is unit-level, collinear with unit FE)</span></span>
<span id="cb12-599"><a href="#cb12-599"></a>    <span class="co"># This tests: did treated units have different GROWTH before treatment?</span></span>
<span id="cb12-600"><a href="#cb12-600"></a>    model_pre <span class="ot">&lt;-</span> <span class="fu">feols</span>(</span>
<span id="cb12-601"><a href="#cb12-601"></a>      y_lead <span class="sc">-</span> y_lag <span class="sc">~</span> treated_unit <span class="sc">|</span> time,</span>
<span id="cb12-602"><a href="#cb12-602"></a>      <span class="at">data =</span> did_data_h,</span>
<span id="cb12-603"><a href="#cb12-603"></a>      <span class="at">vcov =</span> <span class="sc">~</span>unit</span>
<span id="cb12-604"><a href="#cb12-604"></a>    )</span>
<span id="cb12-605"><a href="#cb12-605"></a>    idx <span class="ot">&lt;-</span> h <span class="sc">+</span> <span class="dv">5</span></span>
<span id="cb12-606"><a href="#cb12-606"></a>    pre_results<span class="sc">$</span>estimate[idx] <span class="ot">&lt;-</span> <span class="fu">coef</span>(model_pre)[<span class="st">"treated_unitTRUE"</span>]</span>
<span id="cb12-607"><a href="#cb12-607"></a>    pre_results<span class="sc">$</span>se[idx] <span class="ot">&lt;-</span> <span class="fu">se</span>(model_pre)[<span class="st">"treated_unitTRUE"</span>]</span>
<span id="cb12-608"><a href="#cb12-608"></a>  }</span>
<span id="cb12-609"><a href="#cb12-609"></a>}</span>
<span id="cb12-610"><a href="#cb12-610"></a></span>
<span id="cb12-611"><a href="#cb12-611"></a>pre_results <span class="ot">&lt;-</span> pre_results <span class="sc">%&gt;%</span></span>
<span id="cb12-612"><a href="#cb12-612"></a>  <span class="fu">mutate</span>(<span class="at">ci_low =</span> estimate <span class="sc">-</span> <span class="fl">1.96</span> <span class="sc">*</span> se, <span class="at">ci_high =</span> estimate <span class="sc">+</span> <span class="fl">1.96</span> <span class="sc">*</span> se)</span>
<span id="cb12-613"><a href="#cb12-613"></a></span>
<span id="cb12-614"><a href="#cb12-614"></a><span class="co"># Combine</span></span>
<span id="cb12-615"><a href="#cb12-615"></a>all_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb12-616"><a href="#cb12-616"></a>  pre_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">period =</span> <span class="st">"Pre-treatment"</span>),</span>
<span id="cb12-617"><a href="#cb12-617"></a>  lp_did_results <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">period =</span> <span class="st">"Post-treatment"</span>)</span>
<span id="cb12-618"><a href="#cb12-618"></a>)</span>
<span id="cb12-619"><a href="#cb12-619"></a></span>
<span id="cb12-620"><a href="#cb12-620"></a><span class="fu">ggplot</span>(all_results, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb12-621"><a href="#cb12-621"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-622"><a href="#cb12-622"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-623"><a href="#cb12-623"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ci_low, <span class="at">ymax =</span> ci_high, <span class="at">fill =</span> period), <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb12-624"><a href="#cb12-624"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">color =</span> period), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-625"><a href="#cb12-625"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> period), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-626"><a href="#cb12-626"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-treatment"</span> <span class="ot">=</span> <span class="st">"#95a5a6"</span>, <span class="st">"Post-treatment"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb12-627"><a href="#cb12-627"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Pre-treatment"</span> <span class="ot">=</span> <span class="st">"#95a5a6"</span>, <span class="st">"Post-treatment"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb12-628"><a href="#cb12-628"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LP-DiD: Dynamic Treatment Effects"</span>,</span>
<span id="cb12-629"><a href="#cb12-629"></a>       <span class="at">subtitle =</span> <span class="st">"Pre-treatment coefficients test parallel trends"</span>,</span>
<span id="cb12-630"><a href="#cb12-630"></a>       <span class="at">x =</span> <span class="st">"Horizon (periods relative to treatment)"</span>,</span>
<span id="cb12-631"><a href="#cb12-631"></a>       <span class="at">y =</span> <span class="st">"Treatment Effect"</span>,</span>
<span id="cb12-632"><a href="#cb12-632"></a>       <span class="at">color =</span> <span class="st">"Period"</span>, <span class="at">fill =</span> <span class="st">"Period"</span>) <span class="sc">+</span></span>
<span id="cb12-633"><a href="#cb12-633"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="sc">-</span><span class="fl">2.5</span>, <span class="at">y =</span> <span class="fl">0.3</span>, <span class="at">label =</span> <span class="st">"Pre-trends</span><span class="sc">\n</span><span class="st">(≈ 0)"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb12-634"><a href="#cb12-634"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="st">"Treatment</span><span class="sc">\n</span><span class="st">effect builds"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb12-635"><a href="#cb12-635"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb12-636"><a href="#cb12-636"></a><span class="in">```</span></span>
<span id="cb12-637"><a href="#cb12-637"></a></span>
<span id="cb12-638"><a href="#cb12-638"></a><span class="fu">## LP-DiD vs. Standard Event Study</span></span>
<span id="cb12-639"><a href="#cb12-639"></a></span>
<span id="cb12-640"><a href="#cb12-640"></a><span class="pp">|</span> Feature <span class="pp">|</span> Standard Event Study <span class="pp">|</span> LP-DiD <span class="pp">|</span></span>
<span id="cb12-641"><a href="#cb12-641"></a><span class="pp">|---------|---------------------|--------|</span></span>
<span id="cb12-642"><a href="#cb12-642"></a><span class="pp">|</span> LHS <span class="pp">|</span> $y_{it}$ <span class="pp">|</span> $y_{i,t+h} - y_{i,t-1}$ <span class="pp">|</span></span>
<span id="cb12-643"><a href="#cb12-643"></a><span class="pp">|</span> Interpretation <span class="pp">|</span> Level relative to $t=-1$ <span class="pp">|</span> Cumulative change <span class="pp">|</span></span>
<span id="cb12-644"><a href="#cb12-644"></a><span class="pp">|</span> Horizons <span class="pp">|</span> Relative time dummies <span class="pp">|</span> Direct projection <span class="pp">|</span></span>
<span id="cb12-645"><a href="#cb12-645"></a><span class="pp">|</span> Handles dynamics <span class="pp">|</span> Imposes structure <span class="pp">|</span> Flexible <span class="pp">|</span></span>
<span id="cb12-646"><a href="#cb12-646"></a></span>
<span id="cb12-647"><a href="#cb12-647"></a>LP-DiD is particularly useful when:</span>
<span id="cb12-648"><a href="#cb12-648"></a><span class="ss">- </span>Treatment effects build gradually</span>
<span id="cb12-649"><a href="#cb12-649"></a><span class="ss">- </span>You want impulse response interpretation</span>
<span id="cb12-650"><a href="#cb12-650"></a><span class="ss">- </span>Dynamics are complex or nonlinear</span>
<span id="cb12-651"><a href="#cb12-651"></a></span>
<span id="cb12-652"><a href="#cb12-652"></a><span class="fu"># Diagnostics and Practical Issues {.unnumbered}</span></span>
<span id="cb12-653"><a href="#cb12-653"></a></span>
<span id="cb12-654"><a href="#cb12-654"></a><span class="fu">## Sample Erosion at Long Horizons</span></span>
<span id="cb12-655"><a href="#cb12-655"></a></span>
<span id="cb12-656"><a href="#cb12-656"></a>At horizon $h$, you lose $h$ observations from the end of your sample:</span>
<span id="cb12-657"><a href="#cb12-657"></a><span class="ss">- </span>$h = 0$: Full sample</span>
<span id="cb12-658"><a href="#cb12-658"></a><span class="ss">- </span>$h = 12$: Lose 12 periods (3 years of quarterly data)</span>
<span id="cb12-659"><a href="#cb12-659"></a></span>
<span id="cb12-662"><a href="#cb12-662"></a><span class="in">```{r}</span></span>
<span id="cb12-663"><a href="#cb12-663"></a><span class="co">#| label: sample-erosion</span></span>
<span id="cb12-664"><a href="#cb12-664"></a></span>
<span id="cb12-665"><a href="#cb12-665"></a>sample_sizes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-666"><a href="#cb12-666"></a>  <span class="at">horizon =</span> <span class="dv">0</span><span class="sc">:</span>H,</span>
<span id="cb12-667"><a href="#cb12-667"></a>  <span class="at">n_obs =</span> <span class="fu">sapply</span>(<span class="dv">0</span><span class="sc">:</span>H, <span class="cf">function</span>(h) {</span>
<span id="cb12-668"><a href="#cb12-668"></a>    <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(panel_data<span class="sc">$</span>y) <span class="sc">&amp;</span></span>
<span id="cb12-669"><a href="#cb12-669"></a>        (panel_data<span class="sc">$</span>time <span class="sc">&lt;=</span> T_obs <span class="sc">-</span> h) <span class="sc">&amp;</span></span>
<span id="cb12-670"><a href="#cb12-670"></a>        (panel_data<span class="sc">$</span>time <span class="sc">&gt;</span> <span class="dv">2</span>))</span>
<span id="cb12-671"><a href="#cb12-671"></a>  })</span>
<span id="cb12-672"><a href="#cb12-672"></a>)</span>
<span id="cb12-673"><a href="#cb12-673"></a></span>
<span id="cb12-674"><a href="#cb12-674"></a><span class="fu">ggplot</span>(sample_sizes, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> n_obs)) <span class="sc">+</span></span>
<span id="cb12-675"><a href="#cb12-675"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"#9b59b6"</span>) <span class="sc">+</span></span>
<span id="cb12-676"><a href="#cb12-676"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"#9b59b6"</span>) <span class="sc">+</span></span>
<span id="cb12-677"><a href="#cb12-677"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Sample Size by Horizon"</span>,</span>
<span id="cb12-678"><a href="#cb12-678"></a>       <span class="at">subtitle =</span> <span class="st">"Sample shrinks as horizon increases"</span>,</span>
<span id="cb12-679"><a href="#cb12-679"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Number of Observations"</span>) <span class="sc">+</span></span>
<span id="cb12-680"><a href="#cb12-680"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> scales<span class="sc">::</span>comma)</span>
<span id="cb12-681"><a href="#cb12-681"></a><span class="in">```</span></span>
<span id="cb12-682"><a href="#cb12-682"></a></span>
<span id="cb12-683"><a href="#cb12-683"></a>**Implications:**</span>
<span id="cb12-684"><a href="#cb12-684"></a><span class="ss">- </span>Confidence intervals widen at longer horizons (less data + more uncertainty)</span>
<span id="cb12-685"><a href="#cb12-685"></a><span class="ss">- </span>Truncate horizons when CIs become uninformative</span>
<span id="cb12-686"><a href="#cb12-686"></a><span class="ss">- </span>Report effective sample size at each horizon</span>
<span id="cb12-687"><a href="#cb12-687"></a></span>
<span id="cb12-688"><a href="#cb12-688"></a><span class="fu">## Lag Selection</span></span>
<span id="cb12-689"><a href="#cb12-689"></a></span>
<span id="cb12-690"><a href="#cb12-690"></a>**Rule:** Use the **same lag structure across all horizons** for comparability.</span>
<span id="cb12-691"><a href="#cb12-691"></a></span>
<span id="cb12-692"><a href="#cb12-692"></a>Methods:</span>
<span id="cb12-693"><a href="#cb12-693"></a><span class="ss">1. </span>Information criteria (AIC, BIC) on the $h = 0$ regression</span>
<span id="cb12-694"><a href="#cb12-694"></a><span class="ss">2. </span>LM test for serial correlation in residuals</span>
<span id="cb12-695"><a href="#cb12-695"></a><span class="ss">3. </span>Rule of thumb: 2-4 lags for quarterly, 1-2 for annual</span>
<span id="cb12-696"><a href="#cb12-696"></a></span>
<span id="cb12-699"><a href="#cb12-699"></a><span class="in">```{r}</span></span>
<span id="cb12-700"><a href="#cb12-700"></a><span class="co">#| label: lag-selection</span></span>
<span id="cb12-701"><a href="#cb12-701"></a></span>
<span id="cb12-702"><a href="#cb12-702"></a><span class="co"># Compare different lag specifications at h = 4</span></span>
<span id="cb12-703"><a href="#cb12-703"></a>lag_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-704"><a href="#cb12-704"></a>  <span class="at">lags =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb12-705"><a href="#cb12-705"></a>  <span class="at">aic =</span> <span class="cn">NA_real_</span>,</span>
<span id="cb12-706"><a href="#cb12-706"></a>  <span class="at">bic =</span> <span class="cn">NA_real_</span></span>
<span id="cb12-707"><a href="#cb12-707"></a>)</span>
<span id="cb12-708"><a href="#cb12-708"></a></span>
<span id="cb12-709"><a href="#cb12-709"></a>h_test <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb12-710"><a href="#cb12-710"></a></span>
<span id="cb12-711"><a href="#cb12-711"></a><span class="cf">for</span> (p <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) {</span>
<span id="cb12-712"><a href="#cb12-712"></a>  <span class="co"># Build formula with p lags</span></span>
<span id="cb12-713"><a href="#cb12-713"></a>  formula_str <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"f(y, "</span>, h_test, <span class="st">") - l(y, 1) ~ shock + l(y, 1:"</span>, p, <span class="st">") | country + time"</span>)</span>
<span id="cb12-714"><a href="#cb12-714"></a></span>
<span id="cb12-715"><a href="#cb12-715"></a>  model_lag <span class="ot">&lt;-</span> <span class="fu">feols</span>(<span class="fu">as.formula</span>(formula_str), <span class="at">data =</span> pdata, <span class="at">vcov =</span> <span class="sc">~</span>country)</span>
<span id="cb12-716"><a href="#cb12-716"></a></span>
<span id="cb12-717"><a href="#cb12-717"></a>  lag_comparison<span class="sc">$</span>aic[p] <span class="ot">&lt;-</span> <span class="fu">AIC</span>(model_lag)</span>
<span id="cb12-718"><a href="#cb12-718"></a>  lag_comparison<span class="sc">$</span>bic[p] <span class="ot">&lt;-</span> <span class="fu">BIC</span>(model_lag)</span>
<span id="cb12-719"><a href="#cb12-719"></a>}</span>
<span id="cb12-720"><a href="#cb12-720"></a></span>
<span id="cb12-721"><a href="#cb12-721"></a>lag_comparison_long <span class="ot">&lt;-</span> lag_comparison <span class="sc">%&gt;%</span></span>
<span id="cb12-722"><a href="#cb12-722"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(aic, bic), <span class="at">names_to =</span> <span class="st">"criterion"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb12-723"><a href="#cb12-723"></a></span>
<span id="cb12-724"><a href="#cb12-724"></a><span class="fu">ggplot</span>(lag_comparison_long, <span class="fu">aes</span>(<span class="at">x =</span> lags, <span class="at">y =</span> value, <span class="at">color =</span> criterion)) <span class="sc">+</span></span>
<span id="cb12-725"><a href="#cb12-725"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-726"><a href="#cb12-726"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb12-727"><a href="#cb12-727"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"aic"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>, <span class="st">"bic"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>),</span>
<span id="cb12-728"><a href="#cb12-728"></a>                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"AIC"</span>, <span class="st">"BIC"</span>)) <span class="sc">+</span></span>
<span id="cb12-729"><a href="#cb12-729"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Lag Selection for LP"</span>,</span>
<span id="cb12-730"><a href="#cb12-730"></a>       <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Information criteria at horizon h ="</span>, h_test),</span>
<span id="cb12-731"><a href="#cb12-731"></a>       <span class="at">x =</span> <span class="st">"Number of Lags"</span>, <span class="at">y =</span> <span class="st">"Information Criterion"</span>,</span>
<span id="cb12-732"><a href="#cb12-732"></a>       <span class="at">color =</span> <span class="st">"Criterion"</span>) <span class="sc">+</span></span>
<span id="cb12-733"><a href="#cb12-733"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb12-734"><a href="#cb12-734"></a><span class="in">```</span></span>
<span id="cb12-735"><a href="#cb12-735"></a></span>
<span id="cb12-736"><a href="#cb12-736"></a><span class="fu">## Cumulative vs. Non-Cumulative</span></span>
<span id="cb12-737"><a href="#cb12-737"></a></span>
<span id="cb12-738"><a href="#cb12-738"></a>**Cumulative (recommended for levels):**</span>
<span id="cb12-739"><a href="#cb12-739"></a>$$</span>
<span id="cb12-740"><a href="#cb12-740"></a>\text{LHS} = y_{t+h} - y_{t-1}</span>
<span id="cb12-741"><a href="#cb12-741"></a>$$</span>
<span id="cb12-742"><a href="#cb12-742"></a>Interpretation: Total change from $t-1$ to $t+h$.</span>
<span id="cb12-743"><a href="#cb12-743"></a></span>
<span id="cb12-744"><a href="#cb12-744"></a>**Non-cumulative:**</span>
<span id="cb12-745"><a href="#cb12-745"></a>$$</span>
<span id="cb12-746"><a href="#cb12-746"></a>\text{LHS} = y_{t+h}</span>
<span id="cb12-747"><a href="#cb12-747"></a>$$</span>
<span id="cb12-748"><a href="#cb12-748"></a>Interpretation: Level at $t+h$ (includes pre-existing trend).</span>
<span id="cb12-749"><a href="#cb12-749"></a></span>
<span id="cb12-750"><a href="#cb12-750"></a>Use cumulative for:</span>
<span id="cb12-751"><a href="#cb12-751"></a><span class="ss">- </span>GDP, debt/GDP, price level</span>
<span id="cb12-752"><a href="#cb12-752"></a><span class="ss">- </span>Any variable where you care about the total change</span>
<span id="cb12-753"><a href="#cb12-753"></a></span>
<span id="cb12-754"><a href="#cb12-754"></a>Use non-cumulative for:</span>
<span id="cb12-755"><a href="#cb12-755"></a><span class="ss">- </span>Growth rates, inflation (already differenced)</span>
<span id="cb12-756"><a href="#cb12-756"></a><span class="ss">- </span>When you want the level effect</span>
<span id="cb12-757"><a href="#cb12-757"></a></span>
<span id="cb12-758"><a href="#cb12-758"></a><span class="fu">## Comparing LP and VAR IRFs</span></span>
<span id="cb12-759"><a href="#cb12-759"></a></span>
<span id="cb12-760"><a href="#cb12-760"></a>Always compare LP and VAR when possible:</span>
<span id="cb12-761"><a href="#cb12-761"></a></span>
<span id="cb12-764"><a href="#cb12-764"></a><span class="in">```{r}</span></span>
<span id="cb12-765"><a href="#cb12-765"></a><span class="co">#| label: lp-var-comparison</span></span>
<span id="cb12-766"><a href="#cb12-766"></a><span class="co">#| fig-cap: "LP produces wider but more robust confidence intervals than VAR"</span></span>
<span id="cb12-767"><a href="#cb12-767"></a></span>
<span id="cb12-768"><a href="#cb12-768"></a><span class="co"># This is stylized - in practice, estimate both and compare</span></span>
<span id="cb12-769"><a href="#cb12-769"></a></span>
<span id="cb12-770"><a href="#cb12-770"></a>comparison_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-771"><a href="#cb12-771"></a>  <span class="at">horizon =</span> <span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span>H, <span class="dv">2</span>),</span>
<span id="cb12-772"><a href="#cb12-772"></a>  <span class="at">method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"LP"</span>, <span class="st">"VAR"</span>), <span class="at">each =</span> H <span class="sc">+</span> <span class="dv">1</span>),</span>
<span id="cb12-773"><a href="#cb12-773"></a>  <span class="at">estimate =</span> <span class="fu">c</span>(results<span class="sc">$</span>estimate, results<span class="sc">$</span>estimate <span class="sc">*</span> <span class="fl">0.95</span>),  <span class="co"># Stylized: VAR slightly different</span></span>
<span id="cb12-774"><a href="#cb12-774"></a>  <span class="at">ci_width =</span> <span class="fu">c</span>(results<span class="sc">$</span>se <span class="sc">*</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="dv">2</span>, results<span class="sc">$</span>se <span class="sc">*</span> <span class="fl">1.96</span> <span class="sc">*</span> <span class="fl">1.3</span>)  <span class="co"># LP wider CIs</span></span>
<span id="cb12-775"><a href="#cb12-775"></a>)</span>
<span id="cb12-776"><a href="#cb12-776"></a></span>
<span id="cb12-777"><a href="#cb12-777"></a><span class="fu">ggplot</span>(comparison_data, <span class="fu">aes</span>(<span class="at">x =</span> horizon, <span class="at">y =</span> estimate, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb12-778"><a href="#cb12-778"></a>  <span class="fu">geom_line</span>(<span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb12-779"><a href="#cb12-779"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-780"><a href="#cb12-780"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> estimate <span class="sc">-</span> ci_width<span class="sc">/</span><span class="dv">2</span>, <span class="at">ymax =</span> estimate <span class="sc">+</span> ci_width<span class="sc">/</span><span class="dv">2</span>),</span>
<span id="cb12-781"><a href="#cb12-781"></a>                <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-782"><a href="#cb12-782"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"LP"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>, <span class="st">"VAR"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>)) <span class="sc">+</span></span>
<span id="cb12-783"><a href="#cb12-783"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"LP vs VAR: Point Estimates and Confidence Intervals"</span>,</span>
<span id="cb12-784"><a href="#cb12-784"></a>       <span class="at">subtitle =</span> <span class="st">"LP has wider CIs but is more robust to misspecification"</span>,</span>
<span id="cb12-785"><a href="#cb12-785"></a>       <span class="at">x =</span> <span class="st">"Horizon"</span>, <span class="at">y =</span> <span class="st">"Response"</span>,</span>
<span id="cb12-786"><a href="#cb12-786"></a>       <span class="at">color =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb12-787"><a href="#cb12-787"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb12-788"><a href="#cb12-788"></a><span class="in">```</span></span>
<span id="cb12-789"><a href="#cb12-789"></a></span>
<span id="cb12-790"><a href="#cb12-790"></a>**When LP and VAR disagree:**</span>
<span id="cb12-791"><a href="#cb12-791"></a><span class="ss">- </span>Check VAR specification (lags, variables)</span>
<span id="cb12-792"><a href="#cb12-792"></a><span class="ss">- </span>LP is likely more robust to misspecification</span>
<span id="cb12-793"><a href="#cb12-793"></a><span class="ss">- </span>VAR may be picking up spurious dynamics</span>
<span id="cb12-794"><a href="#cb12-794"></a></span>
<span id="cb12-795"><a href="#cb12-795"></a><span class="fu"># Frequently Asked Questions {.unnumbered}</span></span>
<span id="cb12-796"><a href="#cb12-796"></a></span>
<span id="cb12-797"><a href="#cb12-797"></a><span class="fu">## When should I use LP vs. VAR?</span></span>
<span id="cb12-798"><a href="#cb12-798"></a></span>
<span id="cb12-799"><a href="#cb12-799"></a>**Use LP when:**</span>
<span id="cb12-800"><a href="#cb12-800"></a><span class="ss">- </span>You only need to identify ONE shock</span>
<span id="cb12-801"><a href="#cb12-801"></a><span class="ss">- </span>Misspecification is a concern</span>
<span id="cb12-802"><a href="#cb12-802"></a><span class="ss">- </span>You want state-dependent or nonlinear responses</span>
<span id="cb12-803"><a href="#cb12-803"></a><span class="ss">- </span>You're working with panel data</span>
<span id="cb12-804"><a href="#cb12-804"></a></span>
<span id="cb12-805"><a href="#cb12-805"></a>**Use VAR when:**</span>
<span id="cb12-806"><a href="#cb12-806"></a><span class="ss">- </span>You need the full system (FEVD, historical decomposition)</span>
<span id="cb12-807"><a href="#cb12-807"></a><span class="ss">- </span>Efficiency matters and you trust the specification</span>
<span id="cb12-808"><a href="#cb12-808"></a><span class="ss">- </span>Short horizons with well-identified structure</span>
<span id="cb12-809"><a href="#cb12-809"></a></span>
<span id="cb12-810"><a href="#cb12-810"></a><span class="fu">## How do I choose the horizon H?</span></span>
<span id="cb12-811"><a href="#cb12-811"></a></span>
<span id="cb12-812"><a href="#cb12-812"></a><span class="ss">- </span>Plot IRFs and extend until they converge to zero (or steady state)</span>
<span id="cb12-813"><a href="#cb12-813"></a><span class="ss">- </span>Stop when confidence intervals become uninformative</span>
<span id="cb12-814"><a href="#cb12-814"></a><span class="ss">- </span>Rule of thumb: H = 4-5 years for quarterly macro data</span>
<span id="cb12-815"><a href="#cb12-815"></a><span class="ss">- </span>Report effective sample sizes</span>
<span id="cb12-816"><a href="#cb12-816"></a></span>
<span id="cb12-817"><a href="#cb12-817"></a><span class="fu">## What controls should I include?</span></span>
<span id="cb12-818"><a href="#cb12-818"></a></span>
<span id="cb12-819"><a href="#cb12-819"></a><span class="ss">- </span>Lagged dependent variable (always)</span>
<span id="cb12-820"><a href="#cb12-820"></a><span class="ss">- </span>Variables that affect both shock and outcome (confounders)</span>
<span id="cb12-821"><a href="#cb12-821"></a><span class="ss">- </span>**Don't include** post-treatment controls (bad controls)</span>
<span id="cb12-822"><a href="#cb12-822"></a><span class="ss">- </span>Keep controls consistent across horizons</span>
<span id="cb12-823"><a href="#cb12-823"></a></span>
<span id="cb12-824"><a href="#cb12-824"></a><span class="fu">## How do I report results?</span></span>
<span id="cb12-825"><a href="#cb12-825"></a></span>
<span id="cb12-826"><a href="#cb12-826"></a><span class="ss">1. </span>**Plot the IRF** with confidence bands</span>
<span id="cb12-827"><a href="#cb12-827"></a><span class="ss">2. </span>**Report** the peak response and time to peak</span>
<span id="cb12-828"><a href="#cb12-828"></a><span class="ss">3. </span>**Table** with point estimates and SEs at key horizons</span>
<span id="cb12-829"><a href="#cb12-829"></a><span class="ss">4. </span>**Report** sample size at each horizon</span>
<span id="cb12-830"><a href="#cb12-830"></a><span class="ss">5. </span>**Compare** with VAR if possible</span>
<span id="cb12-831"><a href="#cb12-831"></a></span>
<span id="cb12-832"><a href="#cb12-832"></a><span class="fu"># Summary {.unnumbered}</span></span>
<span id="cb12-833"><a href="#cb12-833"></a></span>
<span id="cb12-834"><a href="#cb12-834"></a>Key takeaways from this module:</span>
<span id="cb12-835"><a href="#cb12-835"></a></span>
<span id="cb12-836"><a href="#cb12-836"></a><span class="ss">1. </span>**LP estimates IRFs directly** at each horizon—no need to specify full system</span>
<span id="cb12-837"><a href="#cb12-837"></a></span>
<span id="cb12-838"><a href="#cb12-838"></a><span class="ss">2. </span>**LP and VAR give same population IRFs** but LP is more robust to misspecification</span>
<span id="cb12-839"><a href="#cb12-839"></a></span>
<span id="cb12-840"><a href="#cb12-840"></a><span class="ss">3. </span>**Use HAC or clustered SEs**—overlapping residuals create serial correlation</span>
<span id="cb12-841"><a href="#cb12-841"></a></span>
<span id="cb12-842"><a href="#cb12-842"></a><span class="ss">4. </span>**State-dependent LP** is easy: interact shock with state indicator</span>
<span id="cb12-843"><a href="#cb12-843"></a></span>
<span id="cb12-844"><a href="#cb12-844"></a><span class="ss">5. </span>**LP-DiD** extends to treatment effect settings with dynamic effects</span>
<span id="cb12-845"><a href="#cb12-845"></a></span>
<span id="cb12-846"><a href="#cb12-846"></a><span class="ss">6. </span>**Sample erodes** at longer horizons—report effective sample sizes</span>
<span id="cb12-847"><a href="#cb12-847"></a></span>
<span id="cb12-848"><a href="#cb12-848"></a><span class="ss">7. </span>**Confidence intervals widen** with horizon—this is a feature, not a bug</span>
<span id="cb12-849"><a href="#cb12-849"></a></span>
<span id="cb12-850"><a href="#cb12-850"></a>---</span>
<span id="cb12-851"><a href="#cb12-851"></a></span>
<span id="cb12-852"><a href="#cb12-852"></a>*Next: [Module 4: Vector Autoregressions](04_var_svar.qmd)*</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Mastering Empirical Macroeconometrics by Bijoy Ratan Ghosh</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum/edit/main/chapters/03_local_projections.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>