<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Synthetic Control Methods – Mastering Empirical Macroeconometrics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/07_bayesian_foundations.html" rel="next">
<link href="../chapters/05_staggered_did.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-f555ed0e695c0487cf72966c0b30f9ff.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-ec3f846469679b9e6f6b146d88a0bba5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/05_staggered_did.html">Phase 3: Treatment Effects</a></li><li class="breadcrumb-item"><a href="../chapters/06_synthetic_control.html"><span class="chapter-title">Synthetic Control Methods</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Mastering Empirical Macroeconometrics</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Mastering Empirical Macroeconometrics</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 1: Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01_panel_econometrics.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Panel Data Econometrics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02_identification.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Identification in Macroeconomics</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 2: Dynamic Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03_local_projections.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Local Projections</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04_var_svar.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Vector Autoregressions</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 3: Treatment Effects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05_staggered_did.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Staggered Difference-in-Differences</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06_synthetic_control.html" class="sidebar-item-text sidebar-link active"><span class="chapter-title">Synthetic Control Methods</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 4: Bayesian Econometrics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07_bayesian_foundations.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Bayesian Foundations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08_bayesian_var.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Bayesian Vector Autoregressions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09_bayesian_panel.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Bayesian Panel Methods</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 5: Structural Macro</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/10_dsge_foundations.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">DSGE Foundations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/11_dsge_estimation.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">DSGE Estimation</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Phase 6: Causal Machine Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/12_regularization.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Regularization for Macro</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/13_causal_ml.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">Causal Machine Learning</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../references.html" class="sidebar-item-text sidebar-link"><span class="chapter-title">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#when-did-fails" id="toc-when-did-fails" class="nav-link active" data-scroll-target="#when-did-fails">When DiD Fails</a>
  <ul class="collapse">
  <li><a href="#the-core-insight" id="toc-the-core-insight" class="nav-link" data-scroll-target="#the-core-insight">The Core Insight</a></li>
  </ul></li>
  <li><a href="#the-scm-framework" id="toc-the-scm-framework" class="nav-link" data-scroll-target="#the-scm-framework">The SCM Framework</a>
  <ul class="collapse">
  <li><a href="#abadie-diamond-hainmueller-2010-2015" id="toc-abadie-diamond-hainmueller-2010-2015" class="nav-link" data-scroll-target="#abadie-diamond-hainmueller-2010-2015">Abadie, Diamond &amp; Hainmueller (2010, 2015)</a>
  <ul class="collapse">
  <li><a href="#setup-and-notation" id="toc-setup-and-notation" class="nav-link" data-scroll-target="#setup-and-notation">Setup and Notation</a></li>
  <li><a href="#the-synthetic-control-estimator" id="toc-the-synthetic-control-estimator" class="nav-link" data-scroll-target="#the-synthetic-control-estimator">The Synthetic Control Estimator</a></li>
  </ul></li>
  <li><a href="#choosing-predictors-x" id="toc-choosing-predictors-x" class="nav-link" data-scroll-target="#choosing-predictors-x">Choosing Predictors (<span class="math inline">\(X\)</span>)</a></li>
  <li><a href="#the-nested-optimization" id="toc-the-nested-optimization" class="nav-link" data-scroll-target="#the-nested-optimization">The Nested Optimization</a></li>
  </ul></li>
  <li><a href="#inference-permutation-tests" id="toc-inference-permutation-tests" class="nav-link" data-scroll-target="#inference-permutation-tests">Inference: Permutation Tests</a>
  <ul class="collapse">
  <li><a href="#the-placebo-test" id="toc-the-placebo-test" class="nav-link" data-scroll-target="#the-placebo-test">The Placebo Test</a></li>
  <li><a href="#rmspe-ratio" id="toc-rmspe-ratio" class="nav-link" data-scroll-target="#rmspe-ratio">RMSPE Ratio</a></li>
  </ul></li>
  <li><a href="#synthetic-difference-in-differences" id="toc-synthetic-difference-in-differences" class="nav-link" data-scroll-target="#synthetic-difference-in-differences">Synthetic Difference-in-Differences</a>
  <ul class="collapse">
  <li><a href="#arkhangelsky-et-al.-2021" id="toc-arkhangelsky-et-al.-2021" class="nav-link" data-scroll-target="#arkhangelsky-et-al.-2021">Arkhangelsky et al.&nbsp;(2021)</a>
  <ul class="collapse">
  <li><a href="#the-estimator" id="toc-the-estimator" class="nav-link" data-scroll-target="#the-estimator">The Estimator</a></li>
  <li><a href="#advantages" id="toc-advantages" class="nav-link" data-scroll-target="#advantages">Advantages</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#implementation-in-r" id="toc-implementation-in-r" class="nav-link" data-scroll-target="#implementation-in-r">Implementation in R</a>
  <ul class="collapse">
  <li><a href="#using-augsynth-package" id="toc-using-augsynth-package" class="nav-link" data-scroll-target="#using-augsynth-package">Using <code>augsynth</code> Package</a>
  <ul class="collapse">
  <li><a href="#key-arguments" id="toc-key-arguments" class="nav-link" data-scroll-target="#key-arguments">Key Arguments</a></li>
  <li><a href="#multiple-treated-units-with-multisynth" id="toc-multiple-treated-units-with-multisynth" class="nav-link" data-scroll-target="#multiple-treated-units-with-multisynth">Multiple Treated Units with <code>multisynth</code></a></li>
  </ul></li>
  <li><a href="#using-synthdid-package" id="toc-using-synthdid-package" class="nav-link" data-scroll-target="#using-synthdid-package">Using <code>synthdid</code> Package</a></li>
  <li><a href="#worked-example" id="toc-worked-example" class="nav-link" data-scroll-target="#worked-example">Worked Example</a></li>
  </ul></li>
  <li><a href="#diagnostics-and-validation" id="toc-diagnostics-and-validation" class="nav-link" data-scroll-target="#diagnostics-and-validation">Diagnostics and Validation</a>
  <ul class="collapse">
  <li><a href="#pre-treatment-fit" id="toc-pre-treatment-fit" class="nav-link" data-scroll-target="#pre-treatment-fit">1. Pre-Treatment Fit</a></li>
  <li><a href="#weight-diagnostics" id="toc-weight-diagnostics" class="nav-link" data-scroll-target="#weight-diagnostics">2. Weight Diagnostics</a></li>
  <li><a href="#leave-one-out-sensitivity" id="toc-leave-one-out-sensitivity" class="nav-link" data-scroll-target="#leave-one-out-sensitivity">3. Leave-One-Out Sensitivity</a></li>
  </ul></li>
  <li><a href="#scm-vs.-did-decision-framework" id="toc-scm-vs.-did-decision-framework" class="nav-link" data-scroll-target="#scm-vs.-did-decision-framework">SCM vs.&nbsp;DiD: Decision Framework</a>
  <ul class="collapse">
  <li><a href="#when-to-use-which" id="toc-when-to-use-which" class="nav-link" data-scroll-target="#when-to-use-which">When to Use Which?</a></li>
  <li><a href="#comparison-table" id="toc-comparison-table" class="nav-link" data-scroll-target="#comparison-table">Comparison Table</a></li>
  </ul></li>
  <li><a href="#common-pitfalls" id="toc-common-pitfalls" class="nav-link" data-scroll-target="#common-pitfalls">Common Pitfalls</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a>
  <ul class="collapse">
  <li><a href="#key-references" id="toc-key-references" class="nav-link" data-scroll-target="#key-references">Key References</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum/edit/main/chapters/06_synthetic_control.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/05_staggered_did.html">Phase 3: Treatment Effects</a></li><li class="breadcrumb-item"><a href="../chapters/06_synthetic_control.html"><span class="chapter-title">Synthetic Control Methods</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-title">Synthetic Control Methods</span></h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Data-Driven Counterfactuals for Comparative Case Studies</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="when-did-fails" class="level1 unnumbered">
<h1 class="unnumbered">When DiD Fails</h1>
<p>Difference-in-differences requires <strong>parallel trends</strong>—the assumption that treated and control groups would have followed similar paths absent treatment. But what happens when:</p>
<ul>
<li>You have only <strong>one treated unit</strong>?</li>
<li>No control unit has trends parallel to the treated unit?</li>
<li>The treated unit is unique (e.g., West Germany, California, a specific country)?</li>
</ul>
<p><strong>Synthetic Control Methods (SCM)</strong> solve this by constructing a weighted combination of untreated units that together replicate the treated unit’s pre-treatment trajectory. Instead of assuming parallel trends, SCM <strong>matches</strong> them.</p>
<section id="the-core-insight" class="level2">
<h2 class="anchored" data-anchor-id="the-core-insight">The Core Insight</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 40%">
<col style="width: 40%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Comparison Unit</th>
<th>Key Assumption</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DiD</td>
<td>Actual control group</td>
<td>Parallel trends</td>
</tr>
<tr class="even">
<td>SCM</td>
<td><strong>Synthetic</strong> control (weighted donors)</td>
<td>Weights match pre-treatment outcomes</td>
</tr>
</tbody>
</table>
<p>SCM is transparent: you see exactly which units contribute to the counterfactual and with what weights.</p>
</section>
</section>
<section id="the-scm-framework" class="level1 unnumbered">
<h1 class="unnumbered">The SCM Framework</h1>
<section id="abadie-diamond-hainmueller-2010-2015" class="level2">
<h2 class="anchored" data-anchor-id="abadie-diamond-hainmueller-2010-2015">Abadie, Diamond &amp; Hainmueller (2010, 2015)</h2>
<section id="setup-and-notation" class="level3">
<h3 class="anchored" data-anchor-id="setup-and-notation">Setup and Notation</h3>
<p>Following the foundational papers:</p>
<p><span class="math display">\[
\begin{aligned}
&amp;\text{Treated unit: } i = 1 \\
&amp;\text{Donor pool: } i = 2, \ldots, J+1 \\
&amp;\text{Pre-treatment: } t = 1, \ldots, T_0 \\
&amp;\text{Post-treatment: } t = T_0+1, \ldots, T
\end{aligned}
\]</span></p>
<p>We want to estimate the treatment effect: <span class="math display">\[
\tau_{1t} = Y_{1t}(1) - Y_{1t}(0) \quad \text{for } t &gt; T_0
\]</span></p>
<p>We observe <span class="math inline">\(Y_{1t}(1)\)</span> (the actual outcome under treatment). The challenge is estimating <span class="math inline">\(Y_{1t}(0)\)</span>—what would have happened without treatment.</p>
</section>
<section id="the-synthetic-control-estimator" class="level3">
<h3 class="anchored" data-anchor-id="the-synthetic-control-estimator">The Synthetic Control Estimator</h3>
<p>Find weights <span class="math inline">\(W^* = (w_2, \ldots, w_{J+1})'\)</span> that solve:</p>
<p><span class="math display">\[
\min_W \|X_1 - X_0 W\|_V \quad \text{subject to } w_j \geq 0, \sum_{j=2}^{J+1} w_j = 1
\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(X_1\)</span> = vector of pre-treatment characteristics of treated unit</li>
<li><span class="math inline">\(X_0\)</span> = matrix of pre-treatment characteristics of donor units</li>
<li><span class="math inline">\(V\)</span> = diagonal weight matrix (predictor importance)</li>
<li>Constraints ensure weights are non-negative and sum to one (convex combination)</li>
</ul>
<p><strong>The synthetic control outcome</strong>: <span class="math display">\[
\hat{Y}_{1t}(0) = \sum_{j=2}^{J+1} w_j^* Y_{jt}
\]</span></p>
<p><strong>The treatment effect estimate</strong>: <span class="math display">\[
\hat{\tau}_{1t} = Y_{1t} - \sum_{j=2}^{J+1} w_j^* Y_{jt}
\]</span></p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Simulate SCM scenario</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-3"><a href="#cb1-3"></a>T_total <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>T0 <span class="ot">&lt;-</span> <span class="dv">12</span>  <span class="co"># Treatment after period 12</span></span>
<span id="cb1-5"><a href="#cb1-5"></a></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co"># Treated unit trajectory</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>treated_base <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rnorm</span>(T0<span class="dv">-1</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>)))</span>
<span id="cb1-8"><a href="#cb1-8"></a>treated_post <span class="ot">&lt;-</span> treated_base[T0] <span class="sc">+</span> <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(T_total <span class="sc">-</span> T0, <span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.25</span>))</span>
<span id="cb1-9"><a href="#cb1-9"></a>treated <span class="ot">&lt;-</span> <span class="fu">c</span>(treated_base, treated_post)</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co"># Donor units (5 potential controls)</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>donors <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(i) {</span>
<span id="cb1-13"><a href="#cb1-13"></a>  base <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rnorm</span>(T_total<span class="dv">-1</span>, <span class="fl">0.25</span> <span class="sc">+</span> <span class="fl">0.05</span><span class="sc">*</span>i, <span class="fl">0.3</span>)))</span>
<span id="cb1-14"><a href="#cb1-14"></a>  <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_total, <span class="at">unit =</span> <span class="fu">paste</span>(<span class="st">"Donor"</span>, i), <span class="at">y =</span> base)</span>
<span id="cb1-15"><a href="#cb1-15"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co"># Optimal weights (illustrative - found to match pre-treatment)</span></span>
<span id="cb1-18"><a href="#cb1-18"></a>weights <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.45</span>, <span class="fl">0.30</span>, <span class="fl">0.15</span>, <span class="fl">0.10</span>, <span class="fl">0.00</span>)</span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co"># Construct synthetic control</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>synthetic <span class="ot">&lt;-</span> donors <span class="sc">%&gt;%</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-23"><a href="#cb1-23"></a>    unit <span class="sc">==</span> <span class="st">"Donor 1"</span> <span class="sc">~</span> weights[<span class="dv">1</span>],</span>
<span id="cb1-24"><a href="#cb1-24"></a>    unit <span class="sc">==</span> <span class="st">"Donor 2"</span> <span class="sc">~</span> weights[<span class="dv">2</span>],</span>
<span id="cb1-25"><a href="#cb1-25"></a>    unit <span class="sc">==</span> <span class="st">"Donor 3"</span> <span class="sc">~</span> weights[<span class="dv">3</span>],</span>
<span id="cb1-26"><a href="#cb1-26"></a>    unit <span class="sc">==</span> <span class="st">"Donor 4"</span> <span class="sc">~</span> weights[<span class="dv">4</span>],</span>
<span id="cb1-27"><a href="#cb1-27"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> weights[<span class="dv">5</span>]</span>
<span id="cb1-28"><a href="#cb1-28"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb1-29"><a href="#cb1-29"></a>  <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb1-30"><a href="#cb1-30"></a>  <span class="fu">summarize</span>(<span class="at">y =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weight), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a><span class="co"># Combine for plotting</span></span>
<span id="cb1-33"><a href="#cb1-33"></a>treated_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_total, <span class="at">y =</span> treated, <span class="at">unit =</span> <span class="st">"Treated"</span>)</span>
<span id="cb1-34"><a href="#cb1-34"></a></span>
<span id="cb1-35"><a href="#cb1-35"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb1-36"><a href="#cb1-36"></a>  <span class="co"># Donor units (faded)</span></span>
<span id="cb1-37"><a href="#cb1-37"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> donors, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y, <span class="at">group =</span> unit),</span>
<span id="cb1-38"><a href="#cb1-38"></a>            <span class="at">color =</span> <span class="st">"gray70"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb1-39"><a href="#cb1-39"></a>  <span class="co"># Synthetic control</span></span>
<span id="cb1-40"><a href="#cb1-40"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> synthetic, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb1-41"><a href="#cb1-41"></a>            <span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">linewidth =</span> <span class="fl">1.3</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb1-42"><a href="#cb1-42"></a>  <span class="co"># Treated unit</span></span>
<span id="cb1-43"><a href="#cb1-43"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> treated_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb1-44"><a href="#cb1-44"></a>            <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">linewidth =</span> <span class="fl">1.3</span>) <span class="sc">+</span></span>
<span id="cb1-45"><a href="#cb1-45"></a>  <span class="co"># Treatment line</span></span>
<span id="cb1-46"><a href="#cb1-46"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> T0 <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb1-47"><a href="#cb1-47"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> T0 <span class="sc">+</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="fu">max</span>(treated) <span class="sc">*</span> <span class="fl">0.95</span>,</span>
<span id="cb1-48"><a href="#cb1-48"></a>           <span class="at">label =</span> <span class="st">"Treatment"</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb1-49"><a href="#cb1-49"></a>  <span class="co"># Gap annotation</span></span>
<span id="cb1-50"><a href="#cb1-50"></a>  <span class="fu">annotate</span>(<span class="st">"segment"</span>, <span class="at">x =</span> T_total <span class="sc">-</span> <span class="dv">1</span>, <span class="at">xend =</span> T_total <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb1-51"><a href="#cb1-51"></a>           <span class="at">y =</span> treated[T_total<span class="dv">-1</span>], <span class="at">yend =</span> synthetic<span class="sc">$</span>y[T_total<span class="dv">-1</span>],</span>
<span id="cb1-52"><a href="#cb1-52"></a>           <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">ends =</span> <span class="st">"both"</span>, <span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.08</span>, <span class="st">"inches"</span>)),</span>
<span id="cb1-53"><a href="#cb1-53"></a>           <span class="at">color =</span> <span class="st">"#9b59b6"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb1-54"><a href="#cb1-54"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> T_total <span class="sc">-</span> <span class="fl">0.5</span>,</span>
<span id="cb1-55"><a href="#cb1-55"></a>           <span class="at">y =</span> <span class="fu">mean</span>(<span class="fu">c</span>(treated[T_total<span class="dv">-1</span>], synthetic<span class="sc">$</span>y[T_total<span class="dv">-1</span>])),</span>
<span id="cb1-56"><a href="#cb1-56"></a>           <span class="at">label =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(tau)), <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"#9b59b6"</span>) <span class="sc">+</span></span>
<span id="cb1-57"><a href="#cb1-57"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic Control Method"</span>,</span>
<span id="cb1-58"><a href="#cb1-58"></a>       <span class="at">subtitle =</span> <span class="st">"Red = Treated | Blue dashed = Synthetic Control | Gray = Donor Pool"</span>,</span>
<span id="cb1-59"><a href="#cb1-59"></a>       <span class="at">x =</span> <span class="st">"Time Period"</span>, <span class="at">y =</span> <span class="st">"Outcome"</span>) <span class="sc">+</span></span>
<span id="cb1-60"><a href="#cb1-60"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_synthetic_control_files/figure-html/scm-visual-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Synthetic control: construct counterfactual from weighted donors</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="choosing-predictors-x" class="level2">
<h2 class="anchored" data-anchor-id="choosing-predictors-x">Choosing Predictors (<span class="math inline">\(X\)</span>)</h2>
<p>The predictor matrix <span class="math inline">\(X\)</span> typically includes:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 43%">
<col style="width: 27%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th>Predictor Type</th>
<th>Examples</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Pre-treatment outcomes</strong></td>
<td><span class="math inline">\(Y_{1,T_0}, Y_{1,T_0-1}, \ldots\)</span></td>
<td>Forces trajectory matching</td>
</tr>
<tr class="even">
<td><strong>Economic fundamentals</strong></td>
<td>GDP growth, inflation, trade openness</td>
<td>Structural similarity</td>
</tr>
<tr class="odd">
<td><strong>Demographics</strong></td>
<td>Population, urbanization</td>
<td>Background comparability</td>
</tr>
<tr class="even">
<td><strong>Policy variables</strong></td>
<td>Tax rates, regulations</td>
<td>Institutional similarity</td>
</tr>
</tbody>
</table>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Include Pre-Treatment Outcomes
</div>
</div>
<div class="callout-body-container callout-body">
<p>Abadie (2021) emphasizes: always include <strong>multiple pre-treatment outcomes</strong> as predictors. This forces the synthetic control to track the actual trajectory, not just match averages.</p>
</div>
</div>
</section>
<section id="the-nested-optimization" class="level2">
<h2 class="anchored" data-anchor-id="the-nested-optimization">The Nested Optimization</h2>
<p>In practice, SCM solves two nested problems:</p>
<p><strong>Inner problem</strong> (given predictor weights <span class="math inline">\(V\)</span>): <span class="math display">\[
W^*(V) = \arg\min_W (X_1 - X_0 W)' V (X_1 - X_0 W)
\]</span></p>
<p><strong>Outer problem</strong> (choose <span class="math inline">\(V\)</span> to minimize pre-treatment fit): <span class="math display">\[
V^* = \arg\min_V \sum_{t=1}^{T_0} \left(Y_{1t} - \sum_{j} w_j^*(V) Y_{jt}\right)^2
\]</span></p>
<p>This ensures the weights are chosen to match the <strong>outcome trajectory</strong>, not just predictor averages.</p>
</section>
</section>
<section id="inference-permutation-tests" class="level1 unnumbered">
<h1 class="unnumbered">Inference: Permutation Tests</h1>
<p>With one treated unit, standard inference doesn’t apply. SCM uses <strong>permutation-based inference</strong>.</p>
<section id="the-placebo-test" class="level2">
<h2 class="anchored" data-anchor-id="the-placebo-test">The Placebo Test</h2>
<p><strong>Idea</strong>: Apply SCM to each donor unit as if it were treated. If the treated unit’s effect is real, its gap should be unusually large compared to placebo gaps.</p>
<p><strong>Procedure</strong>:</p>
<ol type="1">
<li>Estimate SCM for treated unit → get gap <span class="math inline">\(\hat{\tau}_{1t}\)</span></li>
<li>For each donor <span class="math inline">\(j = 2, \ldots, J+1\)</span>:
<ul>
<li>Pretend unit <span class="math inline">\(j\)</span> is treated (remove from donor pool)</li>
<li>Construct synthetic control from remaining units</li>
<li>Calculate placebo gap <span class="math inline">\(\hat{\tau}_{jt}\)</span></li>
</ul></li>
<li>Compare: Is <span class="math inline">\(|\hat{\tau}_{1t}|\)</span> extreme relative to <span class="math inline">\(\{|\hat{\tau}_{jt}|\}\)</span>?</li>
</ol>
<p><strong>P-value</strong>: <span class="math display">\[
p = \frac{\#\{j : |\hat{\tau}_j| \geq |\hat{\tau}_1|\}}{J + 1}
\]</span></p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Simulate placebo test</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb2-3"><a href="#cb2-3"></a>n_placebo <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co"># Treated unit has real effect</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>treated_gap <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, T0), <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(T_total <span class="sc">-</span> T0, <span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.2</span>)))</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co"># Placebo gaps (no real effect)</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>placebo_gaps <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n_placebo, <span class="cf">function</span>(i) {</span>
<span id="cb2-10"><a href="#cb2-10"></a>  gap <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(T0, <span class="dv">0</span>, <span class="fl">0.25</span>), <span class="fu">rnorm</span>(T_total <span class="sc">-</span> T0, <span class="dv">0</span>, <span class="fl">0.35</span>))</span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_total, <span class="at">gap =</span> gap, <span class="at">unit =</span> <span class="fu">paste</span>(<span class="st">"Placebo"</span>, i))</span>
<span id="cb2-12"><a href="#cb2-12"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co"># Combine</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>all_gaps <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb2-16"><a href="#cb2-16"></a>  <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_total, <span class="at">gap =</span> treated_gap, <span class="at">unit =</span> <span class="st">"Treated"</span>),</span>
<span id="cb2-17"><a href="#cb2-17"></a>  placebo_gaps</span>
<span id="cb2-18"><a href="#cb2-18"></a>)</span>
<span id="cb2-19"><a href="#cb2-19"></a></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="fu">ggplot</span>(all_gaps, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> gap, <span class="at">group =</span> unit)) <span class="sc">+</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">filter</span>(all_gaps, unit <span class="sc">!=</span> <span class="st">"Treated"</span>),</span>
<span id="cb2-22"><a href="#cb2-22"></a>            <span class="at">color =</span> <span class="st">"gray60"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">filter</span>(all_gaps, unit <span class="sc">==</span> <span class="st">"Treated"</span>),</span>
<span id="cb2-24"><a href="#cb2-24"></a>            <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">linewidth =</span> <span class="fl">1.3</span>) <span class="sc">+</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> T0 <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="fu">min</span>(all_gaps<span class="sc">$</span>gap) <span class="sc">*</span> <span class="fl">0.8</span>,</span>
<span id="cb2-28"><a href="#cb2-28"></a>           <span class="at">label =</span> <span class="st">"Gray = Placebo gaps</span><span class="sc">\n</span><span class="st">Red = Treated unit gap"</span>,</span>
<span id="cb2-29"><a href="#cb2-29"></a>           <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span></span>
<span id="cb2-30"><a href="#cb2-30"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Placebo Test for Inference"</span>,</span>
<span id="cb2-31"><a href="#cb2-31"></a>       <span class="at">subtitle =</span> <span class="st">"If treatment effect is real, treated unit's gap should be extreme"</span>,</span>
<span id="cb2-32"><a href="#cb2-32"></a>       <span class="at">x =</span> <span class="st">"Time Period"</span>, <span class="at">y =</span> <span class="st">"Gap (Actual - Synthetic)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_synthetic_control_files/figure-html/placebo-test-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Placebo test: treated unit gap vs.&nbsp;placebo distribution</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="rmspe-ratio" class="level2">
<h2 class="anchored" data-anchor-id="rmspe-ratio">RMSPE Ratio</h2>
<p>To account for <strong>pre-treatment fit quality</strong>, use the RMSPE ratio:</p>
<p><span class="math display">\[
\text{Ratio}_j = \frac{\text{RMSPE}_{j,\text{post}}}{\text{RMSPE}_{j,\text{pre}}}
\]</span></p>
<p>where: <span class="math display">\[
\text{RMSPE}_{j,\text{pre}} = \sqrt{\frac{1}{T_0} \sum_{t=1}^{T_0} (Y_{jt} - \hat{Y}_{jt}^{\text{synth}})^2}
\]</span></p>
<p><strong>Rationale</strong>: A unit with poor pre-treatment fit may have large post-treatment gaps just from noise. The ratio normalizes by pre-treatment fit quality.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Calculate RMSPE ratios</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>rmspe_pre <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.12</span>, <span class="fu">runif</span>(n_placebo, <span class="fl">0.15</span>, <span class="fl">0.6</span>))  <span class="co"># Treated has good fit</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>rmspe_post <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fu">runif</span>(n_placebo, <span class="fl">0.2</span>, <span class="fl">1.2</span>))   <span class="co"># Treated has large post gap</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a>rmspe_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="at">unit =</span> <span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="fu">paste</span>(<span class="st">"Placebo"</span>, <span class="dv">1</span><span class="sc">:</span>n_placebo)),</span>
<span id="cb3-7"><a href="#cb3-7"></a>  <span class="at">rmspe_pre =</span> rmspe_pre,</span>
<span id="cb3-8"><a href="#cb3-8"></a>  <span class="at">rmspe_post =</span> rmspe_post</span>
<span id="cb3-9"><a href="#cb3-9"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="at">ratio =</span> rmspe_post <span class="sc">/</span> rmspe_pre,</span>
<span id="cb3-12"><a href="#cb3-12"></a>    <span class="at">is_treated =</span> unit <span class="sc">==</span> <span class="st">"Treated"</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(ratio))</span>
<span id="cb3-15"><a href="#cb3-15"></a></span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="co"># P-value</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>p_val <span class="ot">&lt;-</span> <span class="fu">mean</span>(rmspe_df<span class="sc">$</span>ratio <span class="sc">&gt;=</span> rmspe_df<span class="sc">$</span>ratio[rmspe_df<span class="sc">$</span>unit <span class="sc">==</span> <span class="st">"Treated"</span>])</span>
<span id="cb3-18"><a href="#cb3-18"></a></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="fu">ggplot</span>(rmspe_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(unit, ratio), <span class="at">y =</span> ratio, <span class="at">fill =</span> is_treated)) <span class="sc">+</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> rmspe_df<span class="sc">$</span>ratio[rmspe_df<span class="sc">$</span>unit <span class="sc">==</span> <span class="st">"Treated"</span>],</span>
<span id="cb3-22"><a href="#cb3-22"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb3-24"><a href="#cb3-24"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"#bdc3c7"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb3-25"><a href="#cb3-25"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RMSPE Ratio Distribution"</span>,</span>
<span id="cb3-26"><a href="#cb3-26"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Treated unit ratio = "</span>,</span>
<span id="cb3-27"><a href="#cb3-27"></a>                        <span class="fu">round</span>(rmspe_df<span class="sc">$</span>ratio[rmspe_df<span class="sc">$</span>unit <span class="sc">==</span> <span class="st">"Treated"</span>], <span class="dv">1</span>),</span>
<span id="cb3-28"><a href="#cb3-28"></a>                        <span class="st">" | Implied p-value = "</span>, <span class="fu">round</span>(p_val, <span class="dv">3</span>)),</span>
<span id="cb3-29"><a href="#cb3-29"></a>       <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Post/Pre RMSPE Ratio"</span>) <span class="sc">+</span></span>
<span id="cb3-30"><a href="#cb3-30"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_synthetic_control_files/figure-html/rmspe-ratio-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>RMSPE ratio: normalizing by pre-treatment fit</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="synthetic-difference-in-differences" class="level1 unnumbered">
<h1 class="unnumbered">Synthetic Difference-in-Differences</h1>
<section id="arkhangelsky-et-al.-2021" class="level2">
<h2 class="anchored" data-anchor-id="arkhangelsky-et-al.-2021">Arkhangelsky et al.&nbsp;(2021)</h2>
<p><strong>Synthetic DiD</strong> combines the strengths of SCM and DiD:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Method</th>
<th>Handles Multiple Treated?</th>
<th>Requires Parallel Trends?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DiD</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="even">
<td>SCM</td>
<td>No (designed for one)</td>
<td>No (matches trajectories)</td>
</tr>
<tr class="odd">
<td><strong>Synthetic DiD</strong></td>
<td><strong>Yes</strong></td>
<td><strong>No</strong></td>
</tr>
</tbody>
</table>
<section id="the-estimator" class="level3">
<h3 class="anchored" data-anchor-id="the-estimator">The Estimator</h3>
<p>Synthetic DiD finds:</p>
<ol type="1">
<li><strong>Unit weights</strong> <span class="math inline">\(\omega_i\)</span> (like SCM) — make controls look like treated pre-treatment</li>
<li><strong>Time weights</strong> <span class="math inline">\(\lambda_t\)</span> (novel) — emphasize pre-treatment periods that predict post-treatment</li>
</ol>
<p><span class="math display">\[
\hat{\tau}^{sdid} = \left(\bar{Y}_{tr,post}^{\omega} - \bar{Y}_{co,post}^{\omega}\right) - \left(\bar{Y}_{tr,pre}^{\lambda} - \bar{Y}_{co,pre}^{\omega,\lambda}\right)
\]</span></p>
<p>The optimization: <span class="math display">\[
\min_{\omega, \lambda} \sum_{i: \text{control}} \sum_{t \leq T_0} \left(Y_{it} - \lambda_t - \omega_i - \mu\right)^2 + \text{regularization}
\]</span></p>
</section>
<section id="advantages" class="level3">
<h3 class="anchored" data-anchor-id="advantages">Advantages</h3>
<ol type="1">
<li><strong>Works with multiple treated units</strong> (unlike classic SCM)</li>
<li><strong>Doesn’t require exact pre-treatment match</strong> (unlike SCM)</li>
<li><strong>Doesn’t require parallel trends</strong> (unlike DiD)</li>
<li><strong>Doubly robust</strong>: consistent if either unit OR time weights are correct</li>
</ol>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Illustrate multiple treated units scenario</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>sdid_data <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="at">treated =</span> unit <span class="sc">&lt;=</span> <span class="dv">3</span>,</span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="at">post =</span> time <span class="sc">&gt;</span> <span class="dv">10</span>,</span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="at">treatment =</span> treated <span class="sc">&amp;</span> post,</span>
<span id="cb4-10"><a href="#cb4-10"></a>    <span class="co"># Generate outcomes</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="at">unit_fe =</span> unit <span class="sc">*</span> <span class="fl">0.4</span>,</span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="at">time_trend =</span> <span class="fl">0.2</span> <span class="sc">*</span> time,</span>
<span id="cb4-13"><a href="#cb4-13"></a>    <span class="at">tau =</span> <span class="fu">ifelse</span>(treatment, <span class="dv">2</span>, <span class="dv">0</span>),</span>
<span id="cb4-14"><a href="#cb4-14"></a>    <span class="at">y =</span> unit_fe <span class="sc">+</span> time_trend <span class="sc">+</span> tau <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="fl">0.4</span>),</span>
<span id="cb4-15"><a href="#cb4-15"></a>    <span class="at">group =</span> <span class="fu">ifelse</span>(treated, <span class="st">"Treated (3 units)"</span>, <span class="st">"Control (5 units)"</span>)</span>
<span id="cb4-16"><a href="#cb4-16"></a>  )</span>
<span id="cb4-17"><a href="#cb4-17"></a></span>
<span id="cb4-18"><a href="#cb4-18"></a><span class="co"># Aggregate by group</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>agg_data <span class="ot">&lt;-</span> sdid_data <span class="sc">%&gt;%</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>  <span class="fu">group_by</span>(time, group) <span class="sc">%&gt;%</span></span>
<span id="cb4-21"><a href="#cb4-21"></a>  <span class="fu">summarize</span>(<span class="at">y =</span> <span class="fu">mean</span>(y), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb4-22"><a href="#cb4-22"></a></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="fu">ggplot</span>(agg_data, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">10.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-26"><a href="#cb4-26"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Control (5 units)"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>,</span>
<span id="cb4-27"><a href="#cb4-27"></a>                                 <span class="st">"Treated (3 units)"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">11</span>, <span class="at">y =</span> <span class="fu">max</span>(agg_data<span class="sc">$</span>y) <span class="sc">*</span> <span class="fl">0.95</span>,</span>
<span id="cb4-29"><a href="#cb4-29"></a>           <span class="at">label =</span> <span class="st">"Treatment"</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb4-30"><a href="#cb4-30"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic DiD: Multiple Treated Units"</span>,</span>
<span id="cb4-31"><a href="#cb4-31"></a>       <span class="at">subtitle =</span> <span class="st">"Synthetic DiD reweights controls to match treated pre-treatment trajectory"</span>,</span>
<span id="cb4-32"><a href="#cb4-32"></a>       <span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"Average Outcome"</span>,</span>
<span id="cb4-33"><a href="#cb4-33"></a>       <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb4-34"><a href="#cb4-34"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_synthetic_control_files/figure-html/sdid-comparison-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Synthetic DiD handles multiple treated units</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="implementation-in-r" class="level1 unnumbered">
<h1 class="unnumbered">Implementation in R</h1>
<section id="using-augsynth-package" class="level2">
<h2 class="anchored" data-anchor-id="using-augsynth-package">Using <code>augsynth</code> Package</h2>
<p>The <code>augsynth</code> package by Ben-Michael et al.&nbsp;implements <strong>augmented synthetic control</strong>, which combines SCM with outcome modeling (Ridge regression) for improved finite-sample performance.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">library</span>(augsynth)</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co"># Basic synthetic control</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>syn <span class="ot">&lt;-</span> <span class="fu">augsynth</span>(</span>
<span id="cb5-5"><a href="#cb5-5"></a>  outcome <span class="sc">~</span> treatment <span class="sc">|</span> covariate1 <span class="sc">+</span> covariate2,  <span class="co"># outcome ~ treatment | predictors</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>  <span class="at">unit =</span> unit_id,</span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="at">time =</span> time_id,</span>
<span id="cb5-8"><a href="#cb5-8"></a>  <span class="at">data =</span> panel_data,</span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="at">t_int =</span> treatment_time,    <span class="co"># when treatment begins</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>  <span class="at">progfunc =</span> <span class="st">"Ridge"</span>         <span class="co"># augmentation: "None", "Ridge", "EN"</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>)</span>
<span id="cb5-12"><a href="#cb5-12"></a></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co"># Results</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="fu">summary</span>(syn)</span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="fu">plot</span>(syn)</span>
<span id="cb5-16"><a href="#cb5-16"></a></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co"># Extract weights</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>syn<span class="sc">$</span>weights</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="key-arguments" class="level3">
<h3 class="anchored" data-anchor-id="key-arguments">Key Arguments</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 43%">
<col style="width: 56%">
</colgroup>
<thead>
<tr class="header">
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>progfunc</code></td>
<td>Augmentation method: <code>"None"</code> (pure SCM), <code>"Ridge"</code>, <code>"EN"</code> (elastic net)</td>
</tr>
<tr class="even">
<td><code>t_int</code></td>
<td>Treatment time (integer or date)</td>
</tr>
<tr class="odd">
<td><code>fixedeff</code></td>
<td>Include unit fixed effects in augmentation?</td>
</tr>
</tbody>
</table>
</section>
<section id="multiple-treated-units-with-multisynth" class="level3">
<h3 class="anchored" data-anchor-id="multiple-treated-units-with-multisynth">Multiple Treated Units with <code>multisynth</code></h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># When multiple units are treated (possibly at different times)</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>multi_syn <span class="ot">&lt;-</span> <span class="fu">multisynth</span>(</span>
<span id="cb6-3"><a href="#cb6-3"></a>  outcome <span class="sc">~</span> treatment <span class="sc">|</span> covariates,</span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="at">unit =</span> unit_id,</span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="at">time =</span> time_id,</span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="at">data =</span> panel_data,</span>
<span id="cb6-7"><a href="#cb6-7"></a>  <span class="at">n_leads =</span> <span class="dv">8</span>,      <span class="co"># post-treatment horizons to estimate</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="at">n_lags =</span> <span class="dv">4</span>        <span class="co"># pre-treatment periods to match</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>)</span>
<span id="cb6-10"><a href="#cb6-10"></a></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="fu">summary</span>(multi_syn)</span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="fu">plot</span>(multi_syn)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="using-synthdid-package" class="level2">
<h2 class="anchored" data-anchor-id="using-synthdid-package">Using <code>synthdid</code> Package</h2>
<p>The <code>synthdid</code> package by Arkhangelsky et al.&nbsp;implements <strong>Synthetic Difference-in-Differences</strong>.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">library</span>(synthdid)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co"># Prepare data as matrices</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co"># Y: units × time matrix of outcomes</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>Y <span class="ot">&lt;-</span> panel_data <span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> unit, <span class="at">names_from =</span> time, <span class="at">values_from =</span> outcome) <span class="sc">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"unit"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb7-9"><a href="#cb7-9"></a></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co"># W: units × time matrix of treatment indicators (1 if treated)</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>W <span class="ot">&lt;-</span> panel_data <span class="sc">%&gt;%</span></span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> unit, <span class="at">names_from =</span> time, <span class="at">values_from =</span> treated) <span class="sc">%&gt;%</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"unit"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb7-15"><a href="#cb7-15"></a></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="co"># Synthetic DiD estimate</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>tau_sdid <span class="ot">&lt;-</span> <span class="fu">synthdid_estimate</span>(Y, W)</span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="co"># Standard error (placebo-based)</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>se_sdid <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">vcov</span>(tau_sdid, <span class="at">method =</span> <span class="st">"placebo"</span>))</span>
<span id="cb7-21"><a href="#cb7-21"></a></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="co"># Compare to pure SC and pure DiD</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>tau_sc <span class="ot">&lt;-</span> <span class="fu">sc_estimate</span>(Y, W)</span>
<span id="cb7-24"><a href="#cb7-24"></a>tau_did <span class="ot">&lt;-</span> <span class="fu">did_estimate</span>(Y, W)</span>
<span id="cb7-25"><a href="#cb7-25"></a></span>
<span id="cb7-26"><a href="#cb7-26"></a><span class="co"># Visualize</span></span>
<span id="cb7-27"><a href="#cb7-27"></a><span class="fu">synthdid_plot</span>(tau_sdid)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="worked-example" class="level2">
<h2 class="anchored" data-anchor-id="worked-example">Worked Example</h2>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co"># Create synthetic panel data for demonstration</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a>n_units <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>n_periods <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>treatment_time <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co"># Unit 1 is treated</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>panel <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb8-9"><a href="#cb8-9"></a>  <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span>n_units,</span>
<span id="cb8-10"><a href="#cb8-10"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>n_periods</span>
<span id="cb8-11"><a href="#cb8-11"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-13"><a href="#cb8-13"></a>    <span class="at">treated_unit =</span> (unit <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb8-14"><a href="#cb8-14"></a>    <span class="at">post =</span> (time <span class="sc">&gt;=</span> treatment_time),</span>
<span id="cb8-15"><a href="#cb8-15"></a>    <span class="at">treatment =</span> treated_unit <span class="sc">&amp;</span> post,</span>
<span id="cb8-16"><a href="#cb8-16"></a>    <span class="co"># Pre-treatment characteristics</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>    <span class="at">x1 =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> unit<span class="sc">/</span><span class="dv">5</span>, <span class="at">sd =</span> <span class="fl">0.3</span>),</span>
<span id="cb8-18"><a href="#cb8-18"></a>    <span class="at">x2 =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> time<span class="sc">/</span><span class="dv">10</span>, <span class="at">sd =</span> <span class="fl">0.2</span>),</span>
<span id="cb8-19"><a href="#cb8-19"></a>    <span class="co"># Outcome with treatment effect for unit 1</span></span>
<span id="cb8-20"><a href="#cb8-20"></a>    <span class="at">unit_fe =</span> unit <span class="sc">*</span> <span class="fl">0.5</span>,</span>
<span id="cb8-21"><a href="#cb8-21"></a>    <span class="at">time_fe =</span> <span class="fl">0.15</span> <span class="sc">*</span> time,</span>
<span id="cb8-22"><a href="#cb8-22"></a>    <span class="at">tau =</span> <span class="fu">ifelse</span>(treatment, <span class="sc">-</span><span class="fl">2.5</span> <span class="sc">-</span> <span class="fl">0.1</span><span class="sc">*</span>(time <span class="sc">-</span> treatment_time), <span class="dv">0</span>),</span>
<span id="cb8-23"><a href="#cb8-23"></a>    <span class="at">y =</span> unit_fe <span class="sc">+</span> time_fe <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>x2 <span class="sc">+</span> tau <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="fl">0.4</span>)</span>
<span id="cb8-24"><a href="#cb8-24"></a>  )</span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="co"># --- Manual SCM Implementation ---</span></span>
<span id="cb8-27"><a href="#cb8-27"></a></span>
<span id="cb8-28"><a href="#cb8-28"></a><span class="co"># Pre-treatment data</span></span>
<span id="cb8-29"><a href="#cb8-29"></a>pre_data <span class="ot">&lt;-</span> panel <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">&lt;</span> treatment_time)</span>
<span id="cb8-30"><a href="#cb8-30"></a></span>
<span id="cb8-31"><a href="#cb8-31"></a><span class="co"># Treated unit pre-treatment outcomes</span></span>
<span id="cb8-32"><a href="#cb8-32"></a>y_treated_pre <span class="ot">&lt;-</span> pre_data <span class="sc">%&gt;%</span></span>
<span id="cb8-33"><a href="#cb8-33"></a>  <span class="fu">filter</span>(unit <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-34"><a href="#cb8-34"></a>  <span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb8-35"><a href="#cb8-35"></a>  <span class="fu">pull</span>(y)</span>
<span id="cb8-36"><a href="#cb8-36"></a></span>
<span id="cb8-37"><a href="#cb8-37"></a><span class="co"># Donor pre-treatment outcomes (matrix: time × donors)</span></span>
<span id="cb8-38"><a href="#cb8-38"></a>Y_donors_pre <span class="ot">&lt;-</span> pre_data <span class="sc">%&gt;%</span></span>
<span id="cb8-39"><a href="#cb8-39"></a>  <span class="fu">filter</span>(unit <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-40"><a href="#cb8-40"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> time, <span class="at">names_from =</span> unit, <span class="at">values_from =</span> y) <span class="sc">%&gt;%</span></span>
<span id="cb8-41"><a href="#cb8-41"></a>  <span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb8-42"><a href="#cb8-42"></a>  <span class="fu">select</span>(<span class="sc">-</span>time) <span class="sc">%&gt;%</span></span>
<span id="cb8-43"><a href="#cb8-43"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb8-44"><a href="#cb8-44"></a></span>
<span id="cb8-45"><a href="#cb8-45"></a><span class="co"># Find weights via constrained least squares (simplified)</span></span>
<span id="cb8-46"><a href="#cb8-46"></a><span class="co"># In practice, use quadprog or augsynth</span></span>
<span id="cb8-47"><a href="#cb8-47"></a><span class="co"># Here: OLS projection then normalize positive weights</span></span>
<span id="cb8-48"><a href="#cb8-48"></a></span>
<span id="cb8-49"><a href="#cb8-49"></a>weights_raw <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(y_treated_pre <span class="sc">~</span> Y_donors_pre <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb8-50"><a href="#cb8-50"></a>weights_raw[<span class="fu">is.na</span>(weights_raw) <span class="sc">|</span> weights_raw <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb8-51"><a href="#cb8-51"></a>weights <span class="ot">&lt;-</span> weights_raw <span class="sc">/</span> <span class="fu">sum</span>(weights_raw)</span>
<span id="cb8-52"><a href="#cb8-52"></a></span>
<span id="cb8-53"><a href="#cb8-53"></a><span class="co"># Construct synthetic control for all periods</span></span>
<span id="cb8-54"><a href="#cb8-54"></a>synthetic <span class="ot">&lt;-</span> panel <span class="sc">%&gt;%</span></span>
<span id="cb8-55"><a href="#cb8-55"></a>  <span class="fu">filter</span>(unit <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-56"><a href="#cb8-56"></a>  <span class="fu">left_join</span>(</span>
<span id="cb8-57"><a href="#cb8-57"></a>    <span class="fu">data.frame</span>(<span class="at">unit =</span> <span class="dv">2</span><span class="sc">:</span>n_units, <span class="at">weight =</span> weights),</span>
<span id="cb8-58"><a href="#cb8-58"></a>    <span class="at">by =</span> <span class="st">"unit"</span></span>
<span id="cb8-59"><a href="#cb8-59"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb8-60"><a href="#cb8-60"></a>  <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb8-61"><a href="#cb8-61"></a>  <span class="fu">summarize</span>(<span class="at">y_synth =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb8-62"><a href="#cb8-62"></a></span>
<span id="cb8-63"><a href="#cb8-63"></a><span class="co"># Get treated outcomes</span></span>
<span id="cb8-64"><a href="#cb8-64"></a>treated_outcomes <span class="ot">&lt;-</span> panel <span class="sc">%&gt;%</span></span>
<span id="cb8-65"><a href="#cb8-65"></a>  <span class="fu">filter</span>(unit <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-66"><a href="#cb8-66"></a>  <span class="fu">select</span>(time, <span class="at">y_treated =</span> y)</span>
<span id="cb8-67"><a href="#cb8-67"></a></span>
<span id="cb8-68"><a href="#cb8-68"></a><span class="co"># Calculate gaps</span></span>
<span id="cb8-69"><a href="#cb8-69"></a>results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(treated_outcomes, synthetic, <span class="at">by =</span> <span class="st">"time"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-70"><a href="#cb8-70"></a>  <span class="fu">mutate</span>(<span class="at">gap =</span> y_treated <span class="sc">-</span> y_synth)</span>
<span id="cb8-71"><a href="#cb8-71"></a></span>
<span id="cb8-72"><a href="#cb8-72"></a><span class="co"># --- Visualization ---</span></span>
<span id="cb8-73"><a href="#cb8-73"></a></span>
<span id="cb8-74"><a href="#cb8-74"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb8-75"><a href="#cb8-75"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_treated, <span class="at">color =</span> <span class="st">"Treated"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb8-76"><a href="#cb8-76"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_synth, <span class="at">color =</span> <span class="st">"Synthetic"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb8-77"><a href="#cb8-77"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> treatment_time <span class="sc">-</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb8-78"><a href="#cb8-78"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Treated"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>, <span class="st">"Synthetic"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>)) <span class="sc">+</span></span>
<span id="cb8-79"><a href="#cb8-79"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Treated vs Synthetic Control"</span>,</span>
<span id="cb8-80"><a href="#cb8-80"></a>       <span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"Outcome"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb8-81"><a href="#cb8-81"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb8-82"><a href="#cb8-82"></a></span>
<span id="cb8-83"><a href="#cb8-83"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> gap)) <span class="sc">+</span></span>
<span id="cb8-84"><a href="#cb8-84"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"#9b59b6"</span>) <span class="sc">+</span></span>
<span id="cb8-85"><a href="#cb8-85"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="fu">pmin</span>(<span class="dv">0</span>, gap), <span class="at">ymax =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, gap)),</span>
<span id="cb8-86"><a href="#cb8-86"></a>              <span class="at">fill =</span> <span class="st">"#9b59b6"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb8-87"><a href="#cb8-87"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb8-88"><a href="#cb8-88"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> treatment_time <span class="sc">-</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb8-89"><a href="#cb8-89"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Estimated Treatment Effect"</span>,</span>
<span id="cb8-90"><a href="#cb8-90"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Post-treatment average gap: "</span>,</span>
<span id="cb8-91"><a href="#cb8-91"></a>                        <span class="fu">round</span>(<span class="fu">mean</span>(results<span class="sc">$</span>gap[results<span class="sc">$</span>time <span class="sc">&gt;=</span> treatment_time]), <span class="dv">2</span>)),</span>
<span id="cb8-92"><a href="#cb8-92"></a>       <span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"Gap (Treated - Synthetic)"</span>)</span>
<span id="cb8-93"><a href="#cb8-93"></a></span>
<span id="cb8-94"><a href="#cb8-94"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_synthetic_control_files/figure-html/worked-example-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Complete SCM analysis workflow</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="diagnostics-and-validation" class="level1 unnumbered">
<h1 class="unnumbered">Diagnostics and Validation</h1>
<section id="pre-treatment-fit" class="level2">
<h2 class="anchored" data-anchor-id="pre-treatment-fit">1. Pre-Treatment Fit</h2>
<p><strong>The most critical diagnostic</strong>: How well does the synthetic control match the treated unit before treatment?</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># Pre-treatment fit statistics</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>pre_fit <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">filter</span>(time <span class="sc">&lt;</span> treatment_time) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">summarize</span>(</span>
<span id="cb9-5"><a href="#cb9-5"></a>    <span class="at">RMSPE =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(gap<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb9-6"><a href="#cb9-6"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(gap)),</span>
<span id="cb9-7"><a href="#cb9-7"></a>    <span class="at">Max_Gap =</span> <span class="fu">max</span>(<span class="fu">abs</span>(gap)),</span>
<span id="cb9-8"><a href="#cb9-8"></a>    <span class="at">Mean_Gap =</span> <span class="fu">mean</span>(gap)</span>
<span id="cb9-9"><a href="#cb9-9"></a>  )</span>
<span id="cb9-10"><a href="#cb9-10"></a></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="fu">cat</span>(<span class="st">"Pre-Treatment Fit Diagnostics:</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Pre-Treatment Fit Diagnostics:</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">cat</span>(<span class="st">"  RMSPE:"</span>, <span class="fu">round</span>(pre_fit<span class="sc">$</span>RMSPE, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  RMSPE: 2.719 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="fu">cat</span>(<span class="st">"  MAE:"</span>, <span class="fu">round</span>(pre_fit<span class="sc">$</span>MAE, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  MAE: 2.702 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">cat</span>(<span class="st">"  Max Gap:"</span>, <span class="fu">round</span>(pre_fit<span class="sc">$</span>Max_Gap, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Max Gap: 3.112 </code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a><span class="fu">cat</span>(<span class="st">"  Mean Gap:"</span>, <span class="fu">round</span>(pre_fit<span class="sc">$</span>Mean_Gap, <span class="dv">4</span>), <span class="st">"(should be ~0)</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Mean Gap: -2.702 (should be ~0)</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Poor Pre-Treatment Fit
</div>
</div>
<div class="callout-body-container callout-body">
<p>If pre-treatment RMSPE is large (relative to the outcome’s scale), the synthetic control is unreliable. Consider:</p>
<ol type="1">
<li>Adding more pre-treatment periods as predictors</li>
<li>Using augmented SCM (<code>progfunc = "Ridge"</code>)</li>
<li>Acknowledging the limitation in your analysis</li>
</ol>
</div>
</div>
</section>
<section id="weight-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="weight-diagnostics">2. Weight Diagnostics</h2>
<p>Check if weights are <strong>sparse</strong> and <strong>sensible</strong>.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Weight distribution</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>weight_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb19-3"><a href="#cb19-3"></a>  <span class="at">unit =</span> <span class="dv">2</span><span class="sc">:</span>n_units,</span>
<span id="cb19-4"><a href="#cb19-4"></a>  <span class="at">weight =</span> weights</span>
<span id="cb19-5"><a href="#cb19-5"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6"></a>  <span class="fu">filter</span>(weight <span class="sc">&gt;</span> <span class="fl">0.001</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(weight))</span>
<span id="cb19-8"><a href="#cb19-8"></a></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="fu">cat</span>(<span class="st">"Donor Weights (non-zero):</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Donor Weights (non-zero):</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="fu">print</span>(weight_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>              unit     weight
Y_donors_pre9    9 0.43910267
Y_donors_pre2    2 0.24108540
Y_donors_pre5    5 0.15192859
Y_donors_pre3    3 0.12978169
Y_donors_pre7    7 0.03810165</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Number of donors with positive weight:"</span>, <span class="fu">sum</span>(weights <span class="sc">&gt;</span> <span class="fl">0.001</span>), <span class="st">"of"</span>, n_units <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Number of donors with positive weight: 5 of 14 </code></pre>
</div>
</div>
<p><strong>Good signs</strong>: - Sparse weights (few donors contribute) - Top donors make intuitive sense - No single donor dominates completely</p>
<p><strong>Bad signs</strong>: - Many donors with tiny weights (overfitting) - Counterintuitive donors receive high weight - One donor receives weight ≈ 1 (just using that unit as control)</p>
</section>
<section id="leave-one-out-sensitivity" class="level2">
<h2 class="anchored" data-anchor-id="leave-one-out-sensitivity">3. Leave-One-Out Sensitivity</h2>
<p>Remove each important donor and re-estimate. If results are robust, the effect doesn’t depend on any single donor.</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Identify top donors</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>top_donors <span class="ot">&lt;-</span> weight_df<span class="sc">$</span>unit[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">3</span>, <span class="fu">nrow</span>(weight_df))]</span>
<span id="cb25-3"><a href="#cb25-3"></a></span>
<span id="cb25-4"><a href="#cb25-4"></a><span class="co"># Leave-one-out analysis</span></span>
<span id="cb25-5"><a href="#cb25-5"></a>loo_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(top_donors, <span class="cf">function</span>(drop_unit) {</span>
<span id="cb25-6"><a href="#cb25-6"></a>  <span class="co"># Re-estimate without this donor</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>  Y_donors_loo <span class="ot">&lt;-</span> pre_data <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8"></a>    <span class="fu">filter</span>(unit <span class="sc">!=</span> <span class="dv">1</span>, unit <span class="sc">!=</span> drop_unit) <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9"></a>    <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> time, <span class="at">names_from =</span> unit, <span class="at">values_from =</span> y) <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>    <span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb25-11"><a href="#cb25-11"></a>    <span class="fu">select</span>(<span class="sc">-</span>time) <span class="sc">%&gt;%</span></span>
<span id="cb25-12"><a href="#cb25-12"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb25-13"><a href="#cb25-13"></a></span>
<span id="cb25-14"><a href="#cb25-14"></a>  <span class="co"># New weights</span></span>
<span id="cb25-15"><a href="#cb25-15"></a>  w_loo <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(y_treated_pre <span class="sc">~</span> Y_donors_loo <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb25-16"><a href="#cb25-16"></a>  w_loo[<span class="fu">is.na</span>(w_loo) <span class="sc">|</span> w_loo <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb25-17"><a href="#cb25-17"></a>  w_loo <span class="ot">&lt;-</span> w_loo <span class="sc">/</span> <span class="fu">sum</span>(w_loo)</span>
<span id="cb25-18"><a href="#cb25-18"></a></span>
<span id="cb25-19"><a href="#cb25-19"></a>  <span class="co"># New synthetic for post-treatment</span></span>
<span id="cb25-20"><a href="#cb25-20"></a>  remaining_units <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">2</span><span class="sc">:</span>n_units, drop_unit)</span>
<span id="cb25-21"><a href="#cb25-21"></a>  synth_loo <span class="ot">&lt;-</span> panel <span class="sc">%&gt;%</span></span>
<span id="cb25-22"><a href="#cb25-22"></a>    <span class="fu">filter</span>(unit <span class="sc">%in%</span> remaining_units, time <span class="sc">&gt;=</span> treatment_time) <span class="sc">%&gt;%</span></span>
<span id="cb25-23"><a href="#cb25-23"></a>    <span class="fu">left_join</span>(</span>
<span id="cb25-24"><a href="#cb25-24"></a>      <span class="fu">data.frame</span>(<span class="at">unit =</span> remaining_units, <span class="at">weight =</span> w_loo),</span>
<span id="cb25-25"><a href="#cb25-25"></a>      <span class="at">by =</span> <span class="st">"unit"</span></span>
<span id="cb25-26"><a href="#cb25-26"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb25-27"><a href="#cb25-27"></a>    <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb25-28"><a href="#cb25-28"></a>    <span class="fu">summarize</span>(<span class="at">y_synth =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb25-29"><a href="#cb25-29"></a></span>
<span id="cb25-30"><a href="#cb25-30"></a>  avg_gap <span class="ot">&lt;-</span> <span class="fu">mean</span>(treated_outcomes<span class="sc">$</span>y_treated[treated_outcomes<span class="sc">$</span>time <span class="sc">&gt;=</span> treatment_time] <span class="sc">-</span></span>
<span id="cb25-31"><a href="#cb25-31"></a>                  synth_loo<span class="sc">$</span>y_synth)</span>
<span id="cb25-32"><a href="#cb25-32"></a></span>
<span id="cb25-33"><a href="#cb25-33"></a>  <span class="fu">data.frame</span>(<span class="at">dropped =</span> <span class="fu">paste</span>(<span class="st">"Drop Unit"</span>, drop_unit), <span class="at">effect =</span> avg_gap)</span>
<span id="cb25-34"><a href="#cb25-34"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb25-35"><a href="#cb25-35"></a></span>
<span id="cb25-36"><a href="#cb25-36"></a><span class="co"># Add baseline</span></span>
<span id="cb25-37"><a href="#cb25-37"></a>baseline <span class="ot">&lt;-</span> <span class="fu">mean</span>(results<span class="sc">$</span>gap[results<span class="sc">$</span>time <span class="sc">&gt;=</span> treatment_time])</span>
<span id="cb25-38"><a href="#cb25-38"></a>loo_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb25-39"><a href="#cb25-39"></a>  <span class="fu">data.frame</span>(<span class="at">dropped =</span> <span class="st">"Baseline (none dropped)"</span>, <span class="at">effect =</span> baseline),</span>
<span id="cb25-40"><a href="#cb25-40"></a>  loo_results</span>
<span id="cb25-41"><a href="#cb25-41"></a>)</span>
<span id="cb25-42"><a href="#cb25-42"></a></span>
<span id="cb25-43"><a href="#cb25-43"></a><span class="fu">ggplot</span>(loo_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(dropped, effect), <span class="at">y =</span> effect)) <span class="sc">+</span></span>
<span id="cb25-44"><a href="#cb25-44"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"#3498db"</span>) <span class="sc">+</span></span>
<span id="cb25-45"><a href="#cb25-45"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> baseline, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#e74c3c"</span>) <span class="sc">+</span></span>
<span id="cb25-46"><a href="#cb25-46"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb25-47"><a href="#cb25-47"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Leave-One-Out Sensitivity"</span>,</span>
<span id="cb25-48"><a href="#cb25-48"></a>       <span class="at">subtitle =</span> <span class="st">"Effect estimate when each top donor is removed"</span>,</span>
<span id="cb25-49"><a href="#cb25-49"></a>       <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Estimated Treatment Effect"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="06_synthetic_control_files/figure-html/leave-one-out-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Leave-one-out sensitivity analysis</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="scm-vs.-did-decision-framework" class="level1 unnumbered">
<h1 class="unnumbered">SCM vs.&nbsp;DiD: Decision Framework</h1>
<section id="when-to-use-which" class="level2">
<h2 class="anchored" data-anchor-id="when-to-use-which">When to Use Which?</h2>
<pre><code>How many treated units?
├── One treated unit
│   └── Use Synthetic Control
│       └── Enough donors with good pre-treatment fit?
│           ├── Yes → Classic SCM or Augmented SCM
│           └── No → Consider qualitative analysis
└── Multiple treated units
    ├── Same treatment timing?
    │   ├── Yes → DiD or Synthetic DiD
    │   └── No (staggered) → Staggered DiD methods (Module 5) or Synthetic DiD
    └── Trust parallel trends?
        ├── Yes → Standard DiD
        └── No → Synthetic DiD (reweights to match)</code></pre>
</section>
<section id="comparison-table" class="level2">
<h2 class="anchored" data-anchor-id="comparison-table">Comparison Table</h2>
<table class="caption-top table">
<thead>
<tr class="header">
<th>Feature</th>
<th>DiD</th>
<th>SCM</th>
<th>Synthetic DiD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong># Treated</strong></td>
<td>Many</td>
<td>One</td>
<td>One or many</td>
</tr>
<tr class="even">
<td><strong>Parallel trends</strong></td>
<td>Required</td>
<td>Not required</td>
<td>Not required</td>
</tr>
<tr class="odd">
<td><strong>Pre-treatment fit</strong></td>
<td>Implicit</td>
<td>Explicit (visible)</td>
<td>Explicit</td>
</tr>
<tr class="even">
<td><strong>Inference</strong></td>
<td>Standard</td>
<td>Permutation</td>
<td>Placebo/Bootstrap</td>
</tr>
<tr class="odd">
<td><strong>Transparency</strong></td>
<td>Moderate</td>
<td>High (weights)</td>
<td>High</td>
</tr>
<tr class="even">
<td><strong>Covariates</strong></td>
<td>Easy</td>
<td>Via predictors</td>
<td>Via augmentation</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="common-pitfalls" class="level1 unnumbered">
<h1 class="unnumbered">Common Pitfalls</h1>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>1. Interpolation vs.&nbsp;Extrapolation
</div>
</div>
<div class="callout-body-container callout-body">
<p>SCM works by <strong>interpolation</strong>—the synthetic unit must lie within the convex hull of donors. If the treated unit is extreme (outside the range of donors), SCM extrapolates and becomes unreliable.</p>
<p><strong>Check</strong>: Are the treated unit’s pre-treatment characteristics within the range of donors?</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>2. Overfitting Pre-Treatment Noise
</div>
</div>
<div class="callout-body-container callout-body">
<p>With many pre-treatment periods and few donors, SCM can overfit noise rather than signal.</p>
<p><strong>Solutions</strong>: - Use augmented SCM (<code>progfunc = "Ridge"</code>) - Check if weights are sensible - Validate with leave-one-out</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>3. Small Donor Pool
</div>
</div>
<div class="callout-body-container callout-body">
<p>With few donors (&lt; 10), permutation inference has limited power. You may not be able to reject the null even with a real effect.</p>
<p><strong>Solution</strong>: Be transparent about power limitations. Consider combining with qualitative evidence.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>4. Spillovers / SUTVA Violation
</div>
</div>
<div class="callout-body-container callout-body">
<p>If treatment affects donor units (e.g., trade diversion, policy spillovers), the synthetic control is contaminated.</p>
<p><strong>Solution</strong>: Exclude donors likely affected by spillovers. Test sensitivity to donor pool composition.</p>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>5. Anticipation Effects
</div>
</div>
<div class="callout-body-container callout-body">
<p>If units anticipate treatment and adjust behavior before the official treatment date, pre-treatment fit is compromised.</p>
<p><strong>Solution</strong>: Use an earlier treatment date cutoff, or exclude periods with possible anticipation.</p>
</div>
</div>
</section>
<section id="summary" class="level1 unnumbered">
<h1 class="unnumbered">Summary</h1>
<p>Key takeaways:</p>
<ol type="1">
<li><p><strong>SCM constructs counterfactuals</strong> by weighting untreated units to match the treated unit’s pre-treatment trajectory</p></li>
<li><p><strong>The optimization</strong> minimizes pre-treatment prediction error subject to convex weights</p></li>
<li><p><strong>Inference via permutation</strong>: Apply SCM to each donor as placebo; compare treated unit’s gap to placebo distribution</p></li>
<li><p><strong>RMSPE ratio</strong> normalizes by pre-treatment fit quality</p></li>
<li><p><strong>Synthetic DiD</strong> extends SCM to multiple treated units without requiring parallel trends</p></li>
<li><p><strong>Key diagnostics</strong>:</p>
<ul>
<li>Pre-treatment fit (RMSPE)</li>
<li>Weight sparsity and sensibility</li>
<li>Leave-one-out sensitivity</li>
</ul></li>
<li><p><strong>Use SCM when</strong>: one (or few) treated units, no natural control group, parallel trends questionable</p></li>
<li><p><strong>Software</strong>: <code>augsynth</code> for augmented SCM, <code>synthdid</code> for Synthetic DiD</p></li>
</ol>
<hr>
<section id="key-references" class="level2">
<h2 class="anchored" data-anchor-id="key-references">Key References</h2>
<p><strong>Foundational</strong>:</p>
<ul>
<li>Abadie &amp; Gardeazabal (2003). “The Economic Costs of Conflict.” <em>AER</em></li>
<li>Abadie, Diamond &amp; Hainmueller (2010). “Synthetic Control Methods for Comparative Case Studies.” <em>JASA</em></li>
<li>Abadie, Diamond &amp; Hainmueller (2015). “Comparative Politics and the Synthetic Control Method.” <em>AJPS</em></li>
<li>Abadie (2021). “Using Synthetic Controls: Feasibility, Data Requirements, and Methodological Aspects.” <em>JEL</em></li>
</ul>
<p><strong>Extensions</strong>:</p>
<ul>
<li>Arkhangelsky et al.&nbsp;(2021). “Synthetic Difference-in-Differences.” <em>AER</em></li>
<li>Ben-Michael, Feller &amp; Rothstein (2021). “The Augmented Synthetic Control Method.” <em>JASA</em></li>
<li>Doudchenko &amp; Imbens (2016). “Balancing, Regression, Difference-in-Differences and Synthetic Control Methods.” <em>NBER WP</em></li>
</ul>
<p><strong>Inference</strong>:</p>
<ul>
<li>Firpo &amp; Possebom (2018). “Synthetic Control Method: Inference, Sensitivity Analysis and Confidence Sets.” <em>JCASP</em></li>
</ul>
<p><strong>R Packages</strong>:</p>
<ul>
<li><code>augsynth</code>: Ben-Michael et al.&nbsp;— Augmented synthetic control</li>
<li><code>synthdid</code>: Arkhangelsky et al.&nbsp;— Synthetic DiD</li>
<li><code>Synth</code>: Abadie et al.&nbsp;— Original SCM implementation</li>
</ul>
<hr>
<p><em>Next: <a href="../chapters/07_bayesian_foundations.html">Module 7: Bayesian Foundations</a></em></p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/05_staggered_did.html" class="pagination-link" aria-label="Staggered Difference-in-Differences">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-title">Staggered Difference-in-Differences</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/07_bayesian_foundations.html" class="pagination-link" aria-label="Bayesian Foundations">
        <span class="nav-page-text"><span class="chapter-title">Bayesian Foundations</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb27-1"><a href="#cb27-1"></a><span class="co">---</span></span>
<span id="cb27-2"><a href="#cb27-2"></a><span class="an">title:</span><span class="co"> "Synthetic Control Methods"</span></span>
<span id="cb27-3"><a href="#cb27-3"></a><span class="an">subtitle:</span><span class="co"> "Data-Driven Counterfactuals for Comparative Case Studies"</span></span>
<span id="cb27-4"><a href="#cb27-4"></a><span class="co">---</span></span>
<span id="cb27-5"><a href="#cb27-5"></a></span>
<span id="cb27-8"><a href="#cb27-8"></a><span class="in">```{r}</span></span>
<span id="cb27-9"><a href="#cb27-9"></a><span class="co">#| label: setup</span></span>
<span id="cb27-10"><a href="#cb27-10"></a><span class="co">#| include: false</span></span>
<span id="cb27-11"><a href="#cb27-11"></a></span>
<span id="cb27-12"><a href="#cb27-12"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb27-13"><a href="#cb27-13"></a>  <span class="at">echo =</span> <span class="cn">TRUE</span>, <span class="at">warning =</span> <span class="cn">FALSE</span>, <span class="at">message =</span> <span class="cn">FALSE</span>,</span>
<span id="cb27-14"><a href="#cb27-14"></a>  <span class="at">fig.width =</span> <span class="dv">10</span>, <span class="at">fig.height =</span> <span class="dv">6</span>, <span class="at">fig.align =</span> <span class="st">"center"</span></span>
<span id="cb27-15"><a href="#cb27-15"></a>)</span>
<span id="cb27-16"><a href="#cb27-16"></a></span>
<span id="cb27-17"><a href="#cb27-17"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb27-18"><a href="#cb27-18"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb27-19"><a href="#cb27-19"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb27-20"><a href="#cb27-20"></a></span>
<span id="cb27-21"><a href="#cb27-21"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>))</span>
<span id="cb27-22"><a href="#cb27-22"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb27-23"><a href="#cb27-23"></a><span class="in">```</span></span>
<span id="cb27-24"><a href="#cb27-24"></a></span>
<span id="cb27-25"><a href="#cb27-25"></a><span class="fu"># When DiD Fails {.unnumbered}</span></span>
<span id="cb27-26"><a href="#cb27-26"></a></span>
<span id="cb27-27"><a href="#cb27-27"></a>Difference-in-differences requires **parallel trends**—the assumption that treated and control groups would have followed similar paths absent treatment. But what happens when:</span>
<span id="cb27-28"><a href="#cb27-28"></a></span>
<span id="cb27-29"><a href="#cb27-29"></a><span class="ss">- </span>You have only **one treated unit**?</span>
<span id="cb27-30"><a href="#cb27-30"></a><span class="ss">- </span>No control unit has trends parallel to the treated unit?</span>
<span id="cb27-31"><a href="#cb27-31"></a><span class="ss">- </span>The treated unit is unique (e.g., West Germany, California, a specific country)?</span>
<span id="cb27-32"><a href="#cb27-32"></a></span>
<span id="cb27-33"><a href="#cb27-33"></a>**Synthetic Control Methods (SCM)** solve this by constructing a weighted combination of untreated units that together replicate the treated unit's pre-treatment trajectory. Instead of assuming parallel trends, SCM **matches** them.</span>
<span id="cb27-34"><a href="#cb27-34"></a></span>
<span id="cb27-35"><a href="#cb27-35"></a><span class="fu">## The Core Insight</span></span>
<span id="cb27-36"><a href="#cb27-36"></a></span>
<span id="cb27-37"><a href="#cb27-37"></a><span class="pp">|</span> Method <span class="pp">|</span> Comparison Unit <span class="pp">|</span> Key Assumption <span class="pp">|</span></span>
<span id="cb27-38"><a href="#cb27-38"></a><span class="pp">|--------|----------------|----------------|</span></span>
<span id="cb27-39"><a href="#cb27-39"></a><span class="pp">|</span> DiD <span class="pp">|</span> Actual control group <span class="pp">|</span> Parallel trends <span class="pp">|</span></span>
<span id="cb27-40"><a href="#cb27-40"></a><span class="pp">|</span> SCM <span class="pp">|</span> **Synthetic** control (weighted donors) <span class="pp">|</span> Weights match pre-treatment outcomes <span class="pp">|</span></span>
<span id="cb27-41"><a href="#cb27-41"></a></span>
<span id="cb27-42"><a href="#cb27-42"></a>SCM is transparent: you see exactly which units contribute to the counterfactual and with what weights.</span>
<span id="cb27-43"><a href="#cb27-43"></a></span>
<span id="cb27-44"><a href="#cb27-44"></a><span class="fu"># The SCM Framework {.unnumbered}</span></span>
<span id="cb27-45"><a href="#cb27-45"></a></span>
<span id="cb27-46"><a href="#cb27-46"></a><span class="fu">## Abadie, Diamond &amp; Hainmueller (2010, 2015)</span></span>
<span id="cb27-47"><a href="#cb27-47"></a></span>
<span id="cb27-48"><a href="#cb27-48"></a><span class="fu">### Setup and Notation</span></span>
<span id="cb27-49"><a href="#cb27-49"></a></span>
<span id="cb27-50"><a href="#cb27-50"></a>Following the foundational papers:</span>
<span id="cb27-51"><a href="#cb27-51"></a></span>
<span id="cb27-52"><a href="#cb27-52"></a>$$</span>
<span id="cb27-53"><a href="#cb27-53"></a>\begin{aligned}</span>
<span id="cb27-54"><a href="#cb27-54"></a>&amp;\text{Treated unit: } i = 1 <span class="sc">\\</span></span>
<span id="cb27-55"><a href="#cb27-55"></a>&amp;\text{Donor pool: } i = 2, \ldots, J+1 <span class="sc">\\</span></span>
<span id="cb27-56"><a href="#cb27-56"></a>&amp;\text{Pre-treatment: } t = 1, \ldots, T_0 <span class="sc">\\</span></span>
<span id="cb27-57"><a href="#cb27-57"></a>&amp;\text{Post-treatment: } t = T_0+1, \ldots, T</span>
<span id="cb27-58"><a href="#cb27-58"></a>\end{aligned}</span>
<span id="cb27-59"><a href="#cb27-59"></a>$$</span>
<span id="cb27-60"><a href="#cb27-60"></a></span>
<span id="cb27-61"><a href="#cb27-61"></a>We want to estimate the treatment effect:</span>
<span id="cb27-62"><a href="#cb27-62"></a>$$</span>
<span id="cb27-63"><a href="#cb27-63"></a>\tau_{1t} = Y_{1t}(1) - Y_{1t}(0) \quad \text{for } t &gt; T_0</span>
<span id="cb27-64"><a href="#cb27-64"></a>$$</span>
<span id="cb27-65"><a href="#cb27-65"></a></span>
<span id="cb27-66"><a href="#cb27-66"></a>We observe $Y_{1t}(1)$ (the actual outcome under treatment). The challenge is estimating $Y_{1t}(0)$—what would have happened without treatment.</span>
<span id="cb27-67"><a href="#cb27-67"></a></span>
<span id="cb27-68"><a href="#cb27-68"></a><span class="fu">### The Synthetic Control Estimator</span></span>
<span id="cb27-69"><a href="#cb27-69"></a></span>
<span id="cb27-70"><a href="#cb27-70"></a>Find weights $W^* = (w_2, \ldots, w_{J+1})'$ that solve:</span>
<span id="cb27-71"><a href="#cb27-71"></a></span>
<span id="cb27-72"><a href="#cb27-72"></a>$$</span>
<span id="cb27-73"><a href="#cb27-73"></a>\min_W <span class="sc">\|</span>X_1 - X_0 W<span class="sc">\|</span>_V \quad \text{subject to } w_j \geq 0, \sum_{j=2}^{J+1} w_j = 1</span>
<span id="cb27-74"><a href="#cb27-74"></a>$$</span>
<span id="cb27-75"><a href="#cb27-75"></a></span>
<span id="cb27-76"><a href="#cb27-76"></a>where:</span>
<span id="cb27-77"><a href="#cb27-77"></a></span>
<span id="cb27-78"><a href="#cb27-78"></a><span class="ss">- </span>$X_1$ = vector of pre-treatment characteristics of treated unit</span>
<span id="cb27-79"><a href="#cb27-79"></a><span class="ss">- </span>$X_0$ = matrix of pre-treatment characteristics of donor units</span>
<span id="cb27-80"><a href="#cb27-80"></a><span class="ss">- </span>$V$ = diagonal weight matrix (predictor importance)</span>
<span id="cb27-81"><a href="#cb27-81"></a><span class="ss">- </span>Constraints ensure weights are non-negative and sum to one (convex combination)</span>
<span id="cb27-82"><a href="#cb27-82"></a></span>
<span id="cb27-83"><a href="#cb27-83"></a>**The synthetic control outcome**:</span>
<span id="cb27-84"><a href="#cb27-84"></a>$$</span>
<span id="cb27-85"><a href="#cb27-85"></a>\hat{Y}_{1t}(0) = \sum_{j=2}^{J+1} w_j^* Y_{jt}</span>
<span id="cb27-86"><a href="#cb27-86"></a>$$</span>
<span id="cb27-87"><a href="#cb27-87"></a></span>
<span id="cb27-88"><a href="#cb27-88"></a>**The treatment effect estimate**:</span>
<span id="cb27-89"><a href="#cb27-89"></a>$$</span>
<span id="cb27-90"><a href="#cb27-90"></a>\hat{\tau}_{1t} = Y_{1t} - \sum_{j=2}^{J+1} w_j^* Y_{jt}</span>
<span id="cb27-91"><a href="#cb27-91"></a>$$</span>
<span id="cb27-92"><a href="#cb27-92"></a></span>
<span id="cb27-95"><a href="#cb27-95"></a><span class="in">```{r}</span></span>
<span id="cb27-96"><a href="#cb27-96"></a><span class="co">#| label: scm-visual</span></span>
<span id="cb27-97"><a href="#cb27-97"></a><span class="co">#| fig-cap: "Synthetic control: construct counterfactual from weighted donors"</span></span>
<span id="cb27-98"><a href="#cb27-98"></a></span>
<span id="cb27-99"><a href="#cb27-99"></a><span class="co"># Simulate SCM scenario</span></span>
<span id="cb27-100"><a href="#cb27-100"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb27-101"><a href="#cb27-101"></a>T_total <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb27-102"><a href="#cb27-102"></a>T0 <span class="ot">&lt;-</span> <span class="dv">12</span>  <span class="co"># Treatment after period 12</span></span>
<span id="cb27-103"><a href="#cb27-103"></a></span>
<span id="cb27-104"><a href="#cb27-104"></a><span class="co"># Treated unit trajectory</span></span>
<span id="cb27-105"><a href="#cb27-105"></a>treated_base <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rnorm</span>(T0<span class="dv">-1</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>)))</span>
<span id="cb27-106"><a href="#cb27-106"></a>treated_post <span class="ot">&lt;-</span> treated_base[T0] <span class="sc">+</span> <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(T_total <span class="sc">-</span> T0, <span class="sc">-</span><span class="fl">0.1</span>, <span class="fl">0.25</span>))</span>
<span id="cb27-107"><a href="#cb27-107"></a>treated <span class="ot">&lt;-</span> <span class="fu">c</span>(treated_base, treated_post)</span>
<span id="cb27-108"><a href="#cb27-108"></a></span>
<span id="cb27-109"><a href="#cb27-109"></a><span class="co"># Donor units (5 potential controls)</span></span>
<span id="cb27-110"><a href="#cb27-110"></a>donors <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="cf">function</span>(i) {</span>
<span id="cb27-111"><a href="#cb27-111"></a>  base <span class="ot">&lt;-</span> <span class="fu">cumsum</span>(<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rnorm</span>(T_total<span class="dv">-1</span>, <span class="fl">0.25</span> <span class="sc">+</span> <span class="fl">0.05</span><span class="sc">*</span>i, <span class="fl">0.3</span>)))</span>
<span id="cb27-112"><a href="#cb27-112"></a>  <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_total, <span class="at">unit =</span> <span class="fu">paste</span>(<span class="st">"Donor"</span>, i), <span class="at">y =</span> base)</span>
<span id="cb27-113"><a href="#cb27-113"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb27-114"><a href="#cb27-114"></a></span>
<span id="cb27-115"><a href="#cb27-115"></a><span class="co"># Optimal weights (illustrative - found to match pre-treatment)</span></span>
<span id="cb27-116"><a href="#cb27-116"></a>weights <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.45</span>, <span class="fl">0.30</span>, <span class="fl">0.15</span>, <span class="fl">0.10</span>, <span class="fl">0.00</span>)</span>
<span id="cb27-117"><a href="#cb27-117"></a></span>
<span id="cb27-118"><a href="#cb27-118"></a><span class="co"># Construct synthetic control</span></span>
<span id="cb27-119"><a href="#cb27-119"></a>synthetic <span class="ot">&lt;-</span> donors <span class="sc">%&gt;%</span></span>
<span id="cb27-120"><a href="#cb27-120"></a>  <span class="fu">mutate</span>(<span class="at">weight =</span> <span class="fu">case_when</span>(</span>
<span id="cb27-121"><a href="#cb27-121"></a>    unit <span class="sc">==</span> <span class="st">"Donor 1"</span> <span class="sc">~</span> weights[<span class="dv">1</span>],</span>
<span id="cb27-122"><a href="#cb27-122"></a>    unit <span class="sc">==</span> <span class="st">"Donor 2"</span> <span class="sc">~</span> weights[<span class="dv">2</span>],</span>
<span id="cb27-123"><a href="#cb27-123"></a>    unit <span class="sc">==</span> <span class="st">"Donor 3"</span> <span class="sc">~</span> weights[<span class="dv">3</span>],</span>
<span id="cb27-124"><a href="#cb27-124"></a>    unit <span class="sc">==</span> <span class="st">"Donor 4"</span> <span class="sc">~</span> weights[<span class="dv">4</span>],</span>
<span id="cb27-125"><a href="#cb27-125"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> weights[<span class="dv">5</span>]</span>
<span id="cb27-126"><a href="#cb27-126"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb27-127"><a href="#cb27-127"></a>  <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb27-128"><a href="#cb27-128"></a>  <span class="fu">summarize</span>(<span class="at">y =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weight), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb27-129"><a href="#cb27-129"></a></span>
<span id="cb27-130"><a href="#cb27-130"></a><span class="co"># Combine for plotting</span></span>
<span id="cb27-131"><a href="#cb27-131"></a>treated_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_total, <span class="at">y =</span> treated, <span class="at">unit =</span> <span class="st">"Treated"</span>)</span>
<span id="cb27-132"><a href="#cb27-132"></a></span>
<span id="cb27-133"><a href="#cb27-133"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb27-134"><a href="#cb27-134"></a>  <span class="co"># Donor units (faded)</span></span>
<span id="cb27-135"><a href="#cb27-135"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> donors, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y, <span class="at">group =</span> unit),</span>
<span id="cb27-136"><a href="#cb27-136"></a>            <span class="at">color =</span> <span class="st">"gray70"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb27-137"><a href="#cb27-137"></a>  <span class="co"># Synthetic control</span></span>
<span id="cb27-138"><a href="#cb27-138"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> synthetic, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb27-139"><a href="#cb27-139"></a>            <span class="at">color =</span> <span class="st">"#3498db"</span>, <span class="at">linewidth =</span> <span class="fl">1.3</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb27-140"><a href="#cb27-140"></a>  <span class="co"># Treated unit</span></span>
<span id="cb27-141"><a href="#cb27-141"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> treated_df, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y),</span>
<span id="cb27-142"><a href="#cb27-142"></a>            <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">linewidth =</span> <span class="fl">1.3</span>) <span class="sc">+</span></span>
<span id="cb27-143"><a href="#cb27-143"></a>  <span class="co"># Treatment line</span></span>
<span id="cb27-144"><a href="#cb27-144"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> T0 <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb27-145"><a href="#cb27-145"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> T0 <span class="sc">+</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="fu">max</span>(treated) <span class="sc">*</span> <span class="fl">0.95</span>,</span>
<span id="cb27-146"><a href="#cb27-146"></a>           <span class="at">label =</span> <span class="st">"Treatment"</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb27-147"><a href="#cb27-147"></a>  <span class="co"># Gap annotation</span></span>
<span id="cb27-148"><a href="#cb27-148"></a>  <span class="fu">annotate</span>(<span class="st">"segment"</span>, <span class="at">x =</span> T_total <span class="sc">-</span> <span class="dv">1</span>, <span class="at">xend =</span> T_total <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb27-149"><a href="#cb27-149"></a>           <span class="at">y =</span> treated[T_total<span class="dv">-1</span>], <span class="at">yend =</span> synthetic<span class="sc">$</span>y[T_total<span class="dv">-1</span>],</span>
<span id="cb27-150"><a href="#cb27-150"></a>           <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">ends =</span> <span class="st">"both"</span>, <span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.08</span>, <span class="st">"inches"</span>)),</span>
<span id="cb27-151"><a href="#cb27-151"></a>           <span class="at">color =</span> <span class="st">"#9b59b6"</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb27-152"><a href="#cb27-152"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> T_total <span class="sc">-</span> <span class="fl">0.5</span>,</span>
<span id="cb27-153"><a href="#cb27-153"></a>           <span class="at">y =</span> <span class="fu">mean</span>(<span class="fu">c</span>(treated[T_total<span class="dv">-1</span>], synthetic<span class="sc">$</span>y[T_total<span class="dv">-1</span>])),</span>
<span id="cb27-154"><a href="#cb27-154"></a>           <span class="at">label =</span> <span class="fu">expression</span>(<span class="fu">hat</span>(tau)), <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"#9b59b6"</span>) <span class="sc">+</span></span>
<span id="cb27-155"><a href="#cb27-155"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic Control Method"</span>,</span>
<span id="cb27-156"><a href="#cb27-156"></a>       <span class="at">subtitle =</span> <span class="st">"Red = Treated | Blue dashed = Synthetic Control | Gray = Donor Pool"</span>,</span>
<span id="cb27-157"><a href="#cb27-157"></a>       <span class="at">x =</span> <span class="st">"Time Period"</span>, <span class="at">y =</span> <span class="st">"Outcome"</span>) <span class="sc">+</span></span>
<span id="cb27-158"><a href="#cb27-158"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb27-159"><a href="#cb27-159"></a><span class="in">```</span></span>
<span id="cb27-160"><a href="#cb27-160"></a></span>
<span id="cb27-161"><a href="#cb27-161"></a><span class="fu">## Choosing Predictors ($X$)</span></span>
<span id="cb27-162"><a href="#cb27-162"></a></span>
<span id="cb27-163"><a href="#cb27-163"></a>The predictor matrix $X$ typically includes:</span>
<span id="cb27-164"><a href="#cb27-164"></a></span>
<span id="cb27-165"><a href="#cb27-165"></a><span class="pp">|</span> Predictor Type <span class="pp">|</span> Examples <span class="pp">|</span> Rationale <span class="pp">|</span></span>
<span id="cb27-166"><a href="#cb27-166"></a><span class="pp">|----------------|----------|-----------|</span></span>
<span id="cb27-167"><a href="#cb27-167"></a><span class="pp">|</span> **Pre-treatment outcomes** <span class="pp">|</span> $Y_{1,T_0}, Y_{1,T_0-1}, \ldots$ <span class="pp">|</span> Forces trajectory matching <span class="pp">|</span></span>
<span id="cb27-168"><a href="#cb27-168"></a><span class="pp">|</span> **Economic fundamentals** <span class="pp">|</span> GDP growth, inflation, trade openness <span class="pp">|</span> Structural similarity <span class="pp">|</span></span>
<span id="cb27-169"><a href="#cb27-169"></a><span class="pp">|</span> **Demographics** <span class="pp">|</span> Population, urbanization <span class="pp">|</span> Background comparability <span class="pp">|</span></span>
<span id="cb27-170"><a href="#cb27-170"></a><span class="pp">|</span> **Policy variables** <span class="pp">|</span> Tax rates, regulations <span class="pp">|</span> Institutional similarity <span class="pp">|</span></span>
<span id="cb27-171"><a href="#cb27-171"></a></span>
<span id="cb27-172"><a href="#cb27-172"></a>::: {.callout-important}</span>
<span id="cb27-173"><a href="#cb27-173"></a><span class="fu">## Include Pre-Treatment Outcomes</span></span>
<span id="cb27-174"><a href="#cb27-174"></a>Abadie (2021) emphasizes: always include **multiple pre-treatment outcomes** as predictors. This forces the synthetic control to track the actual trajectory, not just match averages.</span>
<span id="cb27-175"><a href="#cb27-175"></a>:::</span>
<span id="cb27-176"><a href="#cb27-176"></a></span>
<span id="cb27-177"><a href="#cb27-177"></a><span class="fu">## The Nested Optimization</span></span>
<span id="cb27-178"><a href="#cb27-178"></a></span>
<span id="cb27-179"><a href="#cb27-179"></a>In practice, SCM solves two nested problems:</span>
<span id="cb27-180"><a href="#cb27-180"></a></span>
<span id="cb27-181"><a href="#cb27-181"></a>**Inner problem** (given predictor weights $V$):</span>
<span id="cb27-182"><a href="#cb27-182"></a>$$</span>
<span id="cb27-183"><a href="#cb27-183"></a>W^*(V) = \arg\min_W (X_1 - X_0 W)' V (X_1 - X_0 W)</span>
<span id="cb27-184"><a href="#cb27-184"></a>$$</span>
<span id="cb27-185"><a href="#cb27-185"></a></span>
<span id="cb27-186"><a href="#cb27-186"></a>**Outer problem** (choose $V$ to minimize pre-treatment fit):</span>
<span id="cb27-187"><a href="#cb27-187"></a>$$</span>
<span id="cb27-188"><a href="#cb27-188"></a>V^* = \arg\min_V \sum_{t=1}^{T_0} \left(Y_{1t} - \sum_{j} w_j^*(V) Y_{jt}\right)^2</span>
<span id="cb27-189"><a href="#cb27-189"></a>$$</span>
<span id="cb27-190"><a href="#cb27-190"></a></span>
<span id="cb27-191"><a href="#cb27-191"></a>This ensures the weights are chosen to match the **outcome trajectory**, not just predictor averages.</span>
<span id="cb27-192"><a href="#cb27-192"></a></span>
<span id="cb27-193"><a href="#cb27-193"></a><span class="fu"># Inference: Permutation Tests {.unnumbered}</span></span>
<span id="cb27-194"><a href="#cb27-194"></a></span>
<span id="cb27-195"><a href="#cb27-195"></a>With one treated unit, standard inference doesn't apply. SCM uses **permutation-based inference**.</span>
<span id="cb27-196"><a href="#cb27-196"></a></span>
<span id="cb27-197"><a href="#cb27-197"></a><span class="fu">## The Placebo Test</span></span>
<span id="cb27-198"><a href="#cb27-198"></a></span>
<span id="cb27-199"><a href="#cb27-199"></a>**Idea**: Apply SCM to each donor unit as if it were treated. If the treated unit's effect is real, its gap should be unusually large compared to placebo gaps.</span>
<span id="cb27-200"><a href="#cb27-200"></a></span>
<span id="cb27-201"><a href="#cb27-201"></a>**Procedure**:</span>
<span id="cb27-202"><a href="#cb27-202"></a></span>
<span id="cb27-203"><a href="#cb27-203"></a><span class="ss">1. </span>Estimate SCM for treated unit → get gap $\hat{\tau}_{1t}$</span>
<span id="cb27-204"><a href="#cb27-204"></a><span class="ss">2. </span>For each donor $j = 2, \ldots, J+1$:</span>
<span id="cb27-205"><a href="#cb27-205"></a><span class="ss">   - </span>Pretend unit $j$ is treated (remove from donor pool)</span>
<span id="cb27-206"><a href="#cb27-206"></a><span class="ss">   - </span>Construct synthetic control from remaining units</span>
<span id="cb27-207"><a href="#cb27-207"></a><span class="ss">   - </span>Calculate placebo gap $\hat{\tau}_{jt}$</span>
<span id="cb27-208"><a href="#cb27-208"></a><span class="ss">3. </span>Compare: Is $|\hat{\tau}_{1t}|$ extreme relative to $\{|\hat{\tau}_{jt}|<span class="sc">\}</span>$?</span>
<span id="cb27-209"><a href="#cb27-209"></a></span>
<span id="cb27-210"><a href="#cb27-210"></a>**P-value**:</span>
<span id="cb27-211"><a href="#cb27-211"></a>$$</span>
<span id="cb27-212"><a href="#cb27-212"></a>p = \frac{<span class="sc">\#\{</span>j : |\hat{\tau}_j| \geq |\hat{\tau}_1|<span class="sc">\}</span>}{J + 1}</span>
<span id="cb27-213"><a href="#cb27-213"></a>$$</span>
<span id="cb27-214"><a href="#cb27-214"></a></span>
<span id="cb27-217"><a href="#cb27-217"></a><span class="in">```{r}</span></span>
<span id="cb27-218"><a href="#cb27-218"></a><span class="co">#| label: placebo-test</span></span>
<span id="cb27-219"><a href="#cb27-219"></a><span class="co">#| fig-cap: "Placebo test: treated unit gap vs. placebo distribution"</span></span>
<span id="cb27-220"><a href="#cb27-220"></a></span>
<span id="cb27-221"><a href="#cb27-221"></a><span class="co"># Simulate placebo test</span></span>
<span id="cb27-222"><a href="#cb27-222"></a><span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb27-223"><a href="#cb27-223"></a>n_placebo <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb27-224"><a href="#cb27-224"></a></span>
<span id="cb27-225"><a href="#cb27-225"></a><span class="co"># Treated unit has real effect</span></span>
<span id="cb27-226"><a href="#cb27-226"></a>treated_gap <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, T0), <span class="fu">cumsum</span>(<span class="fu">rnorm</span>(T_total <span class="sc">-</span> T0, <span class="sc">-</span><span class="fl">0.5</span>, <span class="fl">0.2</span>)))</span>
<span id="cb27-227"><a href="#cb27-227"></a></span>
<span id="cb27-228"><a href="#cb27-228"></a><span class="co"># Placebo gaps (no real effect)</span></span>
<span id="cb27-229"><a href="#cb27-229"></a>placebo_gaps <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n_placebo, <span class="cf">function</span>(i) {</span>
<span id="cb27-230"><a href="#cb27-230"></a>  gap <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(T0, <span class="dv">0</span>, <span class="fl">0.25</span>), <span class="fu">rnorm</span>(T_total <span class="sc">-</span> T0, <span class="dv">0</span>, <span class="fl">0.35</span>))</span>
<span id="cb27-231"><a href="#cb27-231"></a>  <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_total, <span class="at">gap =</span> gap, <span class="at">unit =</span> <span class="fu">paste</span>(<span class="st">"Placebo"</span>, i))</span>
<span id="cb27-232"><a href="#cb27-232"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb27-233"><a href="#cb27-233"></a></span>
<span id="cb27-234"><a href="#cb27-234"></a><span class="co"># Combine</span></span>
<span id="cb27-235"><a href="#cb27-235"></a>all_gaps <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb27-236"><a href="#cb27-236"></a>  <span class="fu">data.frame</span>(<span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>T_total, <span class="at">gap =</span> treated_gap, <span class="at">unit =</span> <span class="st">"Treated"</span>),</span>
<span id="cb27-237"><a href="#cb27-237"></a>  placebo_gaps</span>
<span id="cb27-238"><a href="#cb27-238"></a>)</span>
<span id="cb27-239"><a href="#cb27-239"></a></span>
<span id="cb27-240"><a href="#cb27-240"></a><span class="fu">ggplot</span>(all_gaps, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> gap, <span class="at">group =</span> unit)) <span class="sc">+</span></span>
<span id="cb27-241"><a href="#cb27-241"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">filter</span>(all_gaps, unit <span class="sc">!=</span> <span class="st">"Treated"</span>),</span>
<span id="cb27-242"><a href="#cb27-242"></a>            <span class="at">color =</span> <span class="st">"gray60"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">linewidth =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb27-243"><a href="#cb27-243"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> <span class="fu">filter</span>(all_gaps, unit <span class="sc">==</span> <span class="st">"Treated"</span>),</span>
<span id="cb27-244"><a href="#cb27-244"></a>            <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">linewidth =</span> <span class="fl">1.3</span>) <span class="sc">+</span></span>
<span id="cb27-245"><a href="#cb27-245"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb27-246"><a href="#cb27-246"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> T0 <span class="sc">+</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb27-247"><a href="#cb27-247"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="fu">min</span>(all_gaps<span class="sc">$</span>gap) <span class="sc">*</span> <span class="fl">0.8</span>,</span>
<span id="cb27-248"><a href="#cb27-248"></a>           <span class="at">label =</span> <span class="st">"Gray = Placebo gaps</span><span class="sc">\n</span><span class="st">Red = Treated unit gap"</span>,</span>
<span id="cb27-249"><a href="#cb27-249"></a>           <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"gray40"</span>) <span class="sc">+</span></span>
<span id="cb27-250"><a href="#cb27-250"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Placebo Test for Inference"</span>,</span>
<span id="cb27-251"><a href="#cb27-251"></a>       <span class="at">subtitle =</span> <span class="st">"If treatment effect is real, treated unit's gap should be extreme"</span>,</span>
<span id="cb27-252"><a href="#cb27-252"></a>       <span class="at">x =</span> <span class="st">"Time Period"</span>, <span class="at">y =</span> <span class="st">"Gap (Actual - Synthetic)"</span>)</span>
<span id="cb27-253"><a href="#cb27-253"></a><span class="in">```</span></span>
<span id="cb27-254"><a href="#cb27-254"></a></span>
<span id="cb27-255"><a href="#cb27-255"></a><span class="fu">## RMSPE Ratio</span></span>
<span id="cb27-256"><a href="#cb27-256"></a></span>
<span id="cb27-257"><a href="#cb27-257"></a>To account for **pre-treatment fit quality**, use the RMSPE ratio:</span>
<span id="cb27-258"><a href="#cb27-258"></a></span>
<span id="cb27-259"><a href="#cb27-259"></a>$$</span>
<span id="cb27-260"><a href="#cb27-260"></a>\text{Ratio}_j = \frac{\text{RMSPE}_{j,\text{post}}}{\text{RMSPE}_{j,\text{pre}}}</span>
<span id="cb27-261"><a href="#cb27-261"></a>$$</span>
<span id="cb27-262"><a href="#cb27-262"></a></span>
<span id="cb27-263"><a href="#cb27-263"></a>where:</span>
<span id="cb27-264"><a href="#cb27-264"></a>$$</span>
<span id="cb27-265"><a href="#cb27-265"></a>\text{RMSPE}_{j,\text{pre}} = \sqrt{\frac{1}{T_0} \sum_{t=1}^{T_0} (Y_{jt} - \hat{Y}_{jt}^{\text{synth}})^2}</span>
<span id="cb27-266"><a href="#cb27-266"></a>$$</span>
<span id="cb27-267"><a href="#cb27-267"></a></span>
<span id="cb27-268"><a href="#cb27-268"></a>**Rationale**: A unit with poor pre-treatment fit may have large post-treatment gaps just from noise. The ratio normalizes by pre-treatment fit quality.</span>
<span id="cb27-269"><a href="#cb27-269"></a></span>
<span id="cb27-272"><a href="#cb27-272"></a><span class="in">```{r}</span></span>
<span id="cb27-273"><a href="#cb27-273"></a><span class="co">#| label: rmspe-ratio</span></span>
<span id="cb27-274"><a href="#cb27-274"></a><span class="co">#| fig-cap: "RMSPE ratio: normalizing by pre-treatment fit"</span></span>
<span id="cb27-275"><a href="#cb27-275"></a></span>
<span id="cb27-276"><a href="#cb27-276"></a><span class="co"># Calculate RMSPE ratios</span></span>
<span id="cb27-277"><a href="#cb27-277"></a>rmspe_pre <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">0.12</span>, <span class="fu">runif</span>(n_placebo, <span class="fl">0.15</span>, <span class="fl">0.6</span>))  <span class="co"># Treated has good fit</span></span>
<span id="cb27-278"><a href="#cb27-278"></a>rmspe_post <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.8</span>, <span class="fu">runif</span>(n_placebo, <span class="fl">0.2</span>, <span class="fl">1.2</span>))   <span class="co"># Treated has large post gap</span></span>
<span id="cb27-279"><a href="#cb27-279"></a></span>
<span id="cb27-280"><a href="#cb27-280"></a>rmspe_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb27-281"><a href="#cb27-281"></a>  <span class="at">unit =</span> <span class="fu">c</span>(<span class="st">"Treated"</span>, <span class="fu">paste</span>(<span class="st">"Placebo"</span>, <span class="dv">1</span><span class="sc">:</span>n_placebo)),</span>
<span id="cb27-282"><a href="#cb27-282"></a>  <span class="at">rmspe_pre =</span> rmspe_pre,</span>
<span id="cb27-283"><a href="#cb27-283"></a>  <span class="at">rmspe_post =</span> rmspe_post</span>
<span id="cb27-284"><a href="#cb27-284"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb27-285"><a href="#cb27-285"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-286"><a href="#cb27-286"></a>    <span class="at">ratio =</span> rmspe_post <span class="sc">/</span> rmspe_pre,</span>
<span id="cb27-287"><a href="#cb27-287"></a>    <span class="at">is_treated =</span> unit <span class="sc">==</span> <span class="st">"Treated"</span></span>
<span id="cb27-288"><a href="#cb27-288"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-289"><a href="#cb27-289"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(ratio))</span>
<span id="cb27-290"><a href="#cb27-290"></a></span>
<span id="cb27-291"><a href="#cb27-291"></a><span class="co"># P-value</span></span>
<span id="cb27-292"><a href="#cb27-292"></a>p_val <span class="ot">&lt;-</span> <span class="fu">mean</span>(rmspe_df<span class="sc">$</span>ratio <span class="sc">&gt;=</span> rmspe_df<span class="sc">$</span>ratio[rmspe_df<span class="sc">$</span>unit <span class="sc">==</span> <span class="st">"Treated"</span>])</span>
<span id="cb27-293"><a href="#cb27-293"></a></span>
<span id="cb27-294"><a href="#cb27-294"></a><span class="fu">ggplot</span>(rmspe_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(unit, ratio), <span class="at">y =</span> ratio, <span class="at">fill =</span> is_treated)) <span class="sc">+</span></span>
<span id="cb27-295"><a href="#cb27-295"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb27-296"><a href="#cb27-296"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> rmspe_df<span class="sc">$</span>ratio[rmspe_df<span class="sc">$</span>unit <span class="sc">==</span> <span class="st">"Treated"</span>],</span>
<span id="cb27-297"><a href="#cb27-297"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#e74c3c"</span>, <span class="at">linewidth =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb27-298"><a href="#cb27-298"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb27-299"><a href="#cb27-299"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"#bdc3c7"</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb27-300"><a href="#cb27-300"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"RMSPE Ratio Distribution"</span>,</span>
<span id="cb27-301"><a href="#cb27-301"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Treated unit ratio = "</span>,</span>
<span id="cb27-302"><a href="#cb27-302"></a>                        <span class="fu">round</span>(rmspe_df<span class="sc">$</span>ratio[rmspe_df<span class="sc">$</span>unit <span class="sc">==</span> <span class="st">"Treated"</span>], <span class="dv">1</span>),</span>
<span id="cb27-303"><a href="#cb27-303"></a>                        <span class="st">" | Implied p-value = "</span>, <span class="fu">round</span>(p_val, <span class="dv">3</span>)),</span>
<span id="cb27-304"><a href="#cb27-304"></a>       <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Post/Pre RMSPE Ratio"</span>) <span class="sc">+</span></span>
<span id="cb27-305"><a href="#cb27-305"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb27-306"><a href="#cb27-306"></a><span class="in">```</span></span>
<span id="cb27-307"><a href="#cb27-307"></a></span>
<span id="cb27-308"><a href="#cb27-308"></a><span class="fu"># Synthetic Difference-in-Differences {.unnumbered}</span></span>
<span id="cb27-309"><a href="#cb27-309"></a></span>
<span id="cb27-310"><a href="#cb27-310"></a><span class="fu">## Arkhangelsky et al. (2021)</span></span>
<span id="cb27-311"><a href="#cb27-311"></a></span>
<span id="cb27-312"><a href="#cb27-312"></a>**Synthetic DiD** combines the strengths of SCM and DiD:</span>
<span id="cb27-313"><a href="#cb27-313"></a></span>
<span id="cb27-314"><a href="#cb27-314"></a><span class="pp">|</span> Method <span class="pp">|</span> Handles Multiple Treated? <span class="pp">|</span> Requires Parallel Trends? <span class="pp">|</span></span>
<span id="cb27-315"><a href="#cb27-315"></a><span class="pp">|--------|---------------------------|---------------------------|</span></span>
<span id="cb27-316"><a href="#cb27-316"></a><span class="pp">|</span> DiD <span class="pp">|</span> Yes <span class="pp">|</span> Yes <span class="pp">|</span></span>
<span id="cb27-317"><a href="#cb27-317"></a><span class="pp">|</span> SCM <span class="pp">|</span> No (designed for one) <span class="pp">|</span> No (matches trajectories) <span class="pp">|</span></span>
<span id="cb27-318"><a href="#cb27-318"></a><span class="pp">|</span> **Synthetic DiD** | **Yes** | **No** <span class="pp">|</span></span>
<span id="cb27-319"><a href="#cb27-319"></a></span>
<span id="cb27-320"><a href="#cb27-320"></a><span class="fu">### The Estimator</span></span>
<span id="cb27-321"><a href="#cb27-321"></a></span>
<span id="cb27-322"><a href="#cb27-322"></a>Synthetic DiD finds:</span>
<span id="cb27-323"><a href="#cb27-323"></a></span>
<span id="cb27-324"><a href="#cb27-324"></a><span class="ss">1. </span>**Unit weights** $\omega_i$ (like SCM) — make controls look like treated pre-treatment</span>
<span id="cb27-325"><a href="#cb27-325"></a><span class="ss">2. </span>**Time weights** $\lambda_t$ (novel) — emphasize pre-treatment periods that predict post-treatment</span>
<span id="cb27-326"><a href="#cb27-326"></a></span>
<span id="cb27-327"><a href="#cb27-327"></a>$$</span>
<span id="cb27-328"><a href="#cb27-328"></a>\hat{\tau}^{sdid} = \left(\bar{Y}_{tr,post}^{\omega} - \bar{Y}_{co,post}^{\omega}\right) - \left(\bar{Y}_{tr,pre}^{\lambda} - \bar{Y}_{co,pre}^{\omega,\lambda}\right)</span>
<span id="cb27-329"><a href="#cb27-329"></a>$$</span>
<span id="cb27-330"><a href="#cb27-330"></a></span>
<span id="cb27-331"><a href="#cb27-331"></a>The optimization:</span>
<span id="cb27-332"><a href="#cb27-332"></a>$$</span>
<span id="cb27-333"><a href="#cb27-333"></a>\min_{\omega, \lambda} \sum_{i: \text{control}} \sum_{t \leq T_0} \left(Y_{it} - \lambda_t - \omega_i - \mu\right)^2 + \text{regularization}</span>
<span id="cb27-334"><a href="#cb27-334"></a>$$</span>
<span id="cb27-335"><a href="#cb27-335"></a></span>
<span id="cb27-336"><a href="#cb27-336"></a><span class="fu">### Advantages</span></span>
<span id="cb27-337"><a href="#cb27-337"></a></span>
<span id="cb27-338"><a href="#cb27-338"></a><span class="ss">1. </span>**Works with multiple treated units** (unlike classic SCM)</span>
<span id="cb27-339"><a href="#cb27-339"></a><span class="ss">2. </span>**Doesn't require exact pre-treatment match** (unlike SCM)</span>
<span id="cb27-340"><a href="#cb27-340"></a><span class="ss">3. </span>**Doesn't require parallel trends** (unlike DiD)</span>
<span id="cb27-341"><a href="#cb27-341"></a><span class="ss">4. </span>**Doubly robust**: consistent if either unit OR time weights are correct</span>
<span id="cb27-342"><a href="#cb27-342"></a></span>
<span id="cb27-345"><a href="#cb27-345"></a><span class="in">```{r}</span></span>
<span id="cb27-346"><a href="#cb27-346"></a><span class="co">#| label: sdid-comparison</span></span>
<span id="cb27-347"><a href="#cb27-347"></a><span class="co">#| fig-cap: "Synthetic DiD handles multiple treated units"</span></span>
<span id="cb27-348"><a href="#cb27-348"></a></span>
<span id="cb27-349"><a href="#cb27-349"></a><span class="co"># Illustrate multiple treated units scenario</span></span>
<span id="cb27-350"><a href="#cb27-350"></a>sdid_data <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb27-351"><a href="#cb27-351"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>,</span>
<span id="cb27-352"><a href="#cb27-352"></a>  <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb27-353"><a href="#cb27-353"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb27-354"><a href="#cb27-354"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-355"><a href="#cb27-355"></a>    <span class="at">treated =</span> unit <span class="sc">&lt;=</span> <span class="dv">3</span>,</span>
<span id="cb27-356"><a href="#cb27-356"></a>    <span class="at">post =</span> time <span class="sc">&gt;</span> <span class="dv">10</span>,</span>
<span id="cb27-357"><a href="#cb27-357"></a>    <span class="at">treatment =</span> treated <span class="sc">&amp;</span> post,</span>
<span id="cb27-358"><a href="#cb27-358"></a>    <span class="co"># Generate outcomes</span></span>
<span id="cb27-359"><a href="#cb27-359"></a>    <span class="at">unit_fe =</span> unit <span class="sc">*</span> <span class="fl">0.4</span>,</span>
<span id="cb27-360"><a href="#cb27-360"></a>    <span class="at">time_trend =</span> <span class="fl">0.2</span> <span class="sc">*</span> time,</span>
<span id="cb27-361"><a href="#cb27-361"></a>    <span class="at">tau =</span> <span class="fu">ifelse</span>(treatment, <span class="dv">2</span>, <span class="dv">0</span>),</span>
<span id="cb27-362"><a href="#cb27-362"></a>    <span class="at">y =</span> unit_fe <span class="sc">+</span> time_trend <span class="sc">+</span> tau <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="fl">0.4</span>),</span>
<span id="cb27-363"><a href="#cb27-363"></a>    <span class="at">group =</span> <span class="fu">ifelse</span>(treated, <span class="st">"Treated (3 units)"</span>, <span class="st">"Control (5 units)"</span>)</span>
<span id="cb27-364"><a href="#cb27-364"></a>  )</span>
<span id="cb27-365"><a href="#cb27-365"></a></span>
<span id="cb27-366"><a href="#cb27-366"></a><span class="co"># Aggregate by group</span></span>
<span id="cb27-367"><a href="#cb27-367"></a>agg_data <span class="ot">&lt;-</span> sdid_data <span class="sc">%&gt;%</span></span>
<span id="cb27-368"><a href="#cb27-368"></a>  <span class="fu">group_by</span>(time, group) <span class="sc">%&gt;%</span></span>
<span id="cb27-369"><a href="#cb27-369"></a>  <span class="fu">summarize</span>(<span class="at">y =</span> <span class="fu">mean</span>(y), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb27-370"><a href="#cb27-370"></a></span>
<span id="cb27-371"><a href="#cb27-371"></a><span class="fu">ggplot</span>(agg_data, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> y, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb27-372"><a href="#cb27-372"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb27-373"><a href="#cb27-373"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">10.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb27-374"><a href="#cb27-374"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Control (5 units)"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>,</span>
<span id="cb27-375"><a href="#cb27-375"></a>                                 <span class="st">"Treated (3 units)"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>)) <span class="sc">+</span></span>
<span id="cb27-376"><a href="#cb27-376"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">11</span>, <span class="at">y =</span> <span class="fu">max</span>(agg_data<span class="sc">$</span>y) <span class="sc">*</span> <span class="fl">0.95</span>,</span>
<span id="cb27-377"><a href="#cb27-377"></a>           <span class="at">label =</span> <span class="st">"Treatment"</span>, <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span></span>
<span id="cb27-378"><a href="#cb27-378"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Synthetic DiD: Multiple Treated Units"</span>,</span>
<span id="cb27-379"><a href="#cb27-379"></a>       <span class="at">subtitle =</span> <span class="st">"Synthetic DiD reweights controls to match treated pre-treatment trajectory"</span>,</span>
<span id="cb27-380"><a href="#cb27-380"></a>       <span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"Average Outcome"</span>,</span>
<span id="cb27-381"><a href="#cb27-381"></a>       <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb27-382"><a href="#cb27-382"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb27-383"><a href="#cb27-383"></a><span class="in">```</span></span>
<span id="cb27-384"><a href="#cb27-384"></a></span>
<span id="cb27-385"><a href="#cb27-385"></a><span class="fu"># Implementation in R {.unnumbered}</span></span>
<span id="cb27-386"><a href="#cb27-386"></a></span>
<span id="cb27-387"><a href="#cb27-387"></a><span class="fu">## Using `augsynth` Package</span></span>
<span id="cb27-388"><a href="#cb27-388"></a></span>
<span id="cb27-389"><a href="#cb27-389"></a>The <span class="in">`augsynth`</span> package by Ben-Michael et al. implements **augmented synthetic control**, which combines SCM with outcome modeling (Ridge regression) for improved finite-sample performance.</span>
<span id="cb27-390"><a href="#cb27-390"></a></span>
<span id="cb27-391"><a href="#cb27-391"></a><span class="in">```r</span></span>
<span id="cb27-392"><a href="#cb27-392"></a><span class="fu">library</span>(augsynth)</span>
<span id="cb27-393"><a href="#cb27-393"></a></span>
<span id="cb27-394"><a href="#cb27-394"></a><span class="co"># Basic synthetic control</span></span>
<span id="cb27-395"><a href="#cb27-395"></a>syn <span class="ot">&lt;-</span> <span class="fu">augsynth</span>(</span>
<span id="cb27-396"><a href="#cb27-396"></a>  outcome <span class="sc">~</span> treatment <span class="sc">|</span> covariate1 <span class="sc">+</span> covariate2,  <span class="co"># outcome ~ treatment | predictors</span></span>
<span id="cb27-397"><a href="#cb27-397"></a>  <span class="at">unit =</span> unit_id,</span>
<span id="cb27-398"><a href="#cb27-398"></a>  <span class="at">time =</span> time_id,</span>
<span id="cb27-399"><a href="#cb27-399"></a>  <span class="at">data =</span> panel_data,</span>
<span id="cb27-400"><a href="#cb27-400"></a>  <span class="at">t_int =</span> treatment_time,    <span class="co"># when treatment begins</span></span>
<span id="cb27-401"><a href="#cb27-401"></a>  <span class="at">progfunc =</span> <span class="st">"Ridge"</span>         <span class="co"># augmentation: "None", "Ridge", "EN"</span></span>
<span id="cb27-402"><a href="#cb27-402"></a>)</span>
<span id="cb27-403"><a href="#cb27-403"></a></span>
<span id="cb27-404"><a href="#cb27-404"></a><span class="co"># Results</span></span>
<span id="cb27-405"><a href="#cb27-405"></a><span class="fu">summary</span>(syn)</span>
<span id="cb27-406"><a href="#cb27-406"></a><span class="fu">plot</span>(syn)</span>
<span id="cb27-407"><a href="#cb27-407"></a></span>
<span id="cb27-408"><a href="#cb27-408"></a><span class="co"># Extract weights</span></span>
<span id="cb27-409"><a href="#cb27-409"></a>syn<span class="sc">$</span>weights</span>
<span id="cb27-410"><a href="#cb27-410"></a><span class="in">```</span></span>
<span id="cb27-411"><a href="#cb27-411"></a></span>
<span id="cb27-412"><a href="#cb27-412"></a><span class="fu">### Key Arguments</span></span>
<span id="cb27-413"><a href="#cb27-413"></a></span>
<span id="cb27-414"><a href="#cb27-414"></a><span class="pp">|</span> Argument <span class="pp">|</span> Description <span class="pp">|</span></span>
<span id="cb27-415"><a href="#cb27-415"></a><span class="pp">|----------|-------------|</span></span>
<span id="cb27-416"><a href="#cb27-416"></a><span class="pp">|</span> <span class="in">`progfunc`</span> <span class="pp">|</span> Augmentation method: <span class="in">`"None"`</span> (pure SCM), <span class="in">`"Ridge"`</span>, <span class="in">`"EN"`</span> (elastic net) <span class="pp">|</span></span>
<span id="cb27-417"><a href="#cb27-417"></a><span class="pp">|</span> <span class="in">`t_int`</span> <span class="pp">|</span> Treatment time (integer or date) <span class="pp">|</span></span>
<span id="cb27-418"><a href="#cb27-418"></a><span class="pp">|</span> <span class="in">`fixedeff`</span> <span class="pp">|</span> Include unit fixed effects in augmentation? <span class="pp">|</span></span>
<span id="cb27-419"><a href="#cb27-419"></a></span>
<span id="cb27-420"><a href="#cb27-420"></a><span class="fu">### Multiple Treated Units with `multisynth`</span></span>
<span id="cb27-421"><a href="#cb27-421"></a></span>
<span id="cb27-422"><a href="#cb27-422"></a><span class="in">```r</span></span>
<span id="cb27-423"><a href="#cb27-423"></a><span class="co"># When multiple units are treated (possibly at different times)</span></span>
<span id="cb27-424"><a href="#cb27-424"></a>multi_syn <span class="ot">&lt;-</span> <span class="fu">multisynth</span>(</span>
<span id="cb27-425"><a href="#cb27-425"></a>  outcome <span class="sc">~</span> treatment <span class="sc">|</span> covariates,</span>
<span id="cb27-426"><a href="#cb27-426"></a>  <span class="at">unit =</span> unit_id,</span>
<span id="cb27-427"><a href="#cb27-427"></a>  <span class="at">time =</span> time_id,</span>
<span id="cb27-428"><a href="#cb27-428"></a>  <span class="at">data =</span> panel_data,</span>
<span id="cb27-429"><a href="#cb27-429"></a>  <span class="at">n_leads =</span> <span class="dv">8</span>,      <span class="co"># post-treatment horizons to estimate</span></span>
<span id="cb27-430"><a href="#cb27-430"></a>  <span class="at">n_lags =</span> <span class="dv">4</span>        <span class="co"># pre-treatment periods to match</span></span>
<span id="cb27-431"><a href="#cb27-431"></a>)</span>
<span id="cb27-432"><a href="#cb27-432"></a></span>
<span id="cb27-433"><a href="#cb27-433"></a><span class="fu">summary</span>(multi_syn)</span>
<span id="cb27-434"><a href="#cb27-434"></a><span class="fu">plot</span>(multi_syn)</span>
<span id="cb27-435"><a href="#cb27-435"></a><span class="in">```</span></span>
<span id="cb27-436"><a href="#cb27-436"></a></span>
<span id="cb27-437"><a href="#cb27-437"></a><span class="fu">## Using `synthdid` Package</span></span>
<span id="cb27-438"><a href="#cb27-438"></a></span>
<span id="cb27-439"><a href="#cb27-439"></a>The <span class="in">`synthdid`</span> package by Arkhangelsky et al. implements **Synthetic Difference-in-Differences**.</span>
<span id="cb27-440"><a href="#cb27-440"></a></span>
<span id="cb27-441"><a href="#cb27-441"></a><span class="in">```r</span></span>
<span id="cb27-442"><a href="#cb27-442"></a><span class="fu">library</span>(synthdid)</span>
<span id="cb27-443"><a href="#cb27-443"></a></span>
<span id="cb27-444"><a href="#cb27-444"></a><span class="co"># Prepare data as matrices</span></span>
<span id="cb27-445"><a href="#cb27-445"></a><span class="co"># Y: units × time matrix of outcomes</span></span>
<span id="cb27-446"><a href="#cb27-446"></a>Y <span class="ot">&lt;-</span> panel_data <span class="sc">%&gt;%</span></span>
<span id="cb27-447"><a href="#cb27-447"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> unit, <span class="at">names_from =</span> time, <span class="at">values_from =</span> outcome) <span class="sc">%&gt;%</span></span>
<span id="cb27-448"><a href="#cb27-448"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"unit"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-449"><a href="#cb27-449"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb27-450"><a href="#cb27-450"></a></span>
<span id="cb27-451"><a href="#cb27-451"></a><span class="co"># W: units × time matrix of treatment indicators (1 if treated)</span></span>
<span id="cb27-452"><a href="#cb27-452"></a>W <span class="ot">&lt;-</span> panel_data <span class="sc">%&gt;%</span></span>
<span id="cb27-453"><a href="#cb27-453"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> unit, <span class="at">names_from =</span> time, <span class="at">values_from =</span> treated) <span class="sc">%&gt;%</span></span>
<span id="cb27-454"><a href="#cb27-454"></a>  <span class="fu">column_to_rownames</span>(<span class="st">"unit"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-455"><a href="#cb27-455"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb27-456"><a href="#cb27-456"></a></span>
<span id="cb27-457"><a href="#cb27-457"></a><span class="co"># Synthetic DiD estimate</span></span>
<span id="cb27-458"><a href="#cb27-458"></a>tau_sdid <span class="ot">&lt;-</span> <span class="fu">synthdid_estimate</span>(Y, W)</span>
<span id="cb27-459"><a href="#cb27-459"></a></span>
<span id="cb27-460"><a href="#cb27-460"></a><span class="co"># Standard error (placebo-based)</span></span>
<span id="cb27-461"><a href="#cb27-461"></a>se_sdid <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">vcov</span>(tau_sdid, <span class="at">method =</span> <span class="st">"placebo"</span>))</span>
<span id="cb27-462"><a href="#cb27-462"></a></span>
<span id="cb27-463"><a href="#cb27-463"></a><span class="co"># Compare to pure SC and pure DiD</span></span>
<span id="cb27-464"><a href="#cb27-464"></a>tau_sc <span class="ot">&lt;-</span> <span class="fu">sc_estimate</span>(Y, W)</span>
<span id="cb27-465"><a href="#cb27-465"></a>tau_did <span class="ot">&lt;-</span> <span class="fu">did_estimate</span>(Y, W)</span>
<span id="cb27-466"><a href="#cb27-466"></a></span>
<span id="cb27-467"><a href="#cb27-467"></a><span class="co"># Visualize</span></span>
<span id="cb27-468"><a href="#cb27-468"></a><span class="fu">synthdid_plot</span>(tau_sdid)</span>
<span id="cb27-469"><a href="#cb27-469"></a><span class="in">```</span></span>
<span id="cb27-470"><a href="#cb27-470"></a></span>
<span id="cb27-471"><a href="#cb27-471"></a><span class="fu">## Worked Example</span></span>
<span id="cb27-472"><a href="#cb27-472"></a></span>
<span id="cb27-475"><a href="#cb27-475"></a><span class="in">```{r}</span></span>
<span id="cb27-476"><a href="#cb27-476"></a><span class="co">#| label: worked-example</span></span>
<span id="cb27-477"><a href="#cb27-477"></a><span class="co">#| fig-cap: "Complete SCM analysis workflow"</span></span>
<span id="cb27-478"><a href="#cb27-478"></a></span>
<span id="cb27-479"><a href="#cb27-479"></a><span class="co"># Create synthetic panel data for demonstration</span></span>
<span id="cb27-480"><a href="#cb27-480"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb27-481"><a href="#cb27-481"></a>n_units <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb27-482"><a href="#cb27-482"></a>n_periods <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb27-483"><a href="#cb27-483"></a>treatment_time <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb27-484"><a href="#cb27-484"></a></span>
<span id="cb27-485"><a href="#cb27-485"></a><span class="co"># Unit 1 is treated</span></span>
<span id="cb27-486"><a href="#cb27-486"></a>panel <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb27-487"><a href="#cb27-487"></a>  <span class="at">unit =</span> <span class="dv">1</span><span class="sc">:</span>n_units,</span>
<span id="cb27-488"><a href="#cb27-488"></a>  <span class="at">time =</span> <span class="dv">1</span><span class="sc">:</span>n_periods</span>
<span id="cb27-489"><a href="#cb27-489"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb27-490"><a href="#cb27-490"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-491"><a href="#cb27-491"></a>    <span class="at">treated_unit =</span> (unit <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb27-492"><a href="#cb27-492"></a>    <span class="at">post =</span> (time <span class="sc">&gt;=</span> treatment_time),</span>
<span id="cb27-493"><a href="#cb27-493"></a>    <span class="at">treatment =</span> treated_unit <span class="sc">&amp;</span> post,</span>
<span id="cb27-494"><a href="#cb27-494"></a>    <span class="co"># Pre-treatment characteristics</span></span>
<span id="cb27-495"><a href="#cb27-495"></a>    <span class="at">x1 =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> unit<span class="sc">/</span><span class="dv">5</span>, <span class="at">sd =</span> <span class="fl">0.3</span>),</span>
<span id="cb27-496"><a href="#cb27-496"></a>    <span class="at">x2 =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="at">mean =</span> time<span class="sc">/</span><span class="dv">10</span>, <span class="at">sd =</span> <span class="fl">0.2</span>),</span>
<span id="cb27-497"><a href="#cb27-497"></a>    <span class="co"># Outcome with treatment effect for unit 1</span></span>
<span id="cb27-498"><a href="#cb27-498"></a>    <span class="at">unit_fe =</span> unit <span class="sc">*</span> <span class="fl">0.5</span>,</span>
<span id="cb27-499"><a href="#cb27-499"></a>    <span class="at">time_fe =</span> <span class="fl">0.15</span> <span class="sc">*</span> time,</span>
<span id="cb27-500"><a href="#cb27-500"></a>    <span class="at">tau =</span> <span class="fu">ifelse</span>(treatment, <span class="sc">-</span><span class="fl">2.5</span> <span class="sc">-</span> <span class="fl">0.1</span><span class="sc">*</span>(time <span class="sc">-</span> treatment_time), <span class="dv">0</span>),</span>
<span id="cb27-501"><a href="#cb27-501"></a>    <span class="at">y =</span> unit_fe <span class="sc">+</span> time_fe <span class="sc">+</span> <span class="fl">0.3</span><span class="sc">*</span>x1 <span class="sc">+</span> <span class="fl">0.2</span><span class="sc">*</span>x2 <span class="sc">+</span> tau <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">0</span>, <span class="fl">0.4</span>)</span>
<span id="cb27-502"><a href="#cb27-502"></a>  )</span>
<span id="cb27-503"><a href="#cb27-503"></a></span>
<span id="cb27-504"><a href="#cb27-504"></a><span class="co"># --- Manual SCM Implementation ---</span></span>
<span id="cb27-505"><a href="#cb27-505"></a></span>
<span id="cb27-506"><a href="#cb27-506"></a><span class="co"># Pre-treatment data</span></span>
<span id="cb27-507"><a href="#cb27-507"></a>pre_data <span class="ot">&lt;-</span> panel <span class="sc">%&gt;%</span> <span class="fu">filter</span>(time <span class="sc">&lt;</span> treatment_time)</span>
<span id="cb27-508"><a href="#cb27-508"></a></span>
<span id="cb27-509"><a href="#cb27-509"></a><span class="co"># Treated unit pre-treatment outcomes</span></span>
<span id="cb27-510"><a href="#cb27-510"></a>y_treated_pre <span class="ot">&lt;-</span> pre_data <span class="sc">%&gt;%</span></span>
<span id="cb27-511"><a href="#cb27-511"></a>  <span class="fu">filter</span>(unit <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-512"><a href="#cb27-512"></a>  <span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb27-513"><a href="#cb27-513"></a>  <span class="fu">pull</span>(y)</span>
<span id="cb27-514"><a href="#cb27-514"></a></span>
<span id="cb27-515"><a href="#cb27-515"></a><span class="co"># Donor pre-treatment outcomes (matrix: time × donors)</span></span>
<span id="cb27-516"><a href="#cb27-516"></a>Y_donors_pre <span class="ot">&lt;-</span> pre_data <span class="sc">%&gt;%</span></span>
<span id="cb27-517"><a href="#cb27-517"></a>  <span class="fu">filter</span>(unit <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-518"><a href="#cb27-518"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> time, <span class="at">names_from =</span> unit, <span class="at">values_from =</span> y) <span class="sc">%&gt;%</span></span>
<span id="cb27-519"><a href="#cb27-519"></a>  <span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb27-520"><a href="#cb27-520"></a>  <span class="fu">select</span>(<span class="sc">-</span>time) <span class="sc">%&gt;%</span></span>
<span id="cb27-521"><a href="#cb27-521"></a>  <span class="fu">as.matrix</span>()</span>
<span id="cb27-522"><a href="#cb27-522"></a></span>
<span id="cb27-523"><a href="#cb27-523"></a><span class="co"># Find weights via constrained least squares (simplified)</span></span>
<span id="cb27-524"><a href="#cb27-524"></a><span class="co"># In practice, use quadprog or augsynth</span></span>
<span id="cb27-525"><a href="#cb27-525"></a><span class="co"># Here: OLS projection then normalize positive weights</span></span>
<span id="cb27-526"><a href="#cb27-526"></a></span>
<span id="cb27-527"><a href="#cb27-527"></a>weights_raw <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(y_treated_pre <span class="sc">~</span> Y_donors_pre <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb27-528"><a href="#cb27-528"></a>weights_raw[<span class="fu">is.na</span>(weights_raw) <span class="sc">|</span> weights_raw <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb27-529"><a href="#cb27-529"></a>weights <span class="ot">&lt;-</span> weights_raw <span class="sc">/</span> <span class="fu">sum</span>(weights_raw)</span>
<span id="cb27-530"><a href="#cb27-530"></a></span>
<span id="cb27-531"><a href="#cb27-531"></a><span class="co"># Construct synthetic control for all periods</span></span>
<span id="cb27-532"><a href="#cb27-532"></a>synthetic <span class="ot">&lt;-</span> panel <span class="sc">%&gt;%</span></span>
<span id="cb27-533"><a href="#cb27-533"></a>  <span class="fu">filter</span>(unit <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-534"><a href="#cb27-534"></a>  <span class="fu">left_join</span>(</span>
<span id="cb27-535"><a href="#cb27-535"></a>    <span class="fu">data.frame</span>(<span class="at">unit =</span> <span class="dv">2</span><span class="sc">:</span>n_units, <span class="at">weight =</span> weights),</span>
<span id="cb27-536"><a href="#cb27-536"></a>    <span class="at">by =</span> <span class="st">"unit"</span></span>
<span id="cb27-537"><a href="#cb27-537"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-538"><a href="#cb27-538"></a>  <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb27-539"><a href="#cb27-539"></a>  <span class="fu">summarize</span>(<span class="at">y_synth =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb27-540"><a href="#cb27-540"></a></span>
<span id="cb27-541"><a href="#cb27-541"></a><span class="co"># Get treated outcomes</span></span>
<span id="cb27-542"><a href="#cb27-542"></a>treated_outcomes <span class="ot">&lt;-</span> panel <span class="sc">%&gt;%</span></span>
<span id="cb27-543"><a href="#cb27-543"></a>  <span class="fu">filter</span>(unit <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-544"><a href="#cb27-544"></a>  <span class="fu">select</span>(time, <span class="at">y_treated =</span> y)</span>
<span id="cb27-545"><a href="#cb27-545"></a></span>
<span id="cb27-546"><a href="#cb27-546"></a><span class="co"># Calculate gaps</span></span>
<span id="cb27-547"><a href="#cb27-547"></a>results <span class="ot">&lt;-</span> <span class="fu">left_join</span>(treated_outcomes, synthetic, <span class="at">by =</span> <span class="st">"time"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-548"><a href="#cb27-548"></a>  <span class="fu">mutate</span>(<span class="at">gap =</span> y_treated <span class="sc">-</span> y_synth)</span>
<span id="cb27-549"><a href="#cb27-549"></a></span>
<span id="cb27-550"><a href="#cb27-550"></a><span class="co"># --- Visualization ---</span></span>
<span id="cb27-551"><a href="#cb27-551"></a></span>
<span id="cb27-552"><a href="#cb27-552"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> time)) <span class="sc">+</span></span>
<span id="cb27-553"><a href="#cb27-553"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_treated, <span class="at">color =</span> <span class="st">"Treated"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb27-554"><a href="#cb27-554"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> y_synth, <span class="at">color =</span> <span class="st">"Synthetic"</span>), <span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb27-555"><a href="#cb27-555"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> treatment_time <span class="sc">-</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb27-556"><a href="#cb27-556"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Treated"</span> <span class="ot">=</span> <span class="st">"#e74c3c"</span>, <span class="st">"Synthetic"</span> <span class="ot">=</span> <span class="st">"#3498db"</span>)) <span class="sc">+</span></span>
<span id="cb27-557"><a href="#cb27-557"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Treated vs Synthetic Control"</span>,</span>
<span id="cb27-558"><a href="#cb27-558"></a>       <span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"Outcome"</span>, <span class="at">color =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb27-559"><a href="#cb27-559"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb27-560"><a href="#cb27-560"></a></span>
<span id="cb27-561"><a href="#cb27-561"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(results, <span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> gap)) <span class="sc">+</span></span>
<span id="cb27-562"><a href="#cb27-562"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>, <span class="at">color =</span> <span class="st">"#9b59b6"</span>) <span class="sc">+</span></span>
<span id="cb27-563"><a href="#cb27-563"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> <span class="fu">pmin</span>(<span class="dv">0</span>, gap), <span class="at">ymax =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, gap)),</span>
<span id="cb27-564"><a href="#cb27-564"></a>              <span class="at">fill =</span> <span class="st">"#9b59b6"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb27-565"><a href="#cb27-565"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb27-566"><a href="#cb27-566"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> treatment_time <span class="sc">-</span> <span class="fl">0.5</span>, <span class="at">linetype =</span> <span class="st">"dotted"</span>) <span class="sc">+</span></span>
<span id="cb27-567"><a href="#cb27-567"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Estimated Treatment Effect"</span>,</span>
<span id="cb27-568"><a href="#cb27-568"></a>       <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"Post-treatment average gap: "</span>,</span>
<span id="cb27-569"><a href="#cb27-569"></a>                        <span class="fu">round</span>(<span class="fu">mean</span>(results<span class="sc">$</span>gap[results<span class="sc">$</span>time <span class="sc">&gt;=</span> treatment_time]), <span class="dv">2</span>)),</span>
<span id="cb27-570"><a href="#cb27-570"></a>       <span class="at">x =</span> <span class="st">"Time"</span>, <span class="at">y =</span> <span class="st">"Gap (Treated - Synthetic)"</span>)</span>
<span id="cb27-571"><a href="#cb27-571"></a></span>
<span id="cb27-572"><a href="#cb27-572"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p1, p2, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb27-573"><a href="#cb27-573"></a><span class="in">```</span></span>
<span id="cb27-574"><a href="#cb27-574"></a></span>
<span id="cb27-575"><a href="#cb27-575"></a><span class="fu"># Diagnostics and Validation {.unnumbered}</span></span>
<span id="cb27-576"><a href="#cb27-576"></a></span>
<span id="cb27-577"><a href="#cb27-577"></a><span class="fu">## 1. Pre-Treatment Fit</span></span>
<span id="cb27-578"><a href="#cb27-578"></a></span>
<span id="cb27-579"><a href="#cb27-579"></a>**The most critical diagnostic**: How well does the synthetic control match the treated unit before treatment?</span>
<span id="cb27-580"><a href="#cb27-580"></a></span>
<span id="cb27-583"><a href="#cb27-583"></a><span class="in">```{r}</span></span>
<span id="cb27-584"><a href="#cb27-584"></a><span class="co">#| label: pretreatment-fit</span></span>
<span id="cb27-585"><a href="#cb27-585"></a></span>
<span id="cb27-586"><a href="#cb27-586"></a><span class="co"># Pre-treatment fit statistics</span></span>
<span id="cb27-587"><a href="#cb27-587"></a>pre_fit <span class="ot">&lt;-</span> results <span class="sc">%&gt;%</span></span>
<span id="cb27-588"><a href="#cb27-588"></a>  <span class="fu">filter</span>(time <span class="sc">&lt;</span> treatment_time) <span class="sc">%&gt;%</span></span>
<span id="cb27-589"><a href="#cb27-589"></a>  <span class="fu">summarize</span>(</span>
<span id="cb27-590"><a href="#cb27-590"></a>    <span class="at">RMSPE =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(gap<span class="sc">^</span><span class="dv">2</span>)),</span>
<span id="cb27-591"><a href="#cb27-591"></a>    <span class="at">MAE =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(gap)),</span>
<span id="cb27-592"><a href="#cb27-592"></a>    <span class="at">Max_Gap =</span> <span class="fu">max</span>(<span class="fu">abs</span>(gap)),</span>
<span id="cb27-593"><a href="#cb27-593"></a>    <span class="at">Mean_Gap =</span> <span class="fu">mean</span>(gap)</span>
<span id="cb27-594"><a href="#cb27-594"></a>  )</span>
<span id="cb27-595"><a href="#cb27-595"></a></span>
<span id="cb27-596"><a href="#cb27-596"></a><span class="fu">cat</span>(<span class="st">"Pre-Treatment Fit Diagnostics:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-597"><a href="#cb27-597"></a><span class="fu">cat</span>(<span class="st">"  RMSPE:"</span>, <span class="fu">round</span>(pre_fit<span class="sc">$</span>RMSPE, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-598"><a href="#cb27-598"></a><span class="fu">cat</span>(<span class="st">"  MAE:"</span>, <span class="fu">round</span>(pre_fit<span class="sc">$</span>MAE, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-599"><a href="#cb27-599"></a><span class="fu">cat</span>(<span class="st">"  Max Gap:"</span>, <span class="fu">round</span>(pre_fit<span class="sc">$</span>Max_Gap, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-600"><a href="#cb27-600"></a><span class="fu">cat</span>(<span class="st">"  Mean Gap:"</span>, <span class="fu">round</span>(pre_fit<span class="sc">$</span>Mean_Gap, <span class="dv">4</span>), <span class="st">"(should be ~0)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-601"><a href="#cb27-601"></a><span class="in">```</span></span>
<span id="cb27-602"><a href="#cb27-602"></a></span>
<span id="cb27-603"><a href="#cb27-603"></a>::: {.callout-warning}</span>
<span id="cb27-604"><a href="#cb27-604"></a><span class="fu">## Poor Pre-Treatment Fit</span></span>
<span id="cb27-605"><a href="#cb27-605"></a>If pre-treatment RMSPE is large (relative to the outcome's scale), the synthetic control is unreliable. Consider:</span>
<span id="cb27-606"><a href="#cb27-606"></a></span>
<span id="cb27-607"><a href="#cb27-607"></a><span class="ss">1. </span>Adding more pre-treatment periods as predictors</span>
<span id="cb27-608"><a href="#cb27-608"></a><span class="ss">2. </span>Using augmented SCM (<span class="in">`progfunc = "Ridge"`</span>)</span>
<span id="cb27-609"><a href="#cb27-609"></a><span class="ss">3. </span>Acknowledging the limitation in your analysis</span>
<span id="cb27-610"><a href="#cb27-610"></a>:::</span>
<span id="cb27-611"><a href="#cb27-611"></a></span>
<span id="cb27-612"><a href="#cb27-612"></a><span class="fu">## 2. Weight Diagnostics</span></span>
<span id="cb27-613"><a href="#cb27-613"></a></span>
<span id="cb27-614"><a href="#cb27-614"></a>Check if weights are **sparse** and **sensible**.</span>
<span id="cb27-615"><a href="#cb27-615"></a></span>
<span id="cb27-618"><a href="#cb27-618"></a><span class="in">```{r}</span></span>
<span id="cb27-619"><a href="#cb27-619"></a><span class="co">#| label: weight-check</span></span>
<span id="cb27-620"><a href="#cb27-620"></a></span>
<span id="cb27-621"><a href="#cb27-621"></a><span class="co"># Weight distribution</span></span>
<span id="cb27-622"><a href="#cb27-622"></a>weight_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb27-623"><a href="#cb27-623"></a>  <span class="at">unit =</span> <span class="dv">2</span><span class="sc">:</span>n_units,</span>
<span id="cb27-624"><a href="#cb27-624"></a>  <span class="at">weight =</span> weights</span>
<span id="cb27-625"><a href="#cb27-625"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb27-626"><a href="#cb27-626"></a>  <span class="fu">filter</span>(weight <span class="sc">&gt;</span> <span class="fl">0.001</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-627"><a href="#cb27-627"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(weight))</span>
<span id="cb27-628"><a href="#cb27-628"></a></span>
<span id="cb27-629"><a href="#cb27-629"></a><span class="fu">cat</span>(<span class="st">"Donor Weights (non-zero):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-630"><a href="#cb27-630"></a><span class="fu">print</span>(weight_df)</span>
<span id="cb27-631"><a href="#cb27-631"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Number of donors with positive weight:"</span>, <span class="fu">sum</span>(weights <span class="sc">&gt;</span> <span class="fl">0.001</span>), <span class="st">"of"</span>, n_units <span class="sc">-</span> <span class="dv">1</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-632"><a href="#cb27-632"></a><span class="in">```</span></span>
<span id="cb27-633"><a href="#cb27-633"></a></span>
<span id="cb27-634"><a href="#cb27-634"></a>**Good signs**:</span>
<span id="cb27-635"><a href="#cb27-635"></a><span class="ss">- </span>Sparse weights (few donors contribute)</span>
<span id="cb27-636"><a href="#cb27-636"></a><span class="ss">- </span>Top donors make intuitive sense</span>
<span id="cb27-637"><a href="#cb27-637"></a><span class="ss">- </span>No single donor dominates completely</span>
<span id="cb27-638"><a href="#cb27-638"></a></span>
<span id="cb27-639"><a href="#cb27-639"></a>**Bad signs**:</span>
<span id="cb27-640"><a href="#cb27-640"></a><span class="ss">- </span>Many donors with tiny weights (overfitting)</span>
<span id="cb27-641"><a href="#cb27-641"></a><span class="ss">- </span>Counterintuitive donors receive high weight</span>
<span id="cb27-642"><a href="#cb27-642"></a><span class="ss">- </span>One donor receives weight ≈ 1 (just using that unit as control)</span>
<span id="cb27-643"><a href="#cb27-643"></a></span>
<span id="cb27-644"><a href="#cb27-644"></a><span class="fu">## 3. Leave-One-Out Sensitivity</span></span>
<span id="cb27-645"><a href="#cb27-645"></a></span>
<span id="cb27-646"><a href="#cb27-646"></a>Remove each important donor and re-estimate. If results are robust, the effect doesn't depend on any single donor.</span>
<span id="cb27-647"><a href="#cb27-647"></a></span>
<span id="cb27-650"><a href="#cb27-650"></a><span class="in">```{r}</span></span>
<span id="cb27-651"><a href="#cb27-651"></a><span class="co">#| label: leave-one-out</span></span>
<span id="cb27-652"><a href="#cb27-652"></a><span class="co">#| fig-cap: "Leave-one-out sensitivity analysis"</span></span>
<span id="cb27-653"><a href="#cb27-653"></a></span>
<span id="cb27-654"><a href="#cb27-654"></a><span class="co"># Identify top donors</span></span>
<span id="cb27-655"><a href="#cb27-655"></a>top_donors <span class="ot">&lt;-</span> weight_df<span class="sc">$</span>unit[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">3</span>, <span class="fu">nrow</span>(weight_df))]</span>
<span id="cb27-656"><a href="#cb27-656"></a></span>
<span id="cb27-657"><a href="#cb27-657"></a><span class="co"># Leave-one-out analysis</span></span>
<span id="cb27-658"><a href="#cb27-658"></a>loo_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(top_donors, <span class="cf">function</span>(drop_unit) {</span>
<span id="cb27-659"><a href="#cb27-659"></a>  <span class="co"># Re-estimate without this donor</span></span>
<span id="cb27-660"><a href="#cb27-660"></a>  Y_donors_loo <span class="ot">&lt;-</span> pre_data <span class="sc">%&gt;%</span></span>
<span id="cb27-661"><a href="#cb27-661"></a>    <span class="fu">filter</span>(unit <span class="sc">!=</span> <span class="dv">1</span>, unit <span class="sc">!=</span> drop_unit) <span class="sc">%&gt;%</span></span>
<span id="cb27-662"><a href="#cb27-662"></a>    <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> time, <span class="at">names_from =</span> unit, <span class="at">values_from =</span> y) <span class="sc">%&gt;%</span></span>
<span id="cb27-663"><a href="#cb27-663"></a>    <span class="fu">arrange</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb27-664"><a href="#cb27-664"></a>    <span class="fu">select</span>(<span class="sc">-</span>time) <span class="sc">%&gt;%</span></span>
<span id="cb27-665"><a href="#cb27-665"></a>    <span class="fu">as.matrix</span>()</span>
<span id="cb27-666"><a href="#cb27-666"></a></span>
<span id="cb27-667"><a href="#cb27-667"></a>  <span class="co"># New weights</span></span>
<span id="cb27-668"><a href="#cb27-668"></a>  w_loo <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">lm</span>(y_treated_pre <span class="sc">~</span> Y_donors_loo <span class="sc">-</span> <span class="dv">1</span>))</span>
<span id="cb27-669"><a href="#cb27-669"></a>  w_loo[<span class="fu">is.na</span>(w_loo) <span class="sc">|</span> w_loo <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb27-670"><a href="#cb27-670"></a>  w_loo <span class="ot">&lt;-</span> w_loo <span class="sc">/</span> <span class="fu">sum</span>(w_loo)</span>
<span id="cb27-671"><a href="#cb27-671"></a></span>
<span id="cb27-672"><a href="#cb27-672"></a>  <span class="co"># New synthetic for post-treatment</span></span>
<span id="cb27-673"><a href="#cb27-673"></a>  remaining_units <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">2</span><span class="sc">:</span>n_units, drop_unit)</span>
<span id="cb27-674"><a href="#cb27-674"></a>  synth_loo <span class="ot">&lt;-</span> panel <span class="sc">%&gt;%</span></span>
<span id="cb27-675"><a href="#cb27-675"></a>    <span class="fu">filter</span>(unit <span class="sc">%in%</span> remaining_units, time <span class="sc">&gt;=</span> treatment_time) <span class="sc">%&gt;%</span></span>
<span id="cb27-676"><a href="#cb27-676"></a>    <span class="fu">left_join</span>(</span>
<span id="cb27-677"><a href="#cb27-677"></a>      <span class="fu">data.frame</span>(<span class="at">unit =</span> remaining_units, <span class="at">weight =</span> w_loo),</span>
<span id="cb27-678"><a href="#cb27-678"></a>      <span class="at">by =</span> <span class="st">"unit"</span></span>
<span id="cb27-679"><a href="#cb27-679"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb27-680"><a href="#cb27-680"></a>    <span class="fu">group_by</span>(time) <span class="sc">%&gt;%</span></span>
<span id="cb27-681"><a href="#cb27-681"></a>    <span class="fu">summarize</span>(<span class="at">y_synth =</span> <span class="fu">sum</span>(y <span class="sc">*</span> weight, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb27-682"><a href="#cb27-682"></a></span>
<span id="cb27-683"><a href="#cb27-683"></a>  avg_gap <span class="ot">&lt;-</span> <span class="fu">mean</span>(treated_outcomes<span class="sc">$</span>y_treated[treated_outcomes<span class="sc">$</span>time <span class="sc">&gt;=</span> treatment_time] <span class="sc">-</span></span>
<span id="cb27-684"><a href="#cb27-684"></a>                  synth_loo<span class="sc">$</span>y_synth)</span>
<span id="cb27-685"><a href="#cb27-685"></a></span>
<span id="cb27-686"><a href="#cb27-686"></a>  <span class="fu">data.frame</span>(<span class="at">dropped =</span> <span class="fu">paste</span>(<span class="st">"Drop Unit"</span>, drop_unit), <span class="at">effect =</span> avg_gap)</span>
<span id="cb27-687"><a href="#cb27-687"></a>}) <span class="sc">%&gt;%</span> <span class="fu">bind_rows</span>()</span>
<span id="cb27-688"><a href="#cb27-688"></a></span>
<span id="cb27-689"><a href="#cb27-689"></a><span class="co"># Add baseline</span></span>
<span id="cb27-690"><a href="#cb27-690"></a>baseline <span class="ot">&lt;-</span> <span class="fu">mean</span>(results<span class="sc">$</span>gap[results<span class="sc">$</span>time <span class="sc">&gt;=</span> treatment_time])</span>
<span id="cb27-691"><a href="#cb27-691"></a>loo_results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb27-692"><a href="#cb27-692"></a>  <span class="fu">data.frame</span>(<span class="at">dropped =</span> <span class="st">"Baseline (none dropped)"</span>, <span class="at">effect =</span> baseline),</span>
<span id="cb27-693"><a href="#cb27-693"></a>  loo_results</span>
<span id="cb27-694"><a href="#cb27-694"></a>)</span>
<span id="cb27-695"><a href="#cb27-695"></a></span>
<span id="cb27-696"><a href="#cb27-696"></a><span class="fu">ggplot</span>(loo_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(dropped, effect), <span class="at">y =</span> effect)) <span class="sc">+</span></span>
<span id="cb27-697"><a href="#cb27-697"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"#3498db"</span>) <span class="sc">+</span></span>
<span id="cb27-698"><a href="#cb27-698"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> baseline, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"#e74c3c"</span>) <span class="sc">+</span></span>
<span id="cb27-699"><a href="#cb27-699"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb27-700"><a href="#cb27-700"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Leave-One-Out Sensitivity"</span>,</span>
<span id="cb27-701"><a href="#cb27-701"></a>       <span class="at">subtitle =</span> <span class="st">"Effect estimate when each top donor is removed"</span>,</span>
<span id="cb27-702"><a href="#cb27-702"></a>       <span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Estimated Treatment Effect"</span>)</span>
<span id="cb27-703"><a href="#cb27-703"></a><span class="in">```</span></span>
<span id="cb27-704"><a href="#cb27-704"></a></span>
<span id="cb27-705"><a href="#cb27-705"></a><span class="fu"># SCM vs. DiD: Decision Framework {.unnumbered}</span></span>
<span id="cb27-706"><a href="#cb27-706"></a></span>
<span id="cb27-707"><a href="#cb27-707"></a><span class="fu">## When to Use Which?</span></span>
<span id="cb27-708"><a href="#cb27-708"></a></span>
<span id="cb27-709"><a href="#cb27-709"></a><span class="in">```</span></span>
<span id="cb27-710"><a href="#cb27-710"></a><span class="in">How many treated units?</span></span>
<span id="cb27-711"><a href="#cb27-711"></a><span class="in">├── One treated unit</span></span>
<span id="cb27-712"><a href="#cb27-712"></a><span class="in">│   └── Use Synthetic Control</span></span>
<span id="cb27-713"><a href="#cb27-713"></a><span class="in">│       └── Enough donors with good pre-treatment fit?</span></span>
<span id="cb27-714"><a href="#cb27-714"></a><span class="in">│           ├── Yes → Classic SCM or Augmented SCM</span></span>
<span id="cb27-715"><a href="#cb27-715"></a><span class="in">│           └── No → Consider qualitative analysis</span></span>
<span id="cb27-716"><a href="#cb27-716"></a><span class="in">└── Multiple treated units</span></span>
<span id="cb27-717"><a href="#cb27-717"></a><span class="in">    ├── Same treatment timing?</span></span>
<span id="cb27-718"><a href="#cb27-718"></a><span class="in">    │   ├── Yes → DiD or Synthetic DiD</span></span>
<span id="cb27-719"><a href="#cb27-719"></a><span class="in">    │   └── No (staggered) → Staggered DiD methods (Module 5) or Synthetic DiD</span></span>
<span id="cb27-720"><a href="#cb27-720"></a><span class="in">    └── Trust parallel trends?</span></span>
<span id="cb27-721"><a href="#cb27-721"></a><span class="in">        ├── Yes → Standard DiD</span></span>
<span id="cb27-722"><a href="#cb27-722"></a><span class="in">        └── No → Synthetic DiD (reweights to match)</span></span>
<span id="cb27-723"><a href="#cb27-723"></a><span class="in">```</span></span>
<span id="cb27-724"><a href="#cb27-724"></a></span>
<span id="cb27-725"><a href="#cb27-725"></a><span class="fu">## Comparison Table</span></span>
<span id="cb27-726"><a href="#cb27-726"></a></span>
<span id="cb27-727"><a href="#cb27-727"></a><span class="pp">|</span> Feature <span class="pp">|</span> DiD <span class="pp">|</span> SCM <span class="pp">|</span> Synthetic DiD <span class="pp">|</span></span>
<span id="cb27-728"><a href="#cb27-728"></a><span class="pp">|---------|-----|-----|---------------|</span></span>
<span id="cb27-729"><a href="#cb27-729"></a><span class="pp">|</span> **# Treated** <span class="pp">|</span> Many <span class="pp">|</span> One <span class="pp">|</span> One or many <span class="pp">|</span></span>
<span id="cb27-730"><a href="#cb27-730"></a><span class="pp">|</span> **Parallel trends** <span class="pp">|</span> Required <span class="pp">|</span> Not required <span class="pp">|</span> Not required <span class="pp">|</span></span>
<span id="cb27-731"><a href="#cb27-731"></a><span class="pp">|</span> **Pre-treatment fit** <span class="pp">|</span> Implicit <span class="pp">|</span> Explicit (visible) <span class="pp">|</span> Explicit <span class="pp">|</span></span>
<span id="cb27-732"><a href="#cb27-732"></a><span class="pp">|</span> **Inference** <span class="pp">|</span> Standard <span class="pp">|</span> Permutation <span class="pp">|</span> Placebo/Bootstrap <span class="pp">|</span></span>
<span id="cb27-733"><a href="#cb27-733"></a><span class="pp">|</span> **Transparency** <span class="pp">|</span> Moderate <span class="pp">|</span> High (weights) <span class="pp">|</span> High <span class="pp">|</span></span>
<span id="cb27-734"><a href="#cb27-734"></a><span class="pp">|</span> **Covariates** <span class="pp">|</span> Easy <span class="pp">|</span> Via predictors <span class="pp">|</span> Via augmentation <span class="pp">|</span></span>
<span id="cb27-735"><a href="#cb27-735"></a></span>
<span id="cb27-736"><a href="#cb27-736"></a><span class="fu"># Common Pitfalls {.unnumbered}</span></span>
<span id="cb27-737"><a href="#cb27-737"></a></span>
<span id="cb27-738"><a href="#cb27-738"></a>::: {.callout-warning}</span>
<span id="cb27-739"><a href="#cb27-739"></a><span class="fu">## 1. Interpolation vs. Extrapolation</span></span>
<span id="cb27-740"><a href="#cb27-740"></a>SCM works by **interpolation**—the synthetic unit must lie within the convex hull of donors. If the treated unit is extreme (outside the range of donors), SCM extrapolates and becomes unreliable.</span>
<span id="cb27-741"><a href="#cb27-741"></a></span>
<span id="cb27-742"><a href="#cb27-742"></a>**Check**: Are the treated unit's pre-treatment characteristics within the range of donors?</span>
<span id="cb27-743"><a href="#cb27-743"></a>:::</span>
<span id="cb27-744"><a href="#cb27-744"></a></span>
<span id="cb27-745"><a href="#cb27-745"></a>::: {.callout-warning}</span>
<span id="cb27-746"><a href="#cb27-746"></a><span class="fu">## 2. Overfitting Pre-Treatment Noise</span></span>
<span id="cb27-747"><a href="#cb27-747"></a>With many pre-treatment periods and few donors, SCM can overfit noise rather than signal.</span>
<span id="cb27-748"><a href="#cb27-748"></a></span>
<span id="cb27-749"><a href="#cb27-749"></a>**Solutions**:</span>
<span id="cb27-750"><a href="#cb27-750"></a><span class="ss">- </span>Use augmented SCM (<span class="in">`progfunc = "Ridge"`</span>)</span>
<span id="cb27-751"><a href="#cb27-751"></a><span class="ss">- </span>Check if weights are sensible</span>
<span id="cb27-752"><a href="#cb27-752"></a><span class="ss">- </span>Validate with leave-one-out</span>
<span id="cb27-753"><a href="#cb27-753"></a>:::</span>
<span id="cb27-754"><a href="#cb27-754"></a></span>
<span id="cb27-755"><a href="#cb27-755"></a>::: {.callout-warning}</span>
<span id="cb27-756"><a href="#cb27-756"></a><span class="fu">## 3. Small Donor Pool</span></span>
<span id="cb27-757"><a href="#cb27-757"></a>With few donors (&lt; 10), permutation inference has limited power. You may not be able to reject the null even with a real effect.</span>
<span id="cb27-758"><a href="#cb27-758"></a></span>
<span id="cb27-759"><a href="#cb27-759"></a>**Solution**: Be transparent about power limitations. Consider combining with qualitative evidence.</span>
<span id="cb27-760"><a href="#cb27-760"></a>:::</span>
<span id="cb27-761"><a href="#cb27-761"></a></span>
<span id="cb27-762"><a href="#cb27-762"></a>::: {.callout-warning}</span>
<span id="cb27-763"><a href="#cb27-763"></a><span class="fu">## 4. Spillovers / SUTVA Violation</span></span>
<span id="cb27-764"><a href="#cb27-764"></a>If treatment affects donor units (e.g., trade diversion, policy spillovers), the synthetic control is contaminated.</span>
<span id="cb27-765"><a href="#cb27-765"></a></span>
<span id="cb27-766"><a href="#cb27-766"></a>**Solution**: Exclude donors likely affected by spillovers. Test sensitivity to donor pool composition.</span>
<span id="cb27-767"><a href="#cb27-767"></a>:::</span>
<span id="cb27-768"><a href="#cb27-768"></a></span>
<span id="cb27-769"><a href="#cb27-769"></a>::: {.callout-warning}</span>
<span id="cb27-770"><a href="#cb27-770"></a><span class="fu">## 5. Anticipation Effects</span></span>
<span id="cb27-771"><a href="#cb27-771"></a>If units anticipate treatment and adjust behavior before the official treatment date, pre-treatment fit is compromised.</span>
<span id="cb27-772"><a href="#cb27-772"></a></span>
<span id="cb27-773"><a href="#cb27-773"></a>**Solution**: Use an earlier treatment date cutoff, or exclude periods with possible anticipation.</span>
<span id="cb27-774"><a href="#cb27-774"></a>:::</span>
<span id="cb27-775"><a href="#cb27-775"></a></span>
<span id="cb27-776"><a href="#cb27-776"></a><span class="fu"># Summary {.unnumbered}</span></span>
<span id="cb27-777"><a href="#cb27-777"></a></span>
<span id="cb27-778"><a href="#cb27-778"></a>Key takeaways:</span>
<span id="cb27-779"><a href="#cb27-779"></a></span>
<span id="cb27-780"><a href="#cb27-780"></a><span class="ss">1. </span>**SCM constructs counterfactuals** by weighting untreated units to match the treated unit's pre-treatment trajectory</span>
<span id="cb27-781"><a href="#cb27-781"></a></span>
<span id="cb27-782"><a href="#cb27-782"></a><span class="ss">2. </span>**The optimization** minimizes pre-treatment prediction error subject to convex weights</span>
<span id="cb27-783"><a href="#cb27-783"></a></span>
<span id="cb27-784"><a href="#cb27-784"></a><span class="ss">3. </span>**Inference via permutation**: Apply SCM to each donor as placebo; compare treated unit's gap to placebo distribution</span>
<span id="cb27-785"><a href="#cb27-785"></a></span>
<span id="cb27-786"><a href="#cb27-786"></a><span class="ss">4. </span>**RMSPE ratio** normalizes by pre-treatment fit quality</span>
<span id="cb27-787"><a href="#cb27-787"></a></span>
<span id="cb27-788"><a href="#cb27-788"></a><span class="ss">5. </span>**Synthetic DiD** extends SCM to multiple treated units without requiring parallel trends</span>
<span id="cb27-789"><a href="#cb27-789"></a></span>
<span id="cb27-790"><a href="#cb27-790"></a><span class="ss">6. </span>**Key diagnostics**:</span>
<span id="cb27-791"><a href="#cb27-791"></a><span class="ss">   - </span>Pre-treatment fit (RMSPE)</span>
<span id="cb27-792"><a href="#cb27-792"></a><span class="ss">   - </span>Weight sparsity and sensibility</span>
<span id="cb27-793"><a href="#cb27-793"></a><span class="ss">   - </span>Leave-one-out sensitivity</span>
<span id="cb27-794"><a href="#cb27-794"></a></span>
<span id="cb27-795"><a href="#cb27-795"></a><span class="ss">7. </span>**Use SCM when**: one (or few) treated units, no natural control group, parallel trends questionable</span>
<span id="cb27-796"><a href="#cb27-796"></a></span>
<span id="cb27-797"><a href="#cb27-797"></a><span class="ss">8. </span>**Software**: <span class="in">`augsynth`</span> for augmented SCM, <span class="in">`synthdid`</span> for Synthetic DiD</span>
<span id="cb27-798"><a href="#cb27-798"></a></span>
<span id="cb27-799"><a href="#cb27-799"></a>---</span>
<span id="cb27-800"><a href="#cb27-800"></a></span>
<span id="cb27-801"><a href="#cb27-801"></a><span class="fu">## Key References</span></span>
<span id="cb27-802"><a href="#cb27-802"></a></span>
<span id="cb27-803"><a href="#cb27-803"></a>**Foundational**:</span>
<span id="cb27-804"><a href="#cb27-804"></a></span>
<span id="cb27-805"><a href="#cb27-805"></a><span class="ss">- </span>Abadie &amp; Gardeazabal (2003). "The Economic Costs of Conflict." *AER*</span>
<span id="cb27-806"><a href="#cb27-806"></a><span class="ss">- </span>Abadie, Diamond &amp; Hainmueller (2010). "Synthetic Control Methods for Comparative Case Studies." *JASA*</span>
<span id="cb27-807"><a href="#cb27-807"></a><span class="ss">- </span>Abadie, Diamond &amp; Hainmueller (2015). "Comparative Politics and the Synthetic Control Method." *AJPS*</span>
<span id="cb27-808"><a href="#cb27-808"></a><span class="ss">- </span>Abadie (2021). "Using Synthetic Controls: Feasibility, Data Requirements, and Methodological Aspects." *JEL*</span>
<span id="cb27-809"><a href="#cb27-809"></a></span>
<span id="cb27-810"><a href="#cb27-810"></a>**Extensions**:</span>
<span id="cb27-811"><a href="#cb27-811"></a></span>
<span id="cb27-812"><a href="#cb27-812"></a><span class="ss">- </span>Arkhangelsky et al. (2021). "Synthetic Difference-in-Differences." *AER*</span>
<span id="cb27-813"><a href="#cb27-813"></a><span class="ss">- </span>Ben-Michael, Feller &amp; Rothstein (2021). "The Augmented Synthetic Control Method." *JASA*</span>
<span id="cb27-814"><a href="#cb27-814"></a><span class="ss">- </span>Doudchenko &amp; Imbens (2016). "Balancing, Regression, Difference-in-Differences and Synthetic Control Methods." *NBER WP*</span>
<span id="cb27-815"><a href="#cb27-815"></a></span>
<span id="cb27-816"><a href="#cb27-816"></a>**Inference**:</span>
<span id="cb27-817"><a href="#cb27-817"></a></span>
<span id="cb27-818"><a href="#cb27-818"></a><span class="ss">- </span>Firpo &amp; Possebom (2018). "Synthetic Control Method: Inference, Sensitivity Analysis and Confidence Sets." *JCASP*</span>
<span id="cb27-819"><a href="#cb27-819"></a></span>
<span id="cb27-820"><a href="#cb27-820"></a>**R Packages**:</span>
<span id="cb27-821"><a href="#cb27-821"></a></span>
<span id="cb27-822"><a href="#cb27-822"></a><span class="ss">- </span><span class="in">`augsynth`</span>: Ben-Michael et al. — Augmented synthetic control</span>
<span id="cb27-823"><a href="#cb27-823"></a><span class="ss">- </span><span class="in">`synthdid`</span>: Arkhangelsky et al. — Synthetic DiD</span>
<span id="cb27-824"><a href="#cb27-824"></a><span class="ss">- </span><span class="in">`Synth`</span>: Abadie et al. — Original SCM implementation</span>
<span id="cb27-825"><a href="#cb27-825"></a></span>
<span id="cb27-826"><a href="#cb27-826"></a>---</span>
<span id="cb27-827"><a href="#cb27-827"></a></span>
<span id="cb27-828"><a href="#cb27-828"></a>*Next: [Module 7: Bayesian Foundations](07_bayesian_foundations.qmd)*</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Mastering Empirical Macroeconometrics by Bijoy Ratan Ghosh</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum/edit/main/chapters/06_synthetic_control.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/bijoyratanghosh/empirical-macro-curriculum/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>Built with <a href="https://quarto.org/">Quarto</a></p>
</div>
  </div>
</footer>




</body></html>